<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS + Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            tnm: {
              primary: '#0ea5e9', // sky-500
              amber: '#f59e0b',
              green: '#10b981',
              red: '#ef4444'
            }
          },
          boxShadow: { soft:'0 6px 24px rgba(0,0,0,.08)' }
        }
      }
    }
  </script>
  <style>
    .pop-enter{opacity:0;transform:translateY(8px)}
    .pop-enter-active{opacity:1;transform:translateY(0);transition:all .2s ease}
    .badge{font-size:.72rem}
    .scroll-snap-x{scroll-snap-type:x mandatory}
    .snap-start{scroll-snap-align:start}
    .hide-scroll::-webkit-scrollbar{display:none}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- ===== Header ===== -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-3 py-2 flex items-center gap-3">
      <div class="text-2xl">üßã</div>
      <div class="flex-1">
        <h1 class="text-base font-semibold">Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</h1>
        <p class="text-xs text-gray-500">CSV + Realtime (Firebase ho·∫∑c Local)</p>
      </div>
      <div class="flex items-center gap-2">
        <select id="roleSelect" class="text-sm border rounded px-2 py-1">
          <option value="staff">Nh√¢n vi√™n</option>
          <option value="barista">Pha ch·∫ø</option>
          <option value="cashier">Thu ng√¢n</option>
          <option value="admin">Admin</option>
        </select>
        <button id="resetBtn" class="text-sm px-3 py-1 border rounded hover:bg-gray-100">Reset</button>
      </div>
    </div>
  </header>

  <!-- ===== Notifications ===== -->
  <div id="toastHost" class="fixed left-2 top-16 space-y-2 z-50"></div>
  <audio id="ping" preload="auto" class="hidden">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQA‚Ä¶(base64 beep trimmed)‚Ä¶" type="audio/mp3">
  </audio>

  <!-- ===== Main ===== -->
  <main class="max-w-6xl mx-auto p-3">
    <!-- STAFF -->
    <section id="view-staff" class="space-y-3">
      <div class="bg-white border rounded-xl p-3 shadow-soft">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label class="text-xs text-gray-500">Ch·ªçn b√†n</label>
            <select id="tableSelect" class="w-full border rounded px-2 py-2">
              <option value="takeaway">Mang v·ªÅ</option>
            </select>
          </div>
          <div>
            <label class="text-xs text-gray-500">Ph√¢n lo·∫°i</label>
            <select id="categorySelect" class="w-full border rounded px-2 py-2">
              <option value="__all__">T·∫•t c·∫£</option>
            </select>
          </div>
        </div>
        <div class="mt-2 flex gap-2">
          <button data-qf="C√† ph√™" class="qf-btn text-xs px-2 py-1 border rounded">C√† ph√™</button>
          <button data-qf="Matcha" class="qf-btn text-xs px-2 py-1 border rounded">Matcha</button>
          <button data-qf="Tr√† s·ªØa & Tr√†" class="qf-btn text-xs px-2 py-1 border rounded">Tr√† s·ªØa & Tr√†</button>
          <button data-qf="ƒê·ªì ƒÉn v·∫∑t" class="qf-btn text-xs px-2 py-1 border rounded">ƒê·ªì ƒÉn v·∫∑t</button>
        </div>
      </div>

      <!-- Menu Grid -->
      <div id="menuGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>

      <!-- Cart -->
      <div class="bg-white border rounded-xl p-3">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Gi·ªè h√†ng</h3>
          <button id="clearCartBtn" class="text-xs text-gray-500 hover:text-red-600">X√≥a gi·ªè</button>
        </div>
        <div id="cartList" class="divide-y my-2"></div>
        <div class="flex items-center justify-between">
          <div class="text-sm">T·ªïng: <span id="cartTotal" class="font-semibold">0</span> ƒë</div>
          <button id="sendOrderBtn" class="px-3 py-2 bg-tnm-primary text-white rounded-lg disabled:opacity-50">G·ª≠i order ƒë·∫øn qu·∫ßy pha ch·∫ø</button>
        </div>
      </div>

      <!-- My Orders -->
      <div class="bg-white border rounded-xl p-3">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">C√°c ƒë∆°n c·ªßa t√¥i</h3>
          <span class="text-xs text-gray-500">Ch∆∞a thanh to√°n</span>
        </div>
        <div id="myOrders" class="space-y-2 mt-2"></div>
      </div>
    </section>

    <!-- BARISTA -->
    <section id="view-barista" class="hidden space-y-3">
      <div class="bg-white border rounded-xl p-3">
        <div class="flex gap-2">
          <button data-btab="table" class="btab px-3 py-2 bg-gray-100 rounded border">Theo b√†n</button>
          <button data-btab="item" class="btab px-3 py-2 rounded border">Theo m√≥n</button>
        </div>
      </div>

      <div id="barista-table" class="space-y-3"></div>
      <div id="barista-item" class="hidden space-y-3"></div>
    </section>

    <!-- CASHIER -->
    <section id="view-cashier" class="hidden space-y-3">
      <div class="grid md:grid-cols-3 gap-3">
        <div class="bg-white border rounded-xl p-3">
          <h3 class="font-semibold mb-2">H√†ng ƒë·ª£i pha ch·∫ø</h3>
          <div id="cashier-queue" class="space-y-2"></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Ch·ªù thanh to√°n</h3>
          <div id="cashier-waitpay" class="space-y-2"></div>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">ƒê√£ thanh to√°n h√¥m nay</h3>
            <button id="dlRevenueBtn" class="text-xs border px-2 py-1 rounded">T·∫£i CSV</button>
          </div>
          <div class="text-sm mt-1">Doanh thu h√¥m nay: <span id="todayAmount" class="font-semibold">0</span> ƒë</div>
          <div class="overflow-auto mt-2 hide-scroll" style="max-height:320px">
            <table class="w-full text-xs">
              <thead class="sticky top-0 bg-gray-100">
                <tr>
                  <th class="text-left p-1">Th·ªùi gian</th>
                  <th class="text-left p-1">Lo·∫°i</th>
                  <th class="text-left p-1">M√£ ƒë∆°n</th>
                  <th class="text-right p-1">S·ªë m√≥n</th>
                  <th class="text-right p-1">T·ªïng</th>
                  <th class="text-left p-1">Ghi ch√∫</th>
                </tr>
              </thead>
              <tbody id="revenueTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pay modal trigger area -->
      <div id="cashier-modals"></div>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="hidden space-y-3">
      <div class="grid md:grid-cols-2 gap-3">
        <div class="bg-white border rounded-xl p-3">
          <h3 class="font-semibold mb-2">Dashboard KPI</h3>
          <ul class="text-sm space-y-1">
            <li>ƒê∆°n t·ªïng (h√¥m nay): <span id="kpiOrdersToday" class="font-semibold">0</span></li>
            <li>Dung l∆∞·ª£ng local ∆∞·ªõc t√≠nh: <span id="kpiLocalSize" class="font-semibold">0 KB</span></li>
            <li>Thi·∫øt b·ªã online (Broadcast): <span id="kpiPeers" class="font-semibold">1</span></li>
            <li>BƒÉng th√¥ng ∆∞·ªõc t√≠nh: <span id="kpiBandwidth" class="font-semibold">‚Äî</span></li>
          </ul>
        </div>
        <div class="bg-white border rounded-xl p-3">
          <h3 class="font-semibold mb-2">C·∫•u h√¨nh</h3>
          <div class="flex gap-2 items-end">
            <div class="flex-1">
              <label class="text-xs text-gray-500">S·ªë l∆∞·ª£ng b√†n</label>
              <input id="cfgTables" type="number" min="1" value="12" class="w-full border rounded px-2 py-2" />
            </div>
            <button id="saveCfg" class="px-3 py-2 bg-tnm-primary text-white rounded-lg">L∆∞u</button>
          </div>
          <p class="text-xs text-gray-500 mt-2">Kh√¥ng c√≤n Menu JSON. Menu l·∫•y t·ª´ <code>assets/menu.csv</code>.</p>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Modal (Cashier Pay) ===== -->
  <div id="modalHost"></div>

  <script>
  /********************
   * Utilities
   ********************/
  const fmtVND = n => (n||0).toLocaleString('vi-VN');
  const todayKey = () => new Date().toLocaleDateString('sv-SE', { timeZone: 'Asia/Ho_Chi_Minh' }); // YYYY-MM-DD
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
  const sleep = ms => new Promise(r=>setTimeout(r, ms));
  const qs = (k) => new URLSearchParams(location.search).get(k) || (location.hash.startsWith('#role=')?location.hash.replace('#role=',''):null);

  // Simple state
  const STATE = {
    role: 'staff',
    cfg: { tables: 12 },
    menuRows: [],            // [{category,item,size,price}]
    menuIndex: {},           // itemName -> {category, sizes:[{size, price, id}]}
    toppings: [],            // from Category='Topping'
    cart: [],                // local cart [{menuItemId,name,size,basePrice,qty,toppings[],note,itemStatus}]
    myOrders: [],            // current user's (queued/delivered not paid)
    peers: 1,
  };

  // Storage keys
  const LS = {
    cfg: 'tiemnuoctuiminh_pos_v1_html',
    menuCache: 'tnm_menu_csv_cache',
    revenue: (yyyyMMdd) => `tnm_revenue_${yyyyMMdd.replaceAll('-','')}`,
  };

  // BroadcastChannel
  const BC = new BroadcastChannel('tnm_pos');
  BC.onmessage = (e)=>{
    if(e?.data?.type==='peer-ping'){ STATE.peers = e.data.peers; renderAdminKPI(); }
    if(e?.data?.type==='orders-updated'){ refreshAll(); }
    if(e?.data?.type==='revenue-updated'){ loadRevenueUI(); }
  };
  setInterval(()=>BC.postMessage({type:'peer-ping', peers: STATE.peers+1}), 4000);

  // Toasts
  const toastHost = document.getElementById('toastHost');
  let toastQueue = [];
  let toastActive = false;
  function showToast(msg){
    toastQueue.push(msg);
    if(!toastActive) nextToast();
  }
  async function nextToast(){
    if(!toastQueue.length){ toastActive=false; return; }
    toastActive = true;
    const msg = toastQueue.shift();
    const el = document.createElement('div');
    el.className = 'pop-enter bg-white border shadow-soft rounded-lg px-3 py-2 text-sm max-w-xs';
    el.innerHTML = `<div class="flex items-start gap-2">
      <span>üîî</span><div class="flex-1">${msg}</div>
      <button class="text-gray-400 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">√ó</button>
    </div>`;
    toastHost.appendChild(el);
    requestAnimationFrame(()=>el.classList.add('pop-enter-active'));
    setTimeout(()=>{ el.remove(); nextToast(); }, 3000);
  }

  // Beep
  function ping(){ try{ document.getElementById('ping').currentTime=0; document.getElementById('ping').play(); }catch(e){} }

  /********************
   * Adapters (DB)
   ********************/
  const hasFirebase = !!window.FIREBASE_CONFIG;
  let DB = null;

  // Local adapter
  const LocalDB = {
    _ordersKey: 'tnm_orders_today', // store only today in demo; extend as needed
    _loadOrders(){
      const k = `${this._ordersKey}_${todayKey()}`;
      return JSON.parse(localStorage.getItem(k) || '[]');
    },
    _saveOrders(arr){
      const k = `${this._ordersKey}_${todayKey()}`;
      localStorage.setItem(k, JSON.stringify(arr));
      BC.postMessage({type:'orders-updated'});
    },
    async listOrders(){ return this._loadOrders(); },
    async pushOrder(order){
      const arr = this._loadOrders();
      arr.push(order);
      this._saveOrders(arr);
      // notify barista
      showToast(`C√≥ ƒë∆°n m·ªõi: ${order.type==='takeaway'?'Mang v·ªÅ':'B√†n '+order.table} ‚Ä¢ ${order.items.length} m√≥n`);
      ping();
      return order.id;
    },
    async updateItemStatus(orderId, itemIdx, status){
      const arr = this._loadOrders();
      const i = arr.findIndex(o=>o.id===orderId);
      if(i<0) return;
      arr[i].items[itemIdx].itemStatus = status;
      // if all delivered -> order.delivered
      if(arr[i].items.every(it=>it.itemStatus==='delivered')) arr[i].status='delivered';
      this._saveOrders(arr);
    },
    async updateOrderStatus(orderId, status){
      const arr = this._loadOrders();
      const i = arr.findIndex(o=>o.id===orderId);
      if(i<0) return;
      arr[i].status = status;
      this._saveOrders(arr);
    },
    async markPaid(group){ // group by table or takeaway
      const arr = this._loadOrders();
      let changed = false;
      for(const o of arr){
        if(o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table))){
          o.status='paid';
          changed = true;
          // record revenue
          Revenue.record(o);
        }
      }
      if(changed){ this._saveOrders(arr); BC.postMessage({type:'revenue-updated'}); }
      return changed;
    }
  };

  // Revenue local
  const Revenue = {
    record(order){
      const key = LS.revenue(todayKey());
      const pack = JSON.parse(localStorage.getItem(key) || '{"entries":{},"summary":{"totalOrders":0,"totalAmount":0}}');
      const amount = order.items.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0)) * it.qty, 0);
      const entry = {
        orderId: order.id,
        tableOrTakeAway: order.type==='takeaway' ? 'Mang v·ªÅ' : `B√†n ${order.table}`,
        items: order.items.map(i=>({name:i.name,size:i.size,qty:i.qty})),
        amount,
        paidAt: new Date().toLocaleString('sv-SE', { timeZone:'Asia/Ho_Chi_Minh' })
      };
      pack.entries[order.id] = entry;
      const uniqPaid = Object.keys(pack.entries).length;
      const sum = Object.values(pack.entries).reduce((s,e)=>s+(e.amount||0),0);
      pack.summary = { totalOrders: uniqPaid, totalAmount: sum };
      localStorage.setItem(key, JSON.stringify(pack));
    },
    load(){
      const key = LS.revenue(todayKey());
      return JSON.parse(localStorage.getItem(key) || '{"entries":{},"summary":{"totalOrders":0,"totalAmount":0}}');
    }
  };

  // Placeholder Firebase adapter (wired to Local for this demo; structure ready)
  const FirebaseDB = {
    // Implement with firebase-app + firebase-database scripts if needed.
    // For this single-file demo (no external libs), we simulate by delegating to LocalDB.
    async listOrders(){ return LocalDB.listOrders(); },
    async pushOrder(order){ return LocalDB.pushOrder(order); },
    async updateItemStatus(orderId, idx, status){ return LocalDB.updateItemStatus(orderId, idx, status); },
    async updateOrderStatus(orderId, status){ return LocalDB.updateOrderStatus(orderId, status); },
    async markPaid(group){ return LocalDB.markPaid(group); }
  };

  DB = hasFirebase ? FirebaseDB : LocalDB;

  /********************
   * Load & cache CSV
   ********************/
  async function loadMenuFromCSV(){
    // Cache
    const cache = JSON.parse(localStorage.getItem(LS.menuCache) || 'null');
    if(cache && cache.etag){ STATE.menuRows = cache.rows; indexMenu(); return; }
    // Fetch
    const res = await fetch('assets/menu.csv?ts='+Date.now());
    const text = await res.text();
    const rows = [];
    text.split(/\r?\n/).forEach((line,idx)=>{
      if(!line.trim()) return;
      // naive CSV split on comma, safe enough for our columns (no quoted commas typical)
      const parts = line.split(',').map(s=>s.trim());
      if(idx===0){
        // expect header Category,Item,Size,Price
        return;
      }
      const [category,item,size,price] = parts;
      if(!category || !item || !size) return;
      const p = Number(price||0);
      rows.push({category,item,size,price: isNaN(p)?0:p});
    });
    STATE.menuRows = rows;
    localStorage.setItem(LS.menuCache, JSON.stringify({etag: Date.now(), rows}));
    indexMenu();
  }

  function indexMenu(){
    const idx = {};
    const tops = [];
    for(const r of STATE.menuRows){
      if(r.category==='Topping'){ tops.push({ id: uid(), name: r.item, price: r.price }); continue; }
      if(!idx[r.item]) idx[r.item] = { category: r.category, sizes: [] };
      idx[r.item].sizes.push({ size: r.size, price: r.price, id: uid() });
    }
    STATE.menuIndex = idx;
    STATE.toppings = tops;
  }

  /********************
   * Config & Init UI
   ********************/
  function loadConfig(){
    const saved = JSON.parse(localStorage.getItem(LS.cfg) || '{}');
    if(saved.tables) STATE.cfg.tables = saved.tables;
    document.getElementById('cfgTables').value = STATE.cfg.tables;
    // populate tables
    const tableSel = document.getElementById('tableSelect');
    tableSel.innerHTML = `<option value="takeaway">Mang v·ªÅ</option>` + 
      Array.from({length: STATE.cfg.tables}, (_,i)=>`<option value="${i+1}">B√†n ${i+1}</option>`).join('');
  }

  function saveConfig(){
    localStorage.setItem(LS.cfg, JSON.stringify({ tables: Number(document.getElementById('cfgTables').value)||12 }));
    loadConfig();
    showToast('ƒê√£ l∆∞u c·∫•u h√¨nh.');
  }

  function applyRoleFromURL(){
    const r = qs('role');
    const role = r || sessionStorage.getItem('tnm_role') || 'staff';
    setRole(role);
  }

  function setRole(role){
    STATE.role = role;
    sessionStorage.setItem('tnm_role', role);
    document.getElementById('roleSelect').value = role;
    // toggle views
    for(const id of ['staff','barista','cashier','admin']){
      document.getElementById('view-'+id).classList.toggle('hidden', id!==role);
    }
    refreshAll();
  }

  /********************
   * Renderers
   ********************/
  function renderCategories(){
    const cats = new Set(['__all__']);
    for(const r of STATE.menuRows){ if(r.category && r.category!=='Topping') cats.add(r.category); }
    const sel = document.getElementById('categorySelect');
    sel.innerHTML = Array.from(cats).map(c=>`<option value="${c}">${c==='__all__'?'T·∫•t c·∫£':c}</option>`).join('');
  }

  function renderMenu(){
    const grid = document.getElementById('menuGrid');
    const cat = document.getElementById('categorySelect').value;
    const items = Object.entries(STATE.menuIndex)
      .filter(([name,info])=> cat==='__all__' || info.category===cat)
      .map(([name,info])=>({name, ...info}));

    grid.innerHTML = items.map(it=>{
      const sizeOpts = it.sizes.map(s=>`<option value="${s.size}|${s.price}">${s.size} ‚Äî ${fmtVND(s.price)}ƒë</option>`).join('');
      const topOpts = STATE.toppings.map((t,i)=>`
        <label class="flex items-center gap-2 text-xs">
          <input type="checkbox" data-top="${t.name}|${t.price}" class="topping-cb">
          <span>${t.name} <span class="text-gray-500">+${fmtVND(t.price)}</span></span>
        </label>`).join('');
      const cardId = 'card_'+uid();
      return `<div class="bg-white border rounded-xl p-3 flex flex-col gap-2">
        <div class="font-medium text-sm">${it.name}</div>
        <div class="text-xs text-gray-500">${it.category}</div>
        <select class="sizeSel w-full border rounded px-2 py-1">${sizeOpts}</select>
        <textarea class="noteTxt w-full border rounded px-2 py-1 text-sm" rows="1" placeholder="Ghi ch√∫ (tu·ª≥ ch·ªçn)"></textarea>
        <details class="rounded border p-2">
          <summary class="text-xs cursor-pointer">Th√™m topping</summary>
          <div class="mt-2 grid grid-cols-1 gap-1 max-h-28 overflow-auto">${topOpts}</div>
        </details>
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <button class="qtyDec border rounded px-2">-</button>
            <span class="qtyVal">1</span>
            <button class="qtyInc border rounded px-2">+</button>
          </div>
          <button class="addBtn px-3 py-2 bg-tnm-primary text-white rounded-lg">Th√™m</button>
        </div>
      </div>`;
    }).join('');

    // Bind per-card actions
    Array.from(grid.children).forEach(card=>{
      const qtyVal = card.querySelector('.qtyVal');
      card.querySelector('.qtyDec').onclick = ()=>{ const n=Math.max(1, (Number(qtyVal.textContent)||1)-1); qtyVal.textContent=n; };
      card.querySelector('.qtyInc').onclick = ()=>{ const n=(Number(qtyVal.textContent)||1)+1; qtyVal.textContent=n; };
      card.querySelector('.addBtn').onclick = ()=>{
        const name = card.querySelector('.font-medium').textContent.trim();
        const [size, price] = (card.querySelector('.sizeSel').value||'').split('|');
        const basePrice = Number(price||0);
        const qty = Number(qtyVal.textContent)||1;
        const note = card.querySelector('.noteTxt').value.trim();
        const tops = Array.from(card.querySelectorAll('.topping-cb:checked')).map(cb=>{
          const [tn,tp] = cb.dataset.top.split('|'); return { id: uid(), name: tn, price: Number(tp||0) };
        });
        const menuItemId = uid();
        STATE.cart.push({ menuItemId, name, size, basePrice, qty, toppings: tops, note, itemStatus:'queued' });
        renderCart();
      };
    });
  }

  function renderCart(){
    const list = document.getElementById('cartList');
    if(!STATE.cart.length){ list.innerHTML = `<div class="text-sm text-gray-500">Ch∆∞a c√≥ m√≥n.</div>`; document.getElementById('cartTotal').textContent='0'; return; }
    list.innerHTML = STATE.cart.map((it,idx)=>{
      const tops = (it.toppings||[]).map(t=>`${t.name}(+${fmtVND(t.price)})`).join(', ');
      const sum = (it.basePrice + (it.toppings||[]).reduce((s,x)=>s+x.price,0))*it.qty;
      return `<div class="py-2 flex items-start gap-2">
        <div class="flex-1">
          <div class="text-sm font-medium">${it.name} ‚Äî ${it.size} √ó ${it.qty}</div>
          <div class="text-xs text-gray-500">${tops || 'Kh√¥ng topping'}${it.note? ' ¬∑ '+it.note : ''}</div>
        </div>
        <div class="text-right">
          <div class="text-sm font-semibold">${fmtVND(sum)}</div>
          <button data-rm="${idx}" class="text-xs text-red-600">X√≥a</button>
        </div>
      </div>`;
    }).join('');
    // bind remove
    list.querySelectorAll('[data-rm]').forEach(b=> b.onclick = ()=>{ STATE.cart.splice(Number(b.dataset.rm),1); renderCart(); });
    // total
    const total = STATE.cart.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
    document.getElementById('cartTotal').textContent = fmtVND(total);
  }

  async function sendOrder(){
    if(!STATE.cart.length) return;
    const sel = document.getElementById('tableSelect').value;
    const order = {
      id: 'ORD_'+uid(),
      type: sel==='takeaway' ? 'takeaway' : 'table',
      table: sel==='takeaway' ? null : Number(sel),
      items: JSON.parse(JSON.stringify(STATE.cart)),
      status: 'queued',
      createdAt: Date.now(),
      timeline: [{t:'queued', at: Date.now()}]
    };
    await DB.pushOrder(order);
    STATE.cart = [];
    renderCart();
    // switch to My Orders
    document.getElementById('myOrders').scrollIntoView({behavior:'smooth', block:'start'});
    refreshMyOrders();
  }

  function orderBadge(order){
    const take = order.type==='takeaway';
    const cls = take ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-blue-100 text-blue-700 border-blue-300';
    return `<span class="badge border ${cls} px-2 py-0.5 rounded">${take?'Mang v·ªÅ':'B√†n '+order.table}</span>`;
  }

  function renderMyOrders(orders){
    const host = document.getElementById('myOrders');
    const mine = orders.filter(o=> o.status!=='paid'); // simple view
    if(!mine.length){ host.innerHTML = `<div class="text-sm text-gray-500">Ch∆∞a c√≥ ƒë∆°n.</div>`; return; }
    host.innerHTML = mine.map(o=>{
      const delivered = o.items.filter(i=>i.itemStatus==='delivered').length;
      return `<div class="border rounded-lg p-2">
        <div class="flex items-center justify-between">
          <div class="text-sm font-medium">#${o.id.slice(-6)}</div>
          <div class="flex items-center gap-2">
            ${orderBadge(o)}
            <span class="text-xs ${o.status==='delivered'?'text-green-700':'text-gray-600'}">${delivered}/${o.items.length} m√≥n ƒë√£ giao</span>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  function groupByTable(orders){
    const map = new Map();
    for(const o of orders){
      const key = o.type==='takeaway' ? 'takeaway' : `table-${o.table}`;
      if(!map.has(key)) map.set(key, []);
      map.get(key).push(o);
    }
    // sort by createdAt asc and mark supplement
    for(const arr of map.values()){
      arr.sort((a,b)=>a.createdAt-b.createdAt);
      arr.forEach((o,i)=>o._supplement = i>0);
    }
    return map;
  }

  function renderBaristaTable(orders){
    const host = document.getElementById('barista-table');
    host.innerHTML = '';
    const grouped = groupByTable(orders.filter(o=>o.status!=='paid'));
    if(!grouped.size){ host.innerHTML = `<div class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</div>`; return; }
    for(const [key,arr] of grouped){
      const title = key==='takeaway' ? 'Mang v·ªÅ' : `B√†n ${key.split('-')[1]}`;
      const badge = key==='takeaway' ? `<span class="badge border bg-amber-100 text-amber-700 border-amber-300 px-2 py-0.5 rounded">∆Øu ti√™n</span>` : '';
      const col = document.createElement('div');
      col.className = 'bg-white border rounded-xl p-3';
      col.innerHTML = `<div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">${title}</h3>${badge}
        </div>
        <div class="space-y-2"></div>`;
      const list = col.querySelector('.space-y-2');

      arr.forEach(o=>{
        const itemsHtml = o.items.map((it,idx)=>{
          const tops = (it.toppings||[]).map(t=>t.name).join(', ');
          return `<div class="border rounded p-2">
            <div class="flex items-center justify-between">
              <div class="font-medium text-sm">${it.name} ‚Äî ${it.size} √ó ${it.qty}</div>
              <span class="text-xs ${it.itemStatus==='delivered'?'text-green-700':'text-gray-500'}">${it.itemStatus}</span>
            </div>
            <div class="text-xs text-gray-500">${tops||'Kh√¥ng topping'}${it.note?' ¬∑ '+it.note:''}</div>
            <div class="mt-1 text-right">
              <button data-deliver="${o.id}|${idx}" class="text-xs px-2 py-1 border rounded ${it.itemStatus==='delivered'?'opacity-40 pointer-events-none':''}">ƒê√£ giao</button>
            </div>
          </div>`;
        }).join('');

        list.innerHTML += `<div class="bg-gray-50 rounded p-2">
          <div class="flex items-center justify-between">
            <div class="text-sm">ƒê∆°n <span class="font-semibold">#${o.id.slice(-6)}</span>${o._supplement? ' ¬∑ <span class="text-amber-600">B·ªï sung</span>':''}</div>
            <button data-deliver-all="${o.id}" class="text-xs px-2 py-1 border rounded">Giao h·∫øt</button>
          </div>
          <div class="mt-2 space-y-2">${itemsHtml}</div>
        </div>`;
      });

      host.appendChild(col);
    }
    // bind deliver
    host.querySelectorAll('[data-deliver]').forEach(b=> b.onclick = async ()=>{
      const [oid, idx] = b.dataset.deliver.split('|');
      await DB.updateItemStatus(oid, Number(idx), 'delivered');
      refreshAll();
    });
    host.querySelectorAll('[data-deliver-all]').forEach(b=> b.onclick = async ()=>{
      const oid = b.dataset.deliverAll;
      // load current
      const orders = await DB.listOrders();
      const o = orders.find(x=>x.id===oid);
      if(!o) return;
      for(let i=0;i<o.items.length;i++){ if(o.items[i].itemStatus!=='delivered') await DB.updateItemStatus(oid, i, 'delivered'); }
      refreshAll();
    });
  }

  function renderBaristaItem(orders){
    const host = document.getElementById('barista-item');
    const waiting = [];
    for(const o of orders.filter(o=>o.status!=='paid')){
      for(let i=0;i<o.items.length;i++){
        const it = o.items[i];
        waiting.push({ order:o, item:it, idx:i, createdAt:o.createdAt });
      }
    }
    waiting.sort((a,b)=>a.createdAt-b.createdAt);
    if(!waiting.length){ host.innerHTML = `<div class="text-sm text-gray-500">Kh√¥ng c√≥ m√≥n.</div>`; return; }
    host.innerHTML = waiting.map(rec=>{
      const tops = (rec.item.toppings||[]).map(t=>t.name).join(', ');
      return `<div class="bg-white border rounded-xl p-2">
        <div class="flex items-center justify-between">
          <div class="text-sm font-medium">${rec.item.name} ‚Äî ${rec.item.size} √ó ${rec.item.qty}</div>
          ${orderBadge(rec.order)}
        </div>
        <div class="text-xs text-gray-500">${tops||'Kh√¥ng topping'}${rec.item.note?' ¬∑ '+rec.item.note:''}</div>
        <div class="mt-1 text-right">
          <button data-deliver="${rec.order.id}|${rec.idx}" class="text-xs px-2 py-1 border rounded ${rec.item.itemStatus==='delivered'?'opacity-40 pointer-events-none':''}">ƒê√£ giao</button>
        </div>
      </div>`;
    }).join('');

    host.querySelectorAll('[data-deliver]').forEach(b=> b.onclick = async ()=>{
      const [oid, idx] = b.dataset.deliver.split('|');
      await DB.updateItemStatus(oid, Number(idx), 'delivered');
      refreshAll();
    });
  }

  function renderCashier(orders){
    const queueHost = document.getElementById('cashier-queue');
    const waitPayHost = document.getElementById('cashier-waitpay');
    // queue = queued OR partially delivered
    const queue = orders.filter(o=>o.status==='queued');
    const delivered = orders.filter(o=>o.status==='delivered');

    const orderCard = (o)=> {
      const deliveredCnt = o.items.filter(i=>i.itemStatus==='delivered').length;
      const sum = o.items.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
      return `<div class="border rounded p-2 bg-white">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">#${o.id.slice(-6)}</div>
          <div class="flex items-center gap-2">${orderBadge(o)}<span class="text-xs text-gray-500">${deliveredCnt}/${o.items.length}</span></div>
        </div>
        <div class="text-right text-sm font-medium mt-1">${fmtVND(sum)} ƒë</div>
      </div>`;
    };

    queueHost.innerHTML = queue.map(orderCard).join('') || `<div class="text-sm text-gray-500">Tr·ªëng</div>`;
    waitPayHost.innerHTML = '';

    // Group delivered by table/takeaway for payment modal
    const groups = groupByTable(delivered);
    for(const [key,arr] of groups){
      const type = key==='takeaway'?'takeaway':'table';
      const title = key==='takeaway'?'Mang v·ªÅ':`B√†n ${key.split('-')[1]}`;
      const btnId = uid();
      const wrap = document.createElement('div');
      wrap.className = 'border rounded p-2 bg-white';
      wrap.innerHTML = `<div class="flex items-center justify-between">
        <div class="font-semibold">${title}</div>
        <button id="${btnId}" class="text-xs px-2 py-1 border rounded">Thanh to√°n ${title}</button>
      </div>
      <div class="mt-2 grid sm:grid-cols-2 gap-2">${arr.map(orderCard).join('')}</div>`;
      document.getElementById('cashier-waitpay').appendChild(wrap);

      // bind pay button -> open modal
      setTimeout(()=> document.getElementById(btnId).onclick = ()=> openPayModal({type, table: type==='table'? Number(key.split('-')[1]) : null}, arr), 0);
    }
  }

  function openPayModal(group, orders){
    const host = document.getElementById('modalHost');
    const sum = (o)=> o.items.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
    const total = orders.reduce((s,o)=> s+sum(o), 0);
    host.innerHTML = `<div class="fixed inset-0 bg-black/30 flex items-end sm:items-center sm:justify-center z-50" onclick="closeModal(event)">
      <div class="bg-white rounded-t-xl sm:rounded-xl w-full sm:max-w-lg p-3" onclick="event.stopPropagation()">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Thanh to√°n ${group.type==='takeaway'?'Mang v·ªÅ':'B√†n '+group.table}</h3>
          <button onclick="closeModal()" class="text-gray-500">√ó</button>
        </div>
        <div class="mt-2 max-h-80 overflow-auto">
          ${orders.map(o=>`
            <div class="border rounded p-2 mb-2">
              <div class="text-sm font-medium">#${o.id.slice(-6)}</div>
              <ul class="text-xs text-gray-700 mt-1 space-y-1">
                ${o.items.map(it=>{
                  const tops = (it.toppings||[]).map(t=>t.name).join(', ');
                  const sub = (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty;
                  return `<li>‚Ä¢ ${it.name} ‚Äî ${it.size} √ó ${it.qty} (${tops||'kh√¥ng topping'}) ‚Äî <span class="font-medium">${fmtVND(sub)}</span></li>`;
                }).join('')}
              </ul>
            </div>`).join('')}
        </div>
        <div class="flex items-center justify-between mt-2">
          <div class="text-sm">T·ªïng: <span class="font-semibold">${fmtVND(total)} ƒë</span></div>
          <button id="confirmPayBtn" class="px-3 py-2 bg-tnm-green text-white rounded">X√°c nh·∫≠n thanh to√°n</button>
        </div>
      </div>
    </div>`;
    document.getElementById('confirmPayBtn').onclick = async ()=>{
      await DB.markPaid(group);
      closeModal();
      refreshAll();
      showToast('ƒê√£ ghi nh·∫≠n thanh to√°n.');
    };
  }
  function closeModal(){ document.getElementById('modalHost').innerHTML=''; }
  window.closeModal = closeModal;

  function loadRevenueUI(){
    const pack = Revenue.load();
    // table
    const tb = document.getElementById('revenueTable');
    const entries = Object.values(pack.entries).sort((a,b)=> a.paidAt.localeCompare(b.paidAt));
    tb.innerHTML = entries.map(e=>{
      const itemCount = e.items.reduce((s,x)=>s+(x.qty||1),0);
      return `<tr>
        <td class="p-1">${e.paidAt.replace('T',' ')}</td>
        <td class="p-1">${e.tableOrTakeAway}</td>
        <td class="p-1">#${e.orderId.slice(-6)}</td>
        <td class="p-1 text-right">${itemCount}</td>
        <td class="p-1 text-right">${fmtVND(e.amount)}</td>
        <td class="p-1"></td>
      </tr>`;
    }).join('');
    document.getElementById('todayAmount').textContent = fmtVND(pack.summary.totalAmount||0);
    document.getElementById('kpiOrdersToday').textContent = entries.length;
  }

  function renderAdminKPI(){
    const bytes = new Blob([JSON.stringify(localStorage)]).size;
    document.getElementById('kpiLocalSize').textContent = (bytes/1024).toFixed(1) + ' KB';
    document.getElementById('kpiPeers').textContent = STATE.peers;
    document.getElementById('kpiBandwidth').textContent = hasFirebase? 'Cloud sync (est.)' : 'Local only';
  }

  /********************
   * Refresh hub
   ********************/
  async function refreshAll(){
    // staff needs menu + my orders
    if(STATE.role==='staff'){
      renderMenu();
      refreshMyOrders();
    }
    // barista
    if(STATE.role==='barista' || STATE.role==='cashier'){
      const orders = await DB.listOrders();
      if(STATE.role==='barista'){
        const activeTab = document.querySelector('.btab.bg-gray-100')?.dataset?.btab || 'table';
        renderBaristaTable(orders);
        renderBaristaItem(orders);
        document.getElementById('barista-table').classList.toggle('hidden', activeTab!=='table');
        document.getElementById('barista-item').classList.toggle('hidden', activeTab!=='item');
      }
      if(STATE.role==='cashier'){
        renderCashier(orders);
        loadRevenueUI();
      }
    }
    if(STATE.role==='admin'){
      loadRevenueUI();
      renderAdminKPI();
    }
  }

  async function refreshMyOrders(){
    const orders = await DB.listOrders();
    // show by current table? For simplicity, show all not paid by this device session
    renderMyOrders(orders);
  }

  /********************
   * CSV Download (Revenue)
   ********************/
  function downloadRevenueCSV(){
    const pack = Revenue.load();
    const rows = [['paidAt','type','tableOrTakeAway','orderId','itemCount','amount']];
    for(const e of Object.values(pack.entries)){
      const type = e.tableOrTakeAway==='Mang v·ªÅ' ? 'takeaway' : 'table';
      const table = e.tableOrTakeAway==='Mang v·ªÅ' ? '' : e.tableOrTakeAway.replace('B√†n ','');
      const itemCount = e.items.reduce((s,x)=>s+(x.qty||1),0);
      rows.push([e.paidAt, type, table||'Mang v·ªÅ', e.orderId, itemCount, e.amount]);
    }
    const csv = rows.map(r=> r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `revenue_${todayKey().replaceAll('-','')}.csv`;
    a.click();
  }

  /********************
   * Events & Boot
   ********************/
  document.getElementById('roleSelect').onchange = (e)=> setRole(e.target.value);
  document.getElementById('resetBtn').onclick = ()=>{
    if(confirm('Xo√° d·ªØ li·ªáu local h√¥m nay (orders & revenue)?')) {
      // naive clean today keys used in Local adapter & Revenue
      Object.keys(localStorage).forEach(k=>{
        if(k.startsWith('tnm_orders_today_') || k.startsWith('tnm_revenue_')) localStorage.removeItem(k);
      });
      refreshAll();
      showToast('ƒê√£ reset d·ªØ li·ªáu local.');
    }
  };

  document.getElementById('categorySelect').onchange = renderMenu;
  document.querySelectorAll('.qf-btn').forEach(b=> b.onclick = ()=>{
    document.getElementById('categorySelect').value = b.dataset.qf;
    renderMenu();
  });
  document.getElementById('clearCartBtn').onclick = ()=>{ STATE.cart=[]; renderCart(); };
  document.getElementById('sendOrderBtn').onclick = sendOrder;

  document.querySelectorAll('.btab').forEach(b=> b.onclick = ()=>{
    document.querySelectorAll('.btab').forEach(x=>x.classList.remove('bg-gray-100'));
    b.classList.add('bg-gray-100');
    document.getElementById('barista-table').classList.toggle('hidden', b.dataset.btab!=='table');
    document.getElementById('barista-item').classList.toggle('hidden', b.dataset.btab!=='item');
  });

  document.getElementById('dlRevenueBtn').onclick = downloadRevenueCSV;
  document.getElementById('saveCfg').onclick = saveConfig;

  // Boot
  (async function init(){
    loadConfig();
    await loadMenuFromCSV();
    renderCategories();
    renderMenu();
    applyRoleFromURL();
    renderCart();
    loadRevenueUI();
    renderAdminKPI();
    showToast('S·∫µn s√†ng nh·∫≠n order.');
  })();
  </script>
</body>
</html>
