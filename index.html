<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse ƒë·ªÉ ƒë·ªçc CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .modal-enter{opacity:0;transform:translateY(6px)}
    .modal-enter-active{opacity:1;transform:translateY(0);transition:all .15s ease}
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üßã</span>
        <div>
          <h1 class="text-lg font-bold">Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</h1>
          <p class="text-xs text-gray-500">HTML + CSV ¬∑ LocalStorage</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <select id="roleSelect" class="border rounded-lg px-3 py-2 text-sm">
          <option value="staff">Nh√¢n vi√™n (G·ªçi m√≥n)</option>
          <option value="barista">Qu·∫ßy pha ch·∫ø</option>
          <option value="cashier">Thu ng√¢n</option>
          <option value="admin">Qu·∫£n l√Ω</option>
        </select>
        <button id="btnResetData" class="text-sm px-3 py-2 border rounded-lg">Reset ƒë∆°n</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- STAFF -->
    <section id="view-staff" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-gray-900">Ch·ªçn b√†n & Menu</h2>
              <div class="flex items-center gap-3">
                <select id="tableSelect" class="border rounded-lg px-3 py-2 text-sm"></select>
                <select id="catFilter" class="border rounded-lg px-3 py-2 text-sm"></select>
                <input id="searchInput" class="border rounded-lg px-3 py-2 text-sm w-48" placeholder="T√¨m m√≥n..." />
              </div>
            </div>
            <div id="menuGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </section>
        </div>
        <div class="space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 id="cartTitle" class="text-xl font-semibold text-gray-900 mb-3">Gi·ªè h√†ng</h2>
            <div id="cartList" class="space-y-3 text-sm text-gray-700">Ch∆∞a c√≥ m√≥n.</div>
            <div class="pt-3 mt-2 border-t flex items-center justify-between">
              <span class="font-semibold">T·ªïng</span>
              <span id="cartTotal" class="font-bold">0‚Ç´</span>
            </div>
            <button id="btnSubmitOrder" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-2 mt-3">
              G·ª≠i order ƒë·∫øn qu·∫ßy pha ch·∫ø
            </button>
          </section>
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">ƒê∆°n g·∫ßn ƒë√¢y (ch∆∞a thanh to√°n)</h2>
            <div id="recentOrders" class="space-y-2 max-h-80 overflow-auto pr-1"></div>
          </section>
        </div>
      </div>
    </section>

    <!-- BARISTA -->
    <section id="view-barista" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">H√†ng ƒë·ª£i pha ch·∫ø</h2>
          <div class="flex items-center gap-2 text-sm">
            <button id="tabByTable" class="px-3 py-1 rounded-lg border">Xem theo b√†n</button>
            <button id="tabByItem" class="px-3 py-1 rounded-lg border">Xem t·ªïng m√≥n</button>
          </div>
        </div>
        <div id="baristaByTable" class="grid md:grid-cols-2 gap-4"></div>
        <div id="baristaByItem" class="grid md:grid-cols-3 gap-4 hidden"></div>
      </section>
    </section>

    <!-- CASHIER -->
    <section id="view-cashier" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ch·ªù thanh to√°n</h2>
        <div id="cashierNotPaid" class="space-y-3"></div>
      </section>

      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900">ƒê√£ thanh to√°n h√¥m nay</h2>
          <span id="cashierTotalToday" class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700"></span>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-600">
                <th class="py-2">Th·ªùi gian</th>
                <th class="py-2">B√†n</th>
                <th class="py-2">M√£ ƒë∆°n</th>
                <th class="py-2">Chi ti·∫øt</th>
                <th class="py-2 text-right">T·ªïng</th>
              </tr>
            </thead>
            <tbody id="revTodayBody"></tbody>
          </table>
        </div>
        <div class="mt-3 text-right">
          <button id="btnExportToday" class="px-3 py-1 rounded-lg border">T·∫£i CSV</button>
        </div>
      </section>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="hidden grid md:grid-cols-2 gap-6">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">C·∫•u h√¨nh qu√°n</h2>
        <label class="text-sm text-gray-700">S·ªë l∆∞·ª£ng b√†n</label>
        <input id="tablesInput" type="number" min="1" class="border rounded-lg px-3 py-2 w-40" />
        <p class="text-xs text-gray-500 mt-2">CSV: <code>assets/menu.csv</code> ¬∑ C·ªôt: Category, Item, Size, Price</p>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Menu (JSON xem nhanh)</h2>
        <textarea id="menuTextarea" class="w-full h-80 border rounded-xl p-3 font-mono text-sm" readonly></textarea>
      </section>
    </section>
  </main>

  <!-- Pay Modal -->
  <div id="payModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-5 modal-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 id="payTitle" class="text-lg font-semibold">Thanh to√°n</h3>
        <button id="btnClosePay" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div id="payLines" class="space-y-2"></div>
      <div class="pt-2 mt-2 border-t flex items-center justify-between">
        <span class="font-semibold">T·ªïng</span>
        <span id="payTotal" class="font-bold">0‚Ç´</span>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelPay" class="px-4 py-2 rounded-lg border">ƒê√≥ng</button>
        <button id="btnConfirmPay" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </div>
  </div>

  <!-- Toast host + sound -->
  <div id="toastHost" class="fixed top-3 left-3 z-50 space-y-2"></div>
  <audio id="newOrderSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script>
    /* ================== CORE ================== */
    const CSV_PATH = 'assets/menu.csv';
    const STORAGE_KEY = 'tn_pos_v2';
    const ROLES = ['staff','barista','cashier','admin'];

    function slugify(str){
      return String(str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9\\s-]/g,'').trim().replace(/\\s+/g,'_').toLowerCase();
    }
    function parsePrice(v){ if(typeof v==='number') return v; const s=String(v||'').replace(/[^\\d]/g,''); return s?Number(s):0; }
    function money(n){ return n.toLocaleString('vi-VN')+'‚Ç´'; }
    function now(){ return Date.now(); }
    function newId(p){ return p+'_'+Math.random().toString(36).slice(2,9); }
    function shortId(id){ return id? id.slice(-4):''; }
    function fmtTime(ts){ return new Date(ts).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); }
    function isToday(ts){ const d=new Date(ts), t=new Date(); return d.getFullYear()===t.getFullYear()&&d.getMonth()===t.getMonth()&&d.getDate()===t.getDate(); }

    // state
    let store = loadStore();
    let role = 'staff';
    let baristaTab = 'by-table';
    let tablePicking = 1;
    let viewingOrderId = null;

    // cart: { id: { qty, note, toppings:[{id,name,price,qty}] } }
    let cart = {};
    function ensureCartItem(id){ if(!cart[id]) cart[id]={qty:0,note:'',toppings:[]}; return cart[id]; }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { menu: [], orders: [], tables: 12 };
        const p = JSON.parse(raw);
        return { menu: p.menu||[], orders: p.orders||[], tables: p.tables||12 };
      }catch{ return { menu: [], orders: [], tables: 12 }; }
    }
    function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

    // elements
    const els = {
      roleSelect: document.getElementById('roleSelect'),
      btnResetData: document.getElementById('btnResetData'),
      views:{
        staff: document.getElementById('view-staff'),
        barista: document.getElementById('view-barista'),
        cashier: document.getElementById('view-cashier'),
        admin: document.getElementById('view-admin'),
      },
      tableSelect: document.getElementById('tableSelect'),
      catFilter: document.getElementById('catFilter'),
      searchInput: document.getElementById('searchInput'),
      menuGrid: document.getElementById('menuGrid'),
      cartTitle: document.getElementById('cartTitle'),
      cartList: document.getElementById('cartList'),
      cartTotal: document.getElementById('cartTotal'),
      btnSubmitOrder: document.getElementById('btnSubmitOrder'),
      recentOrders: document.getElementById('recentOrders'),
      // barista
      tabByTable: document.getElementById('tabByTable'),
      tabByItem: document.getElementById('tabByItem'),
      baristaByTable: document.getElementById('baristaByTable'),
      baristaByItem: document.getElementById('baristaByItem'),
      // cashier
      cashierNotPaid: document.getElementById('cashierNotPaid'),
      cashierTotalToday: document.getElementById('cashierTotalToday'),
      revTodayBody: document.getElementById('revTodayBody'),
      btnExportToday: document.getElementById('btnExportToday'),
      // admin
      tablesInput: document.getElementById('tablesInput'),
      menuTextarea: document.getElementById('menuTextarea'),
      // pay modal
      payModal: document.getElementById('payModal'),
      payTitle: document.getElementById('payTitle'),
      payLines: document.getElementById('payLines'),
      payTotal: document.getElementById('payTotal'),
      btnClosePay: document.getElementById('btnClosePay'),
      btnCancelPay: document.getElementById('btnCancelPay'),
      btnConfirmPay: document.getElementById('btnConfirmPay'),
    };

    /* ================== MENU (CSV) ================== */
    function rowToMenuItem(row){
      const category = (row.Category||'Other').toString().trim();
      const baseName = (row.Item||'').toString().trim(); if(!baseName) return null;
      const size = (row.Size||'').toString().trim();
      const name = size ? \`\${baseName} (\${size})\` : baseName;
      const price = parsePrice(row.Price);
      const id = slugify(name)||('itm_'+Math.random().toString(36).slice(2,8));
      return { id, name, price, category };
    }
    async function loadCSV(){
      try{
        const res = await fetch(CSV_PATH, {cache:'no-store'});
        const text = await res.text();
        const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
        const rows = Array.isArray(parsed.data) ? parsed.data : [];
        const items = rows.map(rowToMenuItem).filter(Boolean);
        if(items.length){ store.menu = items; saveStore(); }
      }catch(e){ console.warn('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c CSV:', e); }
    }

    /* ================== HELPERS ================== */
    function statusLabel(s){ return ({queued:'Ch·ªù pha',brewing:'ƒêang pha',ready:'S·∫µn s√†ng',delivered:'ƒê√£ giao',paid:'ƒê√£ thanh to√°n'})[s]||s; }
    function calcOrderTotal(o){
      return o.items.reduce((t,it)=> t + it.price*it.qty + (it.toppings||[]).reduce((s,tp)=>s+tp.price*tp.qty,0), 0);
    }
    function getQueues(){
      const notPaid = store.orders.filter(o => o.status!=='paid').sort((a,b)=>a.createdAt-b.createdAt);
      const brewing = notPaid.filter(o=>['queued','brewing'].includes(o.status));
      const delivered = notPaid.filter(o=>o.status==='delivered');
      return { brewing, delivered };
    }
    function getToppings(){ return (store.menu||[]).filter(m=>/topping/i.test(m.category)); }

    function setStatus(orderId, status){
      store.orders = store.orders.map(o => o.id===orderId
        ? {...o,status, timeline:[...(o.timeline||[]), {status, ts: now()}]}
        : o);
      saveStore(); render();
    }
    function serveItem(orderId, itemIndex, amount=1){
      const o = store.orders.find(x=>x.id===orderId); if(!o) return;
      const it = o.items[itemIndex]; if(!it) return;
      it.served = Math.min(it.qty, (it.served||0)+amount);
      const allServed = o.items.every(x => (x.served||0) >= x.qty);
      if(allServed && o.status!=='paid'){
        o.status='delivered';
        o.timeline=[...(o.timeline||[]),{status:'delivered',ts:now()}];
      }else if(o.status==='queued'){
        o.status='brewing';
      }
      saveStore(); render();
    }

    function openPay(orderId){
      const o = store.orders.find(x=>x.id===orderId); if(!o) return;
      viewingOrderId = orderId;
      els.payTitle.textContent = `Thanh to√°n ¬∑ ${o.table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+o.table}`;
      els.payLines.innerHTML = o.items.map(it=>{
        const tops = (it.toppings||[]).map(t=>`<div class="flex justify-between text-xs text-gray-600"><span>‚Ä¢ ${t.name} √ó ${t.qty}</span><span>${money(t.price*t.qty)}</span></div>`).join('');
        return `<div class="flex items-start justify-between">
          <div><div>${it.name} √ó ${it.qty}</div>${tops}</div>
          <span class="font-medium">${money(it.price*it.qty)}</span>
        </div>`;
      }).join('');
      els.payTotal.textContent = money(calcOrderTotal(o));
      els.payModal.classList.remove('hidden'); els.payModal.classList.add('flex');
      requestAnimationFrame(()=> els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'));
      els.btnConfirmPay.onclick = ()=>{ setStatus(orderId,'paid'); closePay(); };
    }
    function closePay(){
      els.payModal.classList.add('hidden'); els.payModal.classList.remove('flex');
      els.payModal.querySelector('.modal-enter')?.classList.remove('modal-enter-active');
      viewingOrderId = null;
    }

    // Toast + sound cho ƒë∆°n m·ªõi
    let knownOrderIds = new Set(store.orders.map(o=>o.id));
    function showToast(html){
      const host = document.getElementById('toastHost');
      const box = document.createElement('div');
      box.className = 'bg-black/80 text-white text-sm rounded-xl px-3 py-2 shadow';
      box.innerHTML = html + ' <button class="ml-2 text-xs opacity-70 hover:opacity-100" data-x>‚úï</button>';
      host.appendChild(box);
      const snd = document.getElementById('newOrderSound'); try{ snd.currentTime=0; snd.play().catch(()=>{});}catch{}
      const kill = ()=>box.remove(); box.querySelector('[data-x]').addEventListener('click', kill);
      setTimeout(kill, 3000);
    }
    function toastNewOrders(){
      store.orders.forEach(o=>{
        if(!knownOrderIds.has(o.id) && o.status==='queued'){
          showToast(`üßæ ƒê∆°n m·ªõi #${shortId(o.id)} ¬∑ ${o.table==='TA'?'Mang v·ªÅ':'B√†n '+o.table}`);
        }
      });
      knownOrderIds = new Set(store.orders.map(o=>o.id));
    }

    /* ================== RENDER ================== */
    function renderRole(){
      Object.values(els.views).forEach(v=>v.classList.add('hidden'));
      els.views[role].classList.remove('hidden');
      els.roleSelect.value = role;
    }

    function renderStaff(){
      els.tableSelect.innerHTML =
        `<option value="TA">Mang v·ªÅ (TA)</option>` +
        Array.from({length: store.tables}).map((_,i)=>`<option value="${i+1}">B√†n ${i+1}</option>`).join('');
      els.tableSelect.value = String(tablePicking);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${tablePicking==='TA'?'Mang v·ªÅ':('B√†n '+tablePicking)}`;

      const prevCat = els.catFilter.value || 'All';
      const cats = ['All', ...new Set((store.menu||[]).map(m=>m.category))];
      els.catFilter.innerHTML = cats.map(c=>`<option value="${c}">${c}</option>`).join('');
      els.catFilter.value = cats.includes(prevCat) ? prevCat : 'All';

      const kw = (els.searchInput.value||'').toLowerCase();
      const cat = els.catFilter.value || 'All';
      const list = (store.menu||[]).filter(m => (cat==='All'||m.category===cat) && (!kw || m.name.toLowerCase().includes(kw)));

      els.menuGrid.innerHTML = list.map(m=>`
        <div class="border rounded-xl p-4 hover:shadow-sm bg-white">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold text-gray-900">${m.name}</h3>
              <p class="text-xs text-gray-500">${m.category}</p>
            </div>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${money(m.price)}</span>
          </div>
          <div class="mt-3 space-y-2">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <button data-dec="${m.id}" class="px-2 py-1 border rounded">-</button>
                <span class="w-8 text-center">${(cart[m.id]?.qty)||0}</span>
                <button data-inc="${m.id}" class="px-2 py-1 border rounded">+</button>
              </div>
              <button data-add="${m.id}" class="px-3 py-1 rounded-lg bg-black text-white text-sm">Th√™m</button>
            </div>
          </div>
        </div>
      `).join('');

      els.menuGrid.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',e=>{const id=e.target.getAttribute('data-inc');ensureCartItem(id).qty++; renderCart();}));
      els.menuGrid.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',e=>{const id=e.target.getAttribute('data-dec');const it=cart[id]; if(!it) return; it.qty=Math.max(0,it.qty-1); if(it.qty===0) delete cart[id]; renderCart();}));
      els.menuGrid.querySelectorAll('[data-add]').forEach(b=>b.addEventListener('click',e=>{const id=e.target.getAttribute('data-add');const it=ensureCartItem(id); if(it.qty===0) it.qty=1; renderCart();}));

      renderCart();

      const listRecent = store.orders.filter(o=>o.status!=='paid').sort((a,b)=>b.createdAt-a.createdAt).slice(0,8);
      els.recentOrders.innerHTML = listRecent.map(o=>`
        <div class="flex items-center justify-between border rounded-lg p-3">
          <div>
            <p class="font-medium">${o.table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+o.table}</p>
            <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
        </div>`).join('');
    }

    function renderCart(){
      const ids = Object.keys(cart);
      if(ids.length===0){ els.cartList.textContent='Ch∆∞a c√≥ m√≥n.'; els.cartTotal.textContent='0‚Ç´'; return; }

      const toppingOpts = getToppings().map(t=>`<option value="${t.id}">${t.name} (+${money(t.price)})</option>`).join('');
      els.cartList.innerHTML = ids.map(id=>{
        const mi = store.menu.find(m=>m.id===id); if(!mi) return '';
        const ci = cart[id];
        const tops = (ci.toppings||[]).map(tp=>`
          <div class="flex items-center justify-between text-xs text-gray-600">
            <span>‚Ä¢ ${tp.name} √ó ${tp.qty}</span><span>${money(tp.price*tp.qty)}</span>
          </div>`).join('');
        return `
        <div class="border rounded-lg p-3 space-y-2">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium">${mi.name}</p>
              <p class="text-xs text-gray-500">${money(mi.price)} √ó ${ci.qty}</p>
            </div>
            <div class="flex items-center gap-2">
              <button data-dec-cart="${id}" class="px-2 py-1 border rounded">-</button>
              <span class="w-6 text-center">${ci.qty}</span>
              <button data-inc-cart="${id}" class="px-2 py-1 border rounded">+</button>
            </div>
          </div>
          <input data-note="${id}" class="border rounded px-2 py-1 text-xs w-full" placeholder="Ghi ch√∫ cho m√≥n n√†y..." value="${ci.note||''}">
          <div class="flex items-center gap-2">
            <select data-addtp="${id}" class="border rounded px-2 py-1 text-xs">
              <option value="">+ Th√™m topping</option>
              ${toppingOpts}
            </select>
            <button data-cleartp="${id}" class="text-xs border px-2 py-1 rounded">Xo√° topping</button>
          </div>
          ${tops?`<div class="pt-1 border-t">${tops}</div>`:''}
        </div>`;
      }).join('');

      els.cartList.querySelectorAll('[data-dec-cart]').forEach(b=>b.addEventListener('click',e=>{const id=e.target.getAttribute('data-dec-cart'); const it=cart[id]; if(!it) return; it.qty=Math.max(0,it.qty-1); if(it.qty===0) delete cart[id]; renderCart();}));
      els.cartList.querySelectorAll('[data-inc-cart]').forEach(b=>b.addEventListener('click',e=>{const id=e.target.getAttribute('data-inc-cart'); ensureCartItem(id).qty++; renderCart();}));
      els.cartList.querySelectorAll('[data-note]').forEach(inp=>inp.addEventListener('input', e=>{ const id=e.target.getAttribute('data-note'); ensureCartItem(id).note=e.target.value; }));
      els.cartList.querySelectorAll('[data-addtp]').forEach(sel=>sel.addEventListener('change', e=>{
        const id=e.target.getAttribute('data-addtp'); const tpId=e.target.value; if(!tpId) return;
        const tp = getToppings().find(t=>t.id===tpId); if(!tp) return;
        const ci = ensureCartItem(id);
        const ex = ci.toppings.find(x=>x.id===tpId);
        if(ex) ex.qty++; else ci.toppings.push({id:tp.id,name:tp.name,price:tp.price,qty:1});
        e.target.value=''; renderCart();
      }));
      els.cartList.querySelectorAll('[data-cleartp]').forEach(b=>b.addEventListener('click', e=>{ const id=e.target.getAttribute('data-cleartp'); const ci=cart[id]; if(ci){ ci.toppings=[]; renderCart(); } }));

      // t·ªïng ti·ªÅn
      const total = ids.reduce((sum,id)=>{
        const mi=store.menu.find(m=>m.id===id); const ci=cart[id];
        const core = mi ? mi.price*ci.qty : 0;
        const tops = (ci.toppings||[]).reduce((s,t)=>s+t.price*t.qty,0);
        return sum + core + tops;
      },0);
      els.cartTotal.textContent = money(total);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${tablePicking==='TA'?'Mang v·ªÅ':('B√†n '+tablePicking)}`;
    }

    function renderBarista(){
      els.tabByTable.classList.toggle('bg-black', baristaTab==='by-table');
      els.tabByTable.classList.toggle('text-white', baristaTab==='by-table');
      els.tabByItem.classList.toggle('bg-black', baristaTab==='by-item');
      els.tabByItem.classList.toggle('text-white', baristaTab==='by-item');

      const { brewing } = getQueues();

      // nh√≥m theo b√†n
      const map = new Map();
      brewing.forEach(o=>{
        const list = map.get(o.table) || [];
        list.push(o); map.set(o.table, list);
      });

      // BY TABLE
      const entries = Array.from(map.entries()).sort((a,b)=> (a[0]+'' ).localeCompare(b[0]+''));
      els.baristaByTable.innerHTML = entries.map(([table,orders])=>`
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+table}</h3>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${orders.length} ƒë∆°n</span>
          </div>
          <div class="space-y-3">
            ${orders.map(o=>`
              <div class="border rounded-lg p-3 ${o.table==='TA'?'ring-2 ring-yellow-300':''}">
                <div class="flex items-center justify-between">
                  <div class="text-sm text-gray-500">#${shortId(o.id)} ¬∑ ${o.__addonIndex>0?'B·ªï sung':'ƒê∆°n ƒë·∫ßu'} ¬∑ ${fmtTime(o.createdAt)}</div>
                  <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
                </div>
                <ul class="mt-2 text-sm space-y-1">
                  ${o.items.map((it,idx)=>`
                    <li class="flex items-center justify-between gap-2">
                      <div>
                        ${it.name} √ó ${it.qty}
                        ${it.note ? `<span class="ml-1 text-xs text-amber-700 bg-amber-100 px-1 rounded">Note: ${it.note}</span>`:''}
                        ${Array.isArray(it.toppings)&&it.toppings.length? `<span class="ml-1 text-xs text-indigo-700 bg-indigo-100 px-1 rounded">+ ${it.toppings.map(t=>`${t.name}√ó${t.qty}`).join(', ')}</span>`:''}
                      </div>
                      <div class="flex items-center gap-1">
                        <button data-serve-one="${o.id}|${idx}" class="px-2 py-0.5 text-xs border rounded">ƒê√£ giao 1</button>
                        <button data-serve-all="${o.id}|${idx}" class="px-2 py-0.5 text-xs border rounded">Giao h·∫øt m√≥n</button>
                        <span class="text-xs text-gray-500">ƒê√£ giao: ${it.served||0}</span>
                      </div>
                    </li>`).join('')}
                </ul>
                <div class="mt-3 flex gap-2">
                  ${o.status==='queued' ? `<button data-start="${o.id}" class="px-3 py-1 rounded-lg bg-amber-600 text-white">B·∫Øt ƒë·∫ßu pha</button>`:''}
                  ${o.status!=='paid' ? `<button data-serve-order="${o.id}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Giao h·∫øt ƒë∆°n</button>`:''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`).join('');

      // listeners
      els.baristaByTable.querySelectorAll('[data-start]').forEach(b=>b.addEventListener('click',e=>setStatus(e.target.getAttribute('data-start'),'brewing')));
      els.baristaByTable.querySelectorAll('[data-serve-one]').forEach(b=>b.addEventListener('click', e=>{
        const [oid, idx] = e.target.getAttribute('data-serve-one').split('|'); serveItem(oid, Number(idx), 1);
      }));
      els.baristaByTable.querySelectorAll('[data-serve-all]').forEach(b=>b.addEventListener('click', e=>{
        const [oid, idx] = e.target.getAttribute('data-serve-all').split('|');
        const o = store.orders.find(x=>x.id===oid); if(!o) return;
        const it=o.items[idx]; if(!it) return;
        serveItem(oid, Number(idx), (it.qty - (it.served||0)));
      }));
      els.baristaByTable.querySelectorAll('[data-serve-order]').forEach(b=>b.addEventListener('click', e=>{
        const oid = e.target.getAttribute('data-serve-order');
        const o = store.orders.find(x=>x.id===oid); if(!o) return;
        o.items.forEach((it,idx)=> serveItem(oid, idx, (it.qty - (it.served||0))));
      }));

      // BY ITEM (t·ªïng h·ª£p)
      const agg = new Map();
      brewing.forEach(o=>{
        o.items.forEach(it=>{
          const cur = agg.get(it.menuItemId) || {name:it.name,totalQty:0,rows:[]};
          cur.totalQty += (it.qty-(it.served||0));
          cur.rows.push({table:o.table,id:o.id,ts:o.createdAt,qty:(it.qty-(it.served||0)),addonIndex:o.__addonIndex||0});
          agg.set(it.menuItemId, cur);
        });
      });
      const rows = Array.from(agg.entries()).map(([id,v])=>({id,...v})).sort((a,b)=>b.totalQty-a.totalQty);
      els.baristaByItem.innerHTML = rows.map(r=>`
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between"><h4 class="font-semibold">${r.name}</h4><span class="text-sm font-bold">${r.totalQty}</span></div>
          <div class="mt-2 text-xs text-gray-600 space-y-1">
            ${r.rows.map(x=>`<div>${x.table==='TA'?'TA':'B√†n '+x.table} ¬∑ #${shortId(x.id)} ${x.addonIndex>0?'¬∑ B·ªï sung':''} ¬∑ ${fmtTime(x.ts)} ¬∑ √ó${x.qty}</div>`).join('')}
          </div>
        </div>`).join('');

      els.baristaByTable.classList.toggle('hidden', baristaTab!=='by-table');
      els.baristaByItem.classList.toggle('hidden', baristaTab!=='by-item');
    }

    function renderCashier(){
      const { delivered } = getQueues();
      // nh√≥m theo b√†n
      const map = new Map();
      delivered.forEach(o=>{ const list=map.get(o.table)||[]; list.push(o); map.set(o.table,list); });
      const tables = Array.from(map.entries()).sort((a,b)=> (a[0]+'').localeCompare(b[0]+''));

      els.cashierNotPaid.innerHTML = tables.map(([table,orders])=>{
        const amount = orders.reduce((s,o)=>s+calcOrderTotal(o),0);
        const lines = orders.map(o=>`#${shortId(o.id)} (${fmtTime(o.createdAt)}): ${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}`).join('<br/>');
        return `<div class="border rounded-lg p-3 flex items-center justify-between">
          <div>
            <p class="font-semibold">${table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+table} ¬∑ ${orders.length} ƒë∆°n</p>
            <p class="text-xs text-gray-500">${lines}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="font-bold">${money(amount)}</span>
            <button data-pay-table="${table}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Thanh to√°n</button>
          </div>
        </div>`;
      }).join('') || '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</p>';

      els.cashierNotPaid.querySelectorAll('[data-pay-table]').forEach(b=>b.addEventListener('click', e=>{
        const table = e.target.getAttribute('data-pay-table');
        // g·ªôp thanh to√°n: m·ªü modal li·ªát k√™
        const list = store.orders.filter(o=>String(o.table)===String(table) && o.status==='delivered');
        if(!list.length) return;
        els.payTitle.textContent = `Thanh to√°n ¬∑ ${table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+table} (${list.length} ƒë∆°n)`;
        els.payLines.innerHTML = list.map(o=>`
          <div class="border rounded p-2">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">#${shortId(o.id)} ¬∑ ${fmtTime(o.createdAt)}</span>
              <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
            </div>
            <div class="mt-1 space-y-1">
              ${o.items.map(it=>{
                const tops=(it.toppings||[]).map(t=>`(+ ${t.name}√ó${t.qty})`).join(', ');
                return `<div class="flex items-center justify-between">
                  <span>${it.name} √ó ${it.qty} ${tops?'<span class="text-xs text-gray-500">'+tops+'</span>':''}</span>
                  <span class="font-medium">${money(it.price*it.qty)}</span>
                </div>`;
              }).join('')}
            </div>
          </div>`).join('');
        const total = list.reduce((s,o)=>s+calcOrderTotal(o),0);
        els.payTotal.textContent = money(total);
        els.payModal.classList.remove('hidden'); els.payModal.classList.add('flex');
        requestAnimationFrame(()=> els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'));
        els.btnConfirmPay.onclick = ()=>{
          store.orders = store.orders.map(o => (String(o.table)===String(table) && o.status==='delivered'
            ? {...o,status:'paid',timeline:[...(o.timeline||[]),{status:'paid',ts:now()}]} : o));
          saveStore(); closePay(); render();
        };
      }));

      // b·∫£ng doanh thu h√¥m nay
      const paidToday = store.orders.filter(o=>o.status==='paid' && isToday((o.timeline||[]).find(t=>t.status==='paid')?.ts || o.createdAt));
      els.revTodayBody.innerHTML = paidToday.map(o=>{
        const detail = o.items.map(it=>{
          const tops=(it.toppings||[]).map(t=>`+ ${t.name}√ó${t.qty}`).join(', ');
          return `${it.name}√ó${it.qty}${tops? ' ('+tops+')':''}`;
        }).join('; ');
        return `<tr class="border-t">
          <td class="py-2">${fmtTime(o.createdAt)}</td>
          <td class="py-2">${o.table==='TA'?'TA':o.table}</td>
          <td class="py-2">#${shortId(o.id)}</td>
          <td class="py-2">${detail}</td>
          <td class="py-2 text-right font-medium">${money(calcOrderTotal(o))}</td>
        </tr>`;
      }).join('') || `<tr><td colspan="5" class="py-2 text-gray-500">‚Äî</td></tr>`;

      const totalToday = paidToday.reduce((s,o)=>s+calcOrderTotal(o),0);
      els.cashierTotalToday.textContent = `T·ªïng: ${money(totalToday)}`;
    }

    function renderAdmin(){
      els.tablesInput.value = store.tables;
      els.menuTextarea.value = JSON.stringify(store.menu,null,2);
    }

    function render(){
      renderRole();
      if(role==='staff') renderStaff();
      if(role==='barista') renderBarista();
      if(role==='cashier') renderCashier();
      if(role==='admin') renderAdmin();
      saveStore();
    }

    /* ================== EVENTS ================== */
    els.roleSelect.addEventListener('change', e=>{ role=e.target.value; render(); });
    els.btnResetData.addEventListener('click', ()=>{
      if(confirm('Xo√° t·∫•t c·∫£ ƒë∆°n & l√†m m·ªõi?')){ store.orders=[]; saveStore(); render(); }
    });
    els.tableSelect.addEventListener('change', e=>{ tablePicking = e.target.value==='TA'?'TA':Number(e.target.value); renderCart(); });
    els.catFilter.addEventListener('change', renderStaff);
    els.searchInput.addEventListener('input', renderStaff);
    els.btnSubmitOrder.addEventListener('click', ()=>{
      const items = Object.entries(cart).map(([id,ci])=>{
        const mi = store.menu.find(m=>m.id===id);
        if(!mi || ci.qty<=0) return null;
        return { menuItemId:id, name:mi.name, price:mi.price, qty:ci.qty, note:ci.note||'', toppings:(ci.toppings||[]), served:0 };
      }).filter(Boolean);
      if(!items.length) return alert('Gi·ªè h√†ng tr·ªëng');
      const o = { id:newId('ord'), table:(tablePicking==='TA'?'TA':Number(tablePicking)), items, createdAt:now(), status:'queued', timeline:[{status:'queued',ts:now()}] };
      store.orders.push(o); saveStore(); cart={}; render(); toastNewOrders();
    });
    els.tabByTable.addEventListener('click', ()=>{ baristaTab='by-table'; renderBarista(); });
    els.tabByItem.addEventListener('click', ()=>{ baristaTab='by-item'; renderBarista(); });
    [els.btnClosePay, els.btnCancelPay].forEach(b=>b.addEventListener('click', closePay));
    els.btnExportToday.addEventListener('click', ()=>{
      const rows = [['Time','Table','OrderId','Detail','Total']];
      const paid = store.orders.filter(o=>o.status==='paid' && isToday((o.timeline||[]).find(t=>t.status==='paid')?.ts || o.createdAt));
      paid.forEach(o=>{
        const detail = o.items.map(it=>{
          const tops=(it.toppings||[]).map(t=>`+${t.name}x${t.qty}`).join(', ');
          return `${it.name}x${it.qty}${tops? ' ('+tops+')':''}`;
        }).join('; ');
        rows.push([ new Date(o.createdAt).toLocaleString('vi-VN'), (o.table==='TA'?'TA':o.table), '#'+shortId(o.id), detail, calcOrderTotal(o) ]);
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `doanh_thu_${new Date().toISOString().slice(0,10)}.csv`; a.click();
      URL.revokeObjectURL(a.href);
    });

    els.tablesInput?.addEventListener('input', e=>{ const n=Math.max(1,Number(e.target.value)||12); store.tables=n; saveStore(); });

    /* ================== INIT ================== */
    (async()=>{
      // role t·ª´ URL (n·∫øu c√≥)
      const qRole = new URLSearchParams(location.search).get('role');
      if(ROLES.includes((qRole||'').toLowerCase())) role = (qRole||'').toLowerCase();

      // n·∫°p CSV
      await loadCSV();
      // n·∫øu menu v·∫´n tr·ªëng -> t·∫°o m·∫´u nh·ªè ƒë·ªÉ test
      if(!store.menu.length){
        store.menu = [
          {id:'tra_sua_truyen_thong_m', name:'Tr√† s·ªØa Truy·ªÅn th·ªëng (M)', price:18000, category:'Tr√† s·ªØa & Tr√†'},
          {id:'tra_sua_truyen_thong_l', name:'Tr√† s·ªØa Truy·ªÅn th·ªëng (L)', price:23000, category:'Tr√† s·ªØa & Tr√†'},
          {id:'tra_dao_m', name:'Tr√† ƒë√†o (M)', price:20000, category:'Tr√† s·ªØa & Tr√†'},
          {id:'cp_da_m', name:'C√† ph√™ ƒë√° (M)', price:13000, category:'C√† ph√™'},
          {id:'tp_tran_chau', name:'+ Tr√¢n ch√¢u', price:5000, category:'Topping'},
          {id:'tp_thach_sua', name:'+ Th·∫°ch s·ªØa Ph√¥ mai', price:5000, category:'Topping'},
        ];
        saveStore();
      }
      render();
    })();
  </script>
</body>
</html>
