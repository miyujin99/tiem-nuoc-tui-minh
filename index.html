<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-enter{opacity:0;transform:translateY(6px)}
    .modal-enter-active{opacity:1;transform:translateY(0);transition:all .15s ease}
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üßã</span>
        <div>
          <h1 class="text-lg font-bold">Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</h1>
          <p class="text-xs text-gray-500">HTML + Tailwind ¬∑ localStorage / Firebase</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <select id="roleSelect" class="border rounded-lg px-3 py-2 text-sm">
          <option value="staff">Nh√¢n vi√™n (G·ªçi m√≥n)</option>
          <option value="barista">Qu·∫ßy pha ch·∫ø</option>
          <option value="server">Nh√¢n vi√™n giao b√†n</option>
          <option value="cashier">Thu ng√¢n</option>
          <option value="admin">Qu·∫£n l√Ω</option>
        </select>
        <button id="btnResetData" class="text-sm px-3 py-2 border rounded-lg">Reset data</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- STAFF -->
    <section id="view-staff" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-gray-900">Ch·ªçn b√†n & Menu</h2>
              <div class="flex items-center gap-3">
                <select id="tableSelect" class="border rounded-lg px-3 py-2 text-sm"></select>
                <select id="catFilter" class="border rounded-lg px-3 py-2 text-sm"></select>
                <input id="searchInput" class="border rounded-lg px-3 py-2 text-sm w-48" placeholder="T√¨m m√≥n..." />
              </div>
            </div>
            <div id="menuGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </section>
        </div>
        <div class="space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 id="cartTitle" class="text-xl font-semibold text-gray-900 mb-3">Gi·ªè h√†ng</h2>
            <div id="cartList" class="space-y-3 text-sm text-gray-700">Ch∆∞a c√≥ m√≥n.</div>
            <div class="pt-3 mt-2 border-t flex items-center justify-between">
              <span class="font-semibold">T·ªïng</span>
              <span id="cartTotal" class="font-bold">0‚Ç´</span>
            </div>
            <button id="btnSubmitOrder" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-2 mt-3">G·ª≠i order ƒë·∫øn qu·∫ßy pha ch·∫ø</button>
          </section>
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">ƒê∆°n g·∫ßn ƒë√¢y (ch∆∞a thanh to√°n)</h2>
            <div id="recentOrders" class="space-y-2 max-h-80 overflow-auto pr-1"></div>
          </section>
        </div>
      </div>
    </section>

    <!-- BARISTA -->
    <section id="view-barista" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">H√†ng ƒë·ª£i pha ch·∫ø</h2>
          <div class="flex items-center gap-2 text-sm">
            <button id="tabByTable" class="px-3 py-1 rounded-lg border">Xem theo b√†n</button>
            <button id="tabByItem" class="px-3 py-1 rounded-lg border">Xem t·ªïng m√≥n</button>
          </div>
        </div>
        <div id="baristaByTable" class="grid md:grid-cols-2 gap-4"></div>
        <div id="baristaByItem" class="grid md:grid-cols-3 gap-4 hidden"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-2">ƒê√£ s·∫µn s√†ng giao</h2>
        <p class="text-sm text-gray-500">Chuy·ªÉn sang vai tr√≤ "Nh√¢n vi√™n giao b√†n" ƒë·ªÉ x·ª≠ l√Ω giao m√≥n.</p>
      </section>
    </section>

    <!-- SERVER -->
    <section id="view-server" class="hidden grid md:grid-cols-2 gap-6">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">M√≥n ƒë√£ s·∫µn s√†ng</h2>
        <div id="readyList" class="space-y-3"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">ƒê√£ giao ¬∑ ch·ªù thanh to√°n</h2>
        <div id="deliveredList" class="space-y-3"></div>
      </section>
    </section>

    <!-- CASHIER -->
    <section id="view-cashier" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ch·ªù thanh to√°n</h2>
        <div id="cashierNotPaid" class="space-y-3"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900">ƒê√£ thanh to√°n h√¥m nay</h2>
          <span id="cashierTotalToday" class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700"></span>
        </div>
        <div id="cashierPaid" class="grid md:grid-cols-2 gap-3"></div>
      </section>
    </section>

    <!-- ADMIN -->
    <section id="view-admin" class="hidden grid md:grid-cols-2 gap-6">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">C·∫•u h√¨nh qu√°n</h2>
        <label class="text-sm text-gray-700">S·ªë l∆∞·ª£ng b√†n</label>
        <input id="tablesInput" type="number" min="1" class="border rounded-lg px-3 py-2 w-40" />
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Menu (JSON)</h2>
        <textarea id="menuTextarea" class="w-full h-80 border rounded-xl p-3 font-mono text-sm"></textarea>
        <div class="mt-3">
          <button id="btnSaveAdmin" class="px-4 py-2 rounded-lg bg-black text-white">L∆∞u thay ƒë·ªïi</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Pay Modal -->
  <div id="payModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-5 modal-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 id="payTitle" class="text-lg font-semibold">Thanh to√°n</h3>
        <button id="btnClosePay" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div id="payLines" class="space-y-2"></div>
      <div class="pt-2 mt-2 border-t flex items-center justify-between">
        <span class="font-semibold">T·ªïng</span>
        <span id="payTotal" class="font-bold">0‚Ç´</span>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelPay" class="px-4 py-2 rounded-lg border">ƒê√≥ng</button>
        <button id="btnConfirmPay" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'tiemnuoctuiminh_pos_v1_html';
    const seedMenu = [
      { id:'mt-truyen-thong', name:'Tr√† s·ªØa truy·ªÅn th·ªëng', price:32000, category:'Milk Tea' },
      { id:'mt-matcha', name:'Matcha s·ªØa', price:38000, category:'Milk Tea' },
      { id:'mt-olong', name:'Oolong s·ªØa', price:36000, category:'Milk Tea' },
      { id:'tea-dao', name:'H·ªìng tr√† ƒë√†o', price:35000, category:'Tea' },
      { id:'tea-vai', name:'Tr√† v·∫£i', price:35000, category:'Tea' },
      { id:'macchiato-oolong', name:'Oolong macchiato', price:42000, category:'Cheese' },
      { id:'yq-sugarcane', name:'N∆∞·ªõc m√≠a t·∫Øc', price:25000, category:'Fresh' },
      { id:'topping-tranchau', name:'+ Tr√¢n ch√¢u', price:5000, category:'Topping' },
      { id:'topping-thach', name:'+ Th·∫°ch tr√°i c√¢y', price:6000, category:'Topping' },
    ];

    const els = {
      roleSelect: document.getElementById('roleSelect'),
      btnResetData: document.getElementById('btnResetData'),
      views: {
        staff: document.getElementById('view-staff'),
        barista: document.getElementById('view-barista'),
        server: document.getElementById('view-server'),
        cashier: document.getElementById('view-cashier'),
        admin: document.getElementById('view-admin'),
      },
      tableSelect: document.getElementById('tableSelect'),
      catFilter: document.getElementById('catFilter'),
      searchInput: document.getElementById('searchInput'),
      menuGrid: document.getElementById('menuGrid'),
      cartTitle: document.getElementById('cartTitle'),
      cartList: document.getElementById('cartList'),
      cartTotal: document.getElementById('cartTotal'),
      btnSubmitOrder: document.getElementById('btnSubmitOrder'),
      recentOrders: document.getElementById('recentOrders'),
      tabByTable: document.getElementById('tabByTable'),
      tabByItem: document.getElementById('tabByItem'),
      baristaByTable: document.getElementById('baristaByTable'),
      baristaByItem: document.getElementById('baristaByItem'),
      readyList: document.getElementById('readyList'),
      deliveredList: document.getElementById('deliveredList'),
      cashierNotPaid: document.getElementById('cashierNotPaid'),
      cashierPaid: document.getElementById('cashierPaid'),
      cashierTotalToday: document.getElementById('cashierTotalToday'),
      tablesInput: document.getElementById('tablesInput'),
      menuTextarea: document.getElementById('menuTextarea'),
      btnSaveAdmin: document.getElementById('btnSaveAdmin'),
      payModal: document.getElementById('payModal'),
      payTitle: document.getElementById('payTitle'),
      payLines: document.getElementById('payLines'),
      payTotal: document.getElementById('payTotal'),
      btnClosePay: document.getElementById('btnClosePay'),
      btnCancelPay: document.getElementById('btnCancelPay'),
      btnConfirmPay: document.getElementById('btnConfirmPay'),
    };

    function money(n){ return n.toLocaleString('vi-VN')+'‚Ç´'; }
    function now(){ return Date.now(); }
    function newId(prefix){ return prefix+'_'+Math.random().toString(36).slice(2,9); }
    function calcPriority(items){ return items.reduce((s,it)=>s+it.qty,0); }

    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { menu: seedMenu, orders: [], tables: 20 };
        const parsed = JSON.parse(raw);
        return { menu: parsed.menu||seedMenu, orders: parsed.orders||[], tables: parsed.tables||20 };
      }catch{ return { menu: seedMenu, orders: [], tables: 20 }; }
    }

    // Khi d√πng Firebase, ch·ªâ l∆∞u menu/tables v√†o local ƒë·ªÉ tr√°nh v√≤ng l·∫∑p & nh·∫•p nh√°y
    function saveLocalOnly(){
      const shadow = { menu: store.menu, orders: [], tables: store.tables };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(shadow));
      if(bc) bc.postMessage({ type:'store:update', store: shadow });
    }

    let store = loadStore();
    window.store = store;
    let cart = {};
    let role = 'staff';
    let baristaTab = 'by-table';
    let tablePicking = 1;
    let viewingOrderId = null;

    // Sync n·ªôi b·ªô tab
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('tiem_nuoc_tui_minh_sync') : null;
    if(bc){ bc.addEventListener('message', e=>{ if(e?.data?.type==='store:update'){ store = {...store, ...e.data.store}; render(); } }); }

    // Role t·ª´ URL / phi√™n
    const urlRole = new URLSearchParams(location.search).get('role');
    if(urlRole) role = urlRole;
    try{ const savedRole = sessionStorage.getItem('tn_role'); if(savedRole) role = savedRole; }catch{}
    function persistRole(){ try{ sessionStorage.setItem('tn_role', role); }catch{} }

    function setRole(r){ role = r; persistRole(); render(); }
    function statusLabel(s){ return ({queued:'Ch·ªù pha',brewing:'ƒêang pha',ready:'S·∫µn s√†ng',delivered:'ƒê√£ giao',paid:'ƒê√£ thanh to√°n'})[s]||s; }
    function calcOrderTotal(o){ return o.items.reduce((t,it)=>t+it.price*it.qty,0); }

    function getQueues(){
      const notPaid = store.orders.filter(o=>o.status!=='paid');
      const brewing = notPaid.filter(o=>['queued','brewing'].includes(o.status))
        .sort((a,b)=> (b.priority-b.priority)||(a.createdAt-b.createdAt));
      const ready = notPaid.filter(o=>o.status==='ready').sort((a,b)=>a.createdAt-b.createdAt);
      const delivered = notPaid.filter(o=>o.status==='delivered').sort((a,b)=>a.createdAt-b.createdAt);
      return { brewing, ready, delivered, notPaid };
    }

    // --- Mutations ---
    function setStatus(orderId, status){
      if(window.firebaseApi?.ready){
        const o = store.orders.find(x=>x.id===orderId); if(!o) return;
        const timeline = [...o.timeline, {status, ts: now()}];
        window.firebaseApi.updateStatus(orderId, status, timeline).then(ok=>{
          if(!ok) alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i l√™n cloud');
        });
        return;
      }
      store.orders = store.orders.map(o=> o.id===orderId ? {...o, status, timeline:[...o.timeline,{status,ts:now()}]} : o);
      saveLocalOnly(); render();
    }
    function payOrder(orderId){ setStatus(orderId,'paid'); closePay(); }

    function resetData(){
      if(!confirm('Xo√° to√†n b·ªô ƒë∆°n h√†ng?')) return;
      cart = {};
      store.orders = [];
      if(window.firebaseApi?.ready){
        window.firebaseApi.clearAllOrders().then(()=>{
          saveLocalOnly(); render();
        });
      }else{
        saveLocalOnly(); render();
      }
    }

    // Staff actions
    function addToCart(id){ cart[id]=(cart[id]||0)+1; renderStaff(); }
    function decFromCart(id){ if(!cart[id]) return; cart[id]=Math.max(0,cart[id]-1); if(!cart[id]) delete cart[id]; renderStaff(); }

    function submitOrder(){
      const items = Object.entries(cart).map(([id,qty])=>{
        const mi = store.menu.find(m=>m.id===id);
        return mi && qty>0 ? {menuItemId:id,name:mi.name,price:mi.price,qty} : null;
      }).filter(Boolean);
      if(items.length===0) return alert('Gi·ªè h√†ng tr·ªëng');

      const order = { id:newId('ord'), table:tablePicking, items, priority:calcPriority(items), createdAt:now(), status:'queued', timeline:[{status:'queued',ts:now()}] };

      if(window.firebaseApi?.ready){
        window.firebaseApi.pushOrder(order).then(ok=>{
          if(!ok) return alert('Kh√¥ng th·ªÉ g·ª≠i ƒë∆°n l√™n cloud');
          cart={}; render();
          alert(`ƒê√£ g·ª≠i ƒë∆°n cho b√†n ${tablePicking}`);
        });
        return;
      }
      store.orders.push(order); cart={}; saveLocalOnly(); alert(`ƒê√£ g·ª≠i ƒë∆°n cho b√†n ${tablePicking}`); render();
    }

    // Pay modal
    function openPay(id){
      viewingOrderId = id;
      const o = store.orders.find(x=>x.id===id); if(!o) return;
      els.payTitle.textContent = `Thanh to√°n ¬∑ B√†n ${o.table}`;
      els.payLines.innerHTML = o.items.map(it=>`
        <div class="flex items-center justify-between"><span>${it.name} √ó ${it.qty}</span><span class="font-medium">${money(it.price*it.qty)}</span></div>`).join('');
      els.payTotal.textContent = money(calcOrderTotal(o));
      els.payModal.classList.remove('hidden');
      requestAnimationFrame(()=>{ els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'); });
    }
    function closePay(){ viewingOrderId=null; els.payModal.classList.add('hidden'); }

    // --- Renderers ---
    function renderRole(){
      Object.values(els.views).forEach(v=>v.classList.add('hidden'));
      els.views[role].classList.remove('hidden');
      els.roleSelect.value = role;
    }

    function renderStaff(){
      els.tableSelect.innerHTML = Array.from({length:store.tables}).map((_,i)=>`<option value="${i+1}">B√†n ${i+1}</option>`).join('');
      els.tableSelect.value = String(tablePicking);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ B√†n ${tablePicking}`;

      const cats = ['All',...new Set(store.menu.map(m=>m.category))];
      els.catFilter.innerHTML = cats.map(c=>`<option value="${c}">${c}</option>`).join('');

      const kw = (els.searchInput.value||'').toLowerCase();
      const cat = els.catFilter.value || 'All';
      const list = store.menu.filter(m => (cat==='All'||m.category===cat) && (!kw||m.name.toLowerCase().includes(kw)));

      els.menuGrid.innerHTML = list.map(m=>`
        <div class="border rounded-xl p-4 hover:shadow-sm">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold text-gray-900">${m.name}</h3>
              <p class="text-sm text-gray-500">${m.category}</p>
            </div>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${money(m.price)}</span>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button data-dec="${m.id}" class="px-2 py-1 border rounded">-</button>
              <span class="w-8 text-center">${cart[m.id]||0}</span>
              <button data-inc="${m.id}" class="px-2 py-1 border rounded">+</button>
            </div>
            <button data-add="${m.id}" class="px-3 py-1 rounded-lg bg-black text-white text-sm">Th√™m</button>
          </div>
        </div>`).join('');

      els.menuGrid.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',e=>addToCart(e.target.getAttribute('data-inc'))));
      els.menuGrid.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',e=>decFromCart(e.target.getAttribute('data-dec'))));
      els.menuGrid.querySelectorAll('[data-add]').forEach(b=>b.addEventListener('click',e=>addToCart(e.target.getAttribute('data-add'))));

      renderCart();

      const listRecent = store.orders.filter(o=>o.status!=='paid').sort((a,b)=>b.createdAt-a.createdAt).slice(0,8);
      els.recentOrders.innerHTML = listRecent.map(o=>`
        <div class="flex items-center justify-between border rounded-lg p-3">
          <div>
            <p class="font-medium">B√†n ${o.table}</p>
            <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
        </div>`).join('');
    }

    function renderCart(){
      const entries = Object.entries(cart);
      if(entries.length===0){ els.cartList.textContent='Ch∆∞a c√≥ m√≥n.'; els.cartTotal.textContent='0‚Ç´'; return; }
      els.cartList.innerHTML = entries.map(([id,qty])=>{
        const mi = store.menu.find(m=>m.id===id); if(!mi) return '';
        return `<div class="flex items-center justify-between">
          <div><p class="font-medium">${mi.name}</p><p class="text-xs text-gray-500">${money(mi.price)} √ó ${qty}</p></div>
          <div class="flex items-center gap-2">
            <button data-dec-cart="${id}" class="px-2 py-1 border rounded">-</button>
            <span class="w-6 text-center">${qty}</span>
            <button data-inc-cart="${id}" class="px-2 py-1 border rounded">+</button>
          </div></div>`;
      }).join('');
      els.cartList.querySelectorAll('[data-dec-cart]').forEach(b=>b.addEventListener('click',e=>decFromCart(e.target.getAttribute('data-dec-cart'))));
      els.cartList.querySelectorAll('[data-inc-cart]').forEach(b=>b.addEventListener('click',e=>addToCart(e.target.getAttribute('data-inc-cart'))));

      const total = entries.reduce((t,[id,qty])=>{ const mi=store.menu.find(m=>m.id===id); return t+(mi?mi.price*qty:0); },0);
      els.cartTotal.textContent = money(total);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ B√†n ${tablePicking}`;
    }

    function renderBarista(){
      els.tabByTable.classList.toggle('bg-black', baristaTab==='by-table');
      els.tabByTable.classList.toggle('text-white', baristaTab==='by-table');
      els.tabByItem.classList.toggle('bg-black', baristaTab==='by-item');
      els.tabByItem.classList.toggle('text-white', baristaTab==='by-item');

      const { brewing } = getQueues();
      const group = new Map();
      brewing.forEach(o=>{ const arr=group.get(o.table)||[]; arr.push(o); group.set(o.table,arr); });
      const entries = [...group.entries()].sort((a,b)=>a[0]-b[0]);

      els.baristaByTable.innerHTML = entries.map(([table,orders])=>`
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">B√†n ${table}</h3>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${orders.length} ƒë∆°n</span>
          </div>
          <div class="space-y-3">
            ${orders.map(o=>`
              <div class="border rounded-lg p-3">
                <div class="flex items-center justify-between">
                  <p class="text-sm text-gray-500">#${o.id.slice(-4)} ¬∑ ∆Øu ti√™n ${o.priority}</p>
                  <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
                </div>
                <ul class="mt-2 text-sm list-disc list-inside">
                  ${o.items.map(it=>`<li>${it.name} √ó ${it.qty}</li>`).join('')}
                </ul>
                <div class="mt-3 flex gap-2">
                  ${o.status==='queued' ? `<button data-start="${o.id}" class="px-3 py-1 rounded-lg bg-amber-600 text-white">B·∫Øt ƒë·∫ßu pha</button>`:''}
                  ${o.status==='brewing' ? `<button data-ready="${o.id}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Ho√†n th√†nh</button>`:''}
                </div>
              </div>`).join('')}
          </div>
        </div>`).join('');

      els.baristaByTable.querySelectorAll('[data-start]').forEach(b=>b.addEventListener('click',e=>setStatus(e.target.getAttribute('data-start'),'brewing')));
      els.baristaByTable.querySelectorAll('[data-ready]').forEach(b=>b.addEventListener('click',e=>setStatus(e.target.getAttribute('data-ready'),'ready')));

      const agg = new Map();
      brewing.forEach(o=>o.items.forEach(it=>{ const v=agg.get(it.menuItemId)||{name:it.name,totalQty:0}; v.totalQty+=it.qty; agg.set(it.menuItemId,v); }));
      const rows = [...agg.entries()].map(([id,v])=>({id,name:v.name,totalQty:v.totalQty}));
      els.baristaByItem.innerHTML = rows.map(r=>`
        <div class="border rounded-xl p-4"><h4 class="font-semibold">${r.name}</h4>
        <p class="text-3xl font-bold mt-2">${r.totalQty}</p>
        <p class="text-xs text-gray-500 mt-1">T·ªïng s·ªë ly c·∫ßn l√†m</p></div>`).join('');

      els.baristaByTable.classList.toggle('hidden',baristaTab!=='by-table');
      els.baristaByItem.classList.toggle('hidden',baristaTab!=='by-item');
    }

    function renderServer(){
      const {ready,delivered} = getQueues();
      els.readyList.innerHTML = ready.map(o=>`
        <div class="border rounded-lg p-3 flex items-center justify-between">
          <div><p class="font-medium">B√†n ${o.table}</p>
          <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p></div>
          <button data-deliver="${o.id}" class="px-3 py-1 rounded-lg bg-indigo-600 text-white">ƒê√£ giao</button>
        </div>`).join('') || '<p class="text-sm text-gray-500">Ch∆∞a c√≥ m√≥n s·∫µn s√†ng.</p>';
      els.readyList.querySelectorAll('[data-deliver]').forEach(b=>b.addEventListener('click',e=>setStatus(e.target.getAttribute('data-deliver'),'delivered')));

      els.deliveredList.innerHTML = delivered.map(o=>`
        <div class="border rounded-lg p-3 flex items-center justify-between">
          <div><p class="font-medium">B√†n ${o.table}</p>
          <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p></div>
          <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">Ch·ªù thanh to√°n</span>
        </div>`).join('') || '<p class="text-sm text-gray-500">‚Äî</p>';
    }

    function renderCashier(){
      const notPaid = store.orders.filter(o=>o.status!=='paid');
      const paid = store.orders.filter(o=>o.status==='paid');
      els.cashierNotPaid.innerHTML = notPaid.map(o=>`
        <div class="border rounded-lg p-3 flex items-center justify-between">
          <div><p class="font-semibold">B√†n ${o.table} ¬∑ #${o.id.slice(-4)}</p>
          <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p></div>
          <div class="flex items-center gap-3">
            <span class="font-bold">${money(calcOrderTotal(o))}</span>
            <button data-pay="${o.id}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Thanh to√°n</button>
          </div>
        </div>`).join('') || '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</p>';
      els.cashierNotPaid.querySelectorAll('[data-pay]').forEach(b=>b.addEventListener('click',e=>openPay(e.target.getAttribute('data-pay'))));

      const paidCards = paid.slice().reverse().map(o=>`
        <div class="border rounded-lg p-3">
          <div class="flex items-center justify-between">
            <p class="font-semibold">B√†n ${o.table}</p>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">#${o.id.slice(-4)}</span>
          </div>
          <ul class="mt-2 text-sm list-disc list-inside">
            ${o.items.map(it=>`<li>${it.name} √ó ${it.qty} ‚Äî ${money(it.price*it.qty)}</li>`).join('')}
          </ul>
          <div class="pt-2 mt-2 border-t flex items-center justify-between">
            <span class="font-semibold">T·ªïng</span>
            <span class="font-bold">${money(calcOrderTotal(o))}</span>
          </div>
        </div>`).join('');
      els.cashierPaid.innerHTML = paidCards || '<p class="text-sm text-gray-500">‚Äî</p>';

      const totalToday = paid.reduce((s,o)=>s+calcOrderTotal(o),0);
      els.cashierTotalToday.textContent = `T·ªïng: ${money(totalToday)}`;
    }

    function renderAdmin(){
      els.tablesInput.value = store.tables;
      els.menuTextarea.value = JSON.stringify(store.menu,null,2);
    }

    function render(){
      window.store = store;
      window.render = render;
      renderRole();
      if(role==='staff') renderStaff();
      if(role==='barista') renderBarista();
      if(role==='server') renderServer();
      if(role==='cashier') renderCashier();
      if(role==='admin') renderAdmin();
      // khi realtime b·∫≠t: ch·ªâ l∆∞u menu/tables (tr√°nh flicker)
      saveLocalOnly();
    }

    // Events
    els.roleSelect.addEventListener('change', e=>setRole(e.target.value));
    if(new URLSearchParams(location.search).get('role')){
      els.roleSelect.setAttribute('disabled','disabled');
      els.roleSelect.classList.add('opacity-60','cursor-not-allowed');
    }
    els.btnResetData.addEventListener('click', resetData);

    els.tableSelect.addEventListener('change', e=>{ tablePicking=Number(e.target.value); renderCart(); });
    els.catFilter.addEventListener('change', ()=>renderStaff());
    els.searchInput.addEventListener('input', ()=>renderStaff());
    els.btnSubmitOrder.addEventListener('click', submitOrder);

    els.tabByTable.addEventListener('click', ()=>{ baristaTab='by-table'; renderBarista(); });
    els.tabByItem.addEventListener('click', ()=>{ baristaTab='by-item'; renderBarista(); });

    [els.btnClosePay, els.btnCancelPay].forEach(b=>b.addEventListener('click', closePay));
    els.btnConfirmPay.addEventListener('click', ()=>{ if(viewingOrderId) payOrder(viewingOrderId); });

    els.btnSaveAdmin.addEventListener('click', ()=>{
      try{
        const parsed = JSON.parse(els.menuTextarea.value);
        if(!Array.isArray(parsed)) throw new Error('Menu ph·∫£i l√† m·∫£ng items');
        store.menu = parsed; store.tables = Math.max(1, Number(els.tablesInput.value)||20);
        alert('ƒê√£ l∆∞u c·∫•u h√¨nh'); render();
      }catch(e){ alert('Menu kh√¥ng h·ª£p l·ªá: '+e.message); }
    });

    render();
  </script>

  <!-- === FIREBASE (ƒë√£ c·∫•u h√¨nh) === -->
  <script type="module">
    // C·∫•u h√¨nh c·ªßa b·∫°n
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyC5g01aNIwU6Ysa5zsW2ahBmR_wiAHSc-0",
      authDomain: "tiem-nuoc-tui-minh.firebaseapp.com",
      databaseURL: "https://tiem-nuoc-tui-minh-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tiem-nuoc-tui-minh",
      appId: "1:599673062211:web:2ac6b038d1b17c6130a5f6"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import { getDatabase, ref, onValue, push, set, update } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';

    const hasConfig = !!(window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey);

    const firebaseApi = {
      app:null, db:null, auth:null, user:null, ordersRef:null, ready:false,
      lastHash:null, // ƒë·ªÉ tr√°nh render l·∫∑p
      async init(){
        if(!hasConfig){ console.info('[Firebase] No config ‚Üí local only'); return; }
        try{
          this.app = initializeApp(window.FIREBASE_CONFIG);
          this.db = getDatabase(this.app);
          this.auth = getAuth(this.app);
          await signInAnonymously(this.auth);
          onAuthStateChanged(this.auth,(u)=>{ this.user=u||null; });
          this.ordersRef = ref(this.db,'orders');
          this.ready = true;
          console.info('[Firebase] READY');
        }catch(err){
          console.error('[Firebase] init error:',err);
          this.ready=false;
        }
      },
      subscribeOrders(cb){
        if(!this.ready) return;
        onValue(this.ordersRef,(snap)=>{
          const val = snap.val() || {};
          const arr = Object.entries(val).map(([id,data])=>({id,...data}))
            .sort((a,b)=>a.createdAt-b.createdAt);
          const h = JSON.stringify(arr.map(o=>[o.id,o.status,o.timeline?.length||0]));
          if(h!==this.lastHash){ this.lastHash=h; cb(arr); } // ch·ªâ render khi kh√°c
        });
      },
      async pushOrder(order){
        if(!this.ready) return false;
        try{
          const r = push(this.ordersRef);
          await set(r,{...order,id:r.key});
          return true;
        }catch(e){ console.error(e); return false; }
      },
      async updateStatus(orderId,status,timeline){
        if(!this.ready) return false;
        try{ await update(ref(this.db,`orders/${orderId}`),{status,timeline}); return true; }
        catch(e){ console.error(e); return false; }
      },
      async clearAllOrders(){
        if(!this.ready) return false;
        try{ await set(this.ordersRef,null); this.lastHash=null; return true; }
        catch(e){ console.error(e); return false; }
      }
    };

    window.firebaseApi = firebaseApi;

    (async()=>{
      await firebaseApi.init();
      if(firebaseApi.ready){
        firebaseApi.subscribeOrders((orders)=>{
          try{
            window.store.orders = orders;
            if(typeof window.render === 'function') window.render();
          }catch(e){ console.error(e); }
        });
      }
    })();
  </script>
</body>
</html>
