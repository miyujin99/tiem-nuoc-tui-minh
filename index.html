<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS + Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .modal-enter{opacity:0;transform:translateY(6px)}
    .modal-enter-active{opacity:1;transform:translateY(0);transition:all .15s ease}
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üßã</span>
        <div>
          <h1 class="text-lg font-bold">Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</h1>
          <p class="text-xs text-gray-500">HTML + Tailwind ¬∑ Firebase Realtime</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <select id="roleSelect" class="border rounded-lg px-3 py-2 text-sm">
          <option value="staff">Nh√¢n vi√™n (G·ªçi m√≥n)</option>
          <option value="barista">Qu·∫ßy pha ch·∫ø</option>
          <option value="server">Nh√¢n vi√™n giao b√†n</option>
          <option value="cashier">Thu ng√¢n</option>
          <option value="admin">Qu·∫£n l√Ω</option>
        </select>
        <button id="btnResetData" class="text-sm px-3 py-2 border rounded-lg">Reset ƒë∆°n</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- STAFF -->
    <section id="view-staff" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-gray-900">Ch·ªçn b√†n & Menu</h2>
              <div class="flex items-center gap-3">
                <select id="tableSelect" class="border rounded-lg px-3 py-2 text-sm"></select>
                <select id="catFilter" class="border rounded-lg px-3 py-2 text-sm"></select>
                <input id="searchInput" class="border rounded-lg px-3 py-2 text-sm w-48" placeholder="T√¨m m√≥n..." />
              </div>
            </div>
            <div id="menuGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </section>
        </div>
        <div class="space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 id="cartTitle" class="text-xl font-semibold text-gray-900 mb-3">Gi·ªè h√†ng</h2>
            <div id="cartList" class="space-y-3 text-sm text-gray-700">Ch∆∞a c√≥ m√≥n.</div>
            <div class="pt-3 mt-2 border-t flex items-center justify-between">
              <span class="font-semibold">T·ªïng</span>
              <span id="cartTotal" class="font-bold">0‚Ç´</span>
            </div>
            <button id="btnSubmitOrder" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-2 mt-3">G·ª≠i order ƒë·∫øn qu·∫ßy pha ch·∫ø</button>
          </section>
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">ƒê∆°n g·∫ßn ƒë√¢y (ch∆∞a thanh to√°n)</h2>
            <div id="recentOrders" class="space-y-2 max-h-80 overflow-auto pr-1"></div>
          </section>
        </div>
      </div>
    </section>

    <!-- BARISTA -->
    <section id="view-barista" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">H√†ng ƒë·ª£i pha ch·∫ø</h2>
          <div class="flex items-center gap-2 text-sm">
            <button id="tabByTable" class="px-3 py-1 rounded-lg border">Xem theo b√†n</button>
            <button id="tabByItem" class="px-3 py-1 rounded-lg border">Xem t·ªïng m√≥n</button>
          </div>
        </div>
        <div id="baristaByTable" class="grid md:grid-cols-2 gap-4"></div>
        <div id="baristaByItem" class="grid md:grid-cols-3 gap-4 hidden"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-2">ƒê√£ s·∫µn s√†ng giao</h2>
        <p class="text-sm text-gray-500">Chuy·ªÉn sang vai tr√≤ "Nh√¢n vi√™n giao b√†n" ƒë·ªÉ x·ª≠ l√Ω giao m√≥n.</p>
      </section>
    </section>

    <!-- SERVER -->
    <section id="view-server" class="hidden grid md:grid-cols-2 gap-6">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">M√≥n ƒë√£ s·∫µn s√†ng</h2>
        <div id="readyList" class="space-y-3"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">ƒê√£ giao ¬∑ ch·ªù thanh to√°n</h2>
        <div id="deliveredList" class="space-y-3"></div>
      </section>
    </section>

    <!-- CASHIER -->
    <section id="view-cashier" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ch·ªù thanh to√°n</h2>
        <div id="cashierNotPaid" class="space-y-3"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900">ƒê√£ thanh to√°n h√¥m nay</h2>
          <span id="cashierTotalToday" class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700"></span>
        </div>
        <div id="cashierPaid" class="grid md:grid-cols-2 gap-3"></div>
      </section>

      <!-- Revenue table + export -->
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900">B√°o c√°o doanh thu h√¥m nay</h2>
          <button id="btnExportToday" class="px-3 py-1 rounded-lg border">T·∫£i CSV</button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-gray-600">
                <th class="py-2">Th·ªùi gian</th>
                <th class="py-2">B√†n</th>
                <th class="py-2">M√£ ƒë∆°n</th>
                <th class="py-2">Chi ti·∫øt</th>
                <th class="py-2 text-right">T·ªïng</th>
              </tr>
            </thead>
            <tbody id="revTodayBody"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- ADMIN + DASHBOARD -->
    <section id="view-admin" class="hidden grid md:grid-cols-2 gap-6">
      <!-- Dashboard -->
      <section class="bg-white rounded-2xl shadow-sm border p-5 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Dashboard (Realtime)</h2>
          <span class="text-xs text-gray-500">T·ª± c·∫≠p nh·∫≠t</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">T·ªïng ƒë∆°n h√†ng</p>
            <p id="kpiOrders" class="text-3xl font-bold">‚Äî</p>
          </div>
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">Dung l∆∞·ª£ng ∆∞·ªõc t√≠nh</p>
            <p class="text-lg font-semibold"><span id="kpiStorage">‚Äî</span> <span class="text-xs text-gray-500">/ 1 GB</span></p>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2"><div id="kpiStorageBar" class="h-2 rounded-full bg-emerald-500" style="width:0%"></div></div>
            <p id="kpiStoragePct" class="text-xs text-gray-500 mt-1">0%</p>
          </div>
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">Thi·∫øt b·ªã ƒëang online</p>
            <p id="kpiOnline" class="text-3xl font-bold">‚Äî</p>
          </div>
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">∆Ø·ªõc t√≠nh t·∫£i xu·ªëng / th√°ng</p>
            <p class="text-lg font-semibold"><span id="kpiBandwidth">‚Äî</span> <span class="text-xs text-gray-500">/ 10 GB</span></p>
            <div class="mt-2 w-full bg-gray-100 rounded-full h-2"><div id="kpiBandwidthBar" class="h-2 rounded-full bg-indigo-500" style="width:0%"></div></div>
            <p id="kpiBandwidthPct" class="text-xs text-gray-500 mt-1">0%</p>
          </div>
        </div>
      </section>

      <!-- Config -->
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">C·∫•u h√¨nh qu√°n</h2>
        <label class="text-sm text-gray-700">S·ªë l∆∞·ª£ng b√†n</label>
        <input id="tablesInput" type="number" min="1" class="border rounded-lg px-3 py-2 w-40" />
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Menu (JSON)</h2>
        <textarea id="menuTextarea" class="w-full h-80 border rounded-xl p-3 font-mono text-sm"></textarea>
        <div class="mt-3">
          <button id="btnSaveAdmin" class="px-4 py-2 rounded-lg bg-black text-white">L∆∞u thay ƒë·ªïi</button>
        </div>
      </section>
    </section>
  </main>

  <!-- Pay Modal -->
  <div id="payModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-5 modal-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 id="payTitle" class="text-lg font-semibold">Thanh to√°n</h3>
        <button id="btnClosePay" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div id="payLines" class="space-y-2"></div>
      <div class="pt-2 mt-2 border-t flex items-center justify-between">
        <span class="font-semibold">T·ªïng</span>
        <span id="payTotal" class="font-bold">0‚Ç´</span>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelPay" class="px-4 py-2 rounded-lg border">ƒê√≥ng</button>
        <button id="btnConfirmPay" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </div>
  </div>

  <!-- Toast host + sound -->
  <div id="toastHost" class="fixed top-3 left-3 z-50 space-y-2"></div>
  <audio id="newOrderSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script>
    // ===== CSV MENU =====
    const CSV_PATH = 'assets/menu.csv'; // columns: Category,Item,Size,Price (+Topping rows)
    function slugify(str){
      return String(str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/[^a-zA-Z0-9\\s-]/g,'').trim().replace(/\\s+/g,'_').toLowerCase();
    }
    function parsePrice(v){ if(typeof v==='number') return v; const s=String(v||'').replace(/[^\\d]/g,''); return s?Number(s):0; }
    function rowToMenuItem(row){
      const category = (row.Category||'Other').toString().trim();
      const baseName = (row.Item||'').toString().trim(); if(!baseName) return null;
      const size = (row.Size||'').toString().trim();
      const name = size ? \`\${baseName} (\${size})\` : baseName;
      const price = parsePrice(row.Price);
      const id = slugify(name)||('itm_'+Math.random().toString(36).slice(2,8));
      return { id, name, price, category };
    }
    async function fetchCSVMenu(){
      const res = await fetch(CSV_PATH, { cache:'no-store' }); const text = await res.text();
      const parsed = Papa.parse(text, { header:true, skipEmptyLines:true });
      const rows = Array.isArray(parsed.data) ? parsed.data : [];
      return rows.map(rowToMenuItem).filter(Boolean);
    }

    // ===== CORE HELPERS =====
    const STORAGE_KEY = 'tiemnuoctuiminh_pos_v1_html';
    function money(n){ return n.toLocaleString('vi-VN')+'‚Ç´'; }
    function now(){ return Date.now(); }
    function newId(prefix){ return prefix+'_'+Math.random().toString(36).slice(2,9); }
    function calcPriority(items){ return items.reduce((s,it)=>s+it.qty,0); }
    function shortId(id){ return id ? id.slice(-4) : ''; }
    function fmtTime(ts){ try{ return new Date(ts).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); } catch{ return ''; } }
    function isToday(ts){ const d=new Date(ts), t=new Date(); return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate(); }

    // local shadow (menu,tables) ƒë·ªÉ load nhanh
    function loadStore(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return { menu: [], orders: [], tables: 20 };
        const parsed = JSON.parse(raw);
        return { menu: parsed.menu||[], orders: [], tables: parsed.tables||20 };
      }catch{ return { menu: [], orders: [], tables: 20 }; }
    }
    function saveLocalOnly(){
      const shadow = { menu: store.menu, orders: [], tables: store.tables };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(shadow));
      if(bc) bc.postMessage({ type:'store:update', store: shadow });
    }

    const els = {
      roleSelect: document.getElementById('roleSelect'),
      btnResetData: document.getElementById('btnResetData'),
      views: {
        staff: document.getElementById('view-staff'),
        barista: document.getElementById('view-barista'),
        server: document.getElementById('view-server'),
        cashier: document.getElementById('view-cashier'),
        admin: document.getElementById('view-admin'),
      },
      tableSelect: document.getElementById('tableSelect'),
      catFilter: document.getElementById('catFilter'),
      searchInput: document.getElementById('searchInput'),
      menuGrid: document.getElementById('menuGrid'),
      cartTitle: document.getElementById('cartTitle'),
      cartList: document.getElementById('cartList'),
      cartTotal: document.getElementById('cartTotal'),
      btnSubmitOrder: document.getElementById('btnSubmitOrder'),
      recentOrders: document.getElementById('recentOrders'),
      tabByTable: document.getElementById('tabByTable'),
      tabByItem: document.getElementById('tabByItem'),
      baristaByTable: document.getElementById('baristaByTable'),
      baristaByItem: document.getElementById('baristaByItem'),
      readyList: document.getElementById('readyList'),
      deliveredList: document.getElementById('deliveredList'),
      cashierNotPaid: document.getElementById('cashierNotPaid'),
      cashierPaid: document.getElementById('cashierPaid'),
      cashierTotalToday: document.getElementById('cashierTotalToday'),
      tablesInput: document.getElementById('tablesInput'),
      menuTextarea: document.getElementById('menuTextarea'),
      btnSaveAdmin: document.getElementById('btnSaveAdmin'),
      payModal: document.getElementById('payModal'),
      payTitle: document.getElementById('payTitle'),
      payLines: document.getElementById('payLines'),
      payTotal: document.getElementById('payTotal'),
      btnClosePay: document.getElementById('btnClosePay'),
      btnCancelPay: document.getElementById('btnCancelPay'),
      btnConfirmPay: document.getElementById('btnConfirmPay'),
      // kpi
      kpiOrders: document.getElementById('kpiOrders'),
      kpiStorage: document.getElementById('kpiStorage'),
      kpiStorageBar: document.getElementById('kpiStorageBar'),
      kpiStoragePct: document.getElementById('kpiStoragePct'),
      kpiOnline: document.getElementById('kpiOnline'),
      kpiBandwidth: document.getElementById('kpiBandwidth'),
      kpiBandwidthBar: document.getElementById('kpiBandwidthBar'),
      kpiBandwidthPct: document.getElementById('kpiBandwidthPct'),
    };

    let store = loadStore();
    window.store = store;
    // cart: { [menuId]: { qty, note, toppings: [{id,name,price,qty}] } }
    let cart = {};
    function ensureCartItem(id){ if(!cart[id]) cart[id]={qty:0,note:'',toppings:[]}; return cart[id]; }
    let role = 'staff';
    let baristaTab = 'by-table';
    let tablePicking = 1;
    let viewingOrderId = null;

    // BroadcastChannel sync c√πng thi·∫øt b·ªã
    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('tiem_nuoc_tui_minh_sync') : null;
    if(bc){
      bc.addEventListener('message', e=>{
        if(e?.data?.type==='store:update'){
          store = { ...store, ...e.data.store };
          render();
        }
      });
    }

    // Nh·∫≠n role t·ª´ URL/hash/path
    const ROLES = ['staff','barista','server','cashier','admin'];
    const qRole = new URLSearchParams(location.search).get('role');
    const hRaw = location.hash.replace(/^#/, '');
    const hRole = new URLSearchParams(hRaw).get('role') || hRaw;
    const pRole = location.pathname.split('/').filter(Boolean).pop();
    [qRole,hRole,pRole].some(c=>{
      const r = String(c||'').toLowerCase();
      if(ROLES.includes(r)){ role = r; return true; }
      return false;
    });
    try{ const savedRole = sessionStorage.getItem('tn_role'); if(savedRole) role = savedRole; }catch{}
    function persistRole(){ try{ sessionStorage.setItem('tn_role', role); }catch{} }

    function setRole(r){ role = r; persistRole(); render(); }
    function statusLabel(s){ return ({queued:'Ch·ªù pha',brewing:'ƒêang pha',ready:'S·∫µn s√†ng',delivered:'ƒê√£ giao',paid:'ƒê√£ thanh to√°n'})[s]||s; }
    function calcOrderTotal(o){
      return o.items.reduce((t,it)=> t + it.price*it.qty + (it.toppings||[]).reduce((s,tp)=>s+tp.price*tp.qty,0), 0);
    }

    // ====== QUEUES (∆∞u ti√™n theo th·ªùi gian) ======
    function getQueues(){
      const notPaid = store.orders.filter(o => o.status !== 'paid');
      const byTimeAsc = (a,b) => a.createdAt - b.createdAt;

      const brewing = notPaid.filter(o=>['queued','brewing'].includes(o.status)).sort(byTimeAsc);
      const ready   = notPaid.filter(o=>o.status==='ready').sort(byTimeAsc);
      const delivered = notPaid.filter(o=>o.status==='delivered').sort(byTimeAsc);

      // nh√≥m theo b√†n + ƒë√°nh d·∫•u b·ªï sung
      const groupByTable = (arr)=>{
        const m = new Map();
        arr.forEach(o=>{
          const list = m.get(o.table) || [];
          list.push(o);
          m.set(o.table, list);
        });
        for(const [k, list] of m.entries()){
          list.sort(byTimeAsc).forEach((o, idx)=>{ o.__addonIndex = idx; });
          m.set(k, list);
        }
        return m;
      };

      return { brewing, ready, delivered, notPaid, brewingByTable: groupByTable(brewing) };
    }

    // ====== MUTATIONS ======
    function setStatus(orderId, status){
      if(window.firebaseApi?.ready){
        const o = store.orders.find(x=>x.id===orderId); if(!o) return;
        const timeline = [...(o.timeline||[]), {status, ts: now()}];
        window.firebaseApi.updateStatus(orderId,status,timeline).then(ok=>{
          if(!ok) alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i l√™n cloud');
        });
        return;
      }
      // local
      store.orders = store.orders.map(o=> o.id===orderId ? {...o,status,timeline:[...(o.timeline||[]),{status,ts:now()}]} : o);
      saveLocalOnly(); render();
    }
    function payOrder(orderId){ setStatus(orderId,'paid'); closePay(); }

    function resetData(){
      if(!confirm('Xo√° to√†n b·ªô ƒë∆°n h√†ng tr√™n cloud?')) return;
      cart = {};
      store.orders = [];
      if(window.firebaseApi?.ready){
        window.firebaseApi.clearAllOrders().then(()=>{ saveLocalOnly(); render(); });
      }else{
        saveLocalOnly(); render();
      }
    }

    // Staff actions
    function addToCart(id){ const it=ensureCartItem(id); it.qty++; renderStaff(); }
    function decFromCart(id){ const it=cart[id]; if(!it) return; it.qty=Math.max(0,it.qty-1); if(it.qty===0) delete cart[id]; renderStaff(); }

    function getToppings(){ return (store.menu||[]).filter(m=>/topping/i.test(m.category)); }

    function submitOrder(){
      const items = Object.entries(cart).map(([id,ci])=>{
        const mi = store.menu.find(m=>m.id===id);
        if(!mi || ci.qty<=0) return null;
        return {
          menuItemId:id, name:mi.name, price:mi.price, qty:ci.qty,
          note: ci.note||'',
          toppings: (ci.toppings||[]).map(t=>({ id:t.id, name:t.name, price:t.price, qty:t.qty })),
          served: 0
        };
      }).filter(Boolean);
      if(items.length===0) return alert('Gi·ªè h√†ng tr·ªëng');

      const order = {
        id:newId('ord'),
        table: (String(tablePicking)==='TA' ? 'TA' : Number(tablePicking)),
        takeaway: String(tablePicking)==='TA',
        items,
        priority: calcPriority(items),
        createdAt: now(),
        status:'queued',
        timeline:[{status:'queued',ts:now()}]
      };

      if(window.firebaseApi?.ready){
        window.firebaseApi.pushOrder(order).then(ok=>{
          if(!ok) return alert('Kh√¥ng th·ªÉ g·ª≠i ƒë∆°n l√™n cloud');
          cart={}; saveLocalOnly(); render();
          document.getElementById('recentOrders')?.scrollIntoView({behavior:'smooth', block:'start'});
        });
        return;
      }
      // local
      store.orders.push(order); cart={}; saveLocalOnly(); render();
      document.getElementById('recentOrders')?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    function openPay(id){
      viewingOrderId = id;
      const o = store.orders.find(x=>x.id===id); if(!o) return;
      els.payTitle.textContent = `Thanh to√°n ¬∑ ${o.table==='TA'?'TA (Mang v·ªÅ)':('B√†n '+o.table)}`;
      els.payLines.innerHTML = o.items.map(it=>{
        const tops = (it.toppings||[]).map(t=>`<div class="flex justify-between text-xs text-gray-600"><span>‚Ä¢ ${t.name} √ó ${t.qty}</span><span>${money(t.price*t.qty)}</span></div>`).join('');
        return `<div class="flex items-start justify-between">
          <div><div>${it.name} √ó ${it.qty}</div>${tops}</div>
          <span class="font-medium">${money(it.price*it.qty)}</span>
        </div>`;
      }).join('');
      els.payTotal.textContent = money(calcOrderTotal(o));
      els.payModal.classList.remove('hidden'); els.payModal.classList.add('flex');
      requestAnimationFrame(()=> els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'));
      els.btnConfirmPay.onclick = ()=>{ if(viewingOrderId) payOrder(viewingOrderId); };
    }
    function closePay(){
      viewingOrderId = null;
      els.payModal.classList.add('hidden'); els.payModal.classList.remove('flex');
      els.payModal.querySelector('.modal-enter')?.classList.remove('modal-enter-active');
    }

    function openPayTable(tableNumber){
      const list = store.orders
        .filter(o => o.table===tableNumber && o.status==='delivered')
        .sort((a,b)=>a.createdAt-b.createdAt);
      if(list.length===0) return;

      els.payTitle.textContent = `Thanh to√°n ¬∑ B√†n ${tableNumber} (${list.length} ƒë∆°n)`;
      els.payLines.innerHTML = list.map(o=>`
        <div class="border rounded-lg p-2">
          <div class="flex items-center justify-between">
            <span class="text-sm text-gray-600">#${shortId(o.id)} ¬∑ ${fmtTime(o.createdAt)}</span>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
          </div>
          <div class="mt-1 space-y-1">
            ${o.items.map(it=>{
              const tops=(it.toppings||[]).map(t=>`(+ ${t.name}√ó${t.qty})`).join(', ');
              return `<div class="flex items-center justify-between">
                <span>${it.name} √ó ${it.qty} ${tops?'<span class="text-xs text-gray-500">'+tops+'</span>':''}</span>
                <span class="font-medium">${money(it.price*it.qty)}</span>
              </div>`;
            }).join('')}
          </div>
        </div>`).join('');

      const total = list.reduce((s,o)=> s + calcOrderTotal(o), 0);
      els.payTotal.textContent = money(total);
      els.payModal.classList.remove('hidden'); els.payModal.classList.add('flex');
      requestAnimationFrame(()=> els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'));
      els.btnConfirmPay.onclick = ()=> payTable(tableNumber);
    }
    function payTable(tableNumber){
      const ids = store.orders.filter(o => o.table===tableNumber && o.status==='delivered').map(o=>o.id);
      if(ids.length===0){ closePay(); return; }

      if(window.firebaseApi?.ready){
        Promise.all(ids.map(id=>{
          const o = store.orders.find(x=>x.id===id);
          const timeline = [...(o?.timeline||[]), {status:'paid', ts: now()}];
          return window.firebaseApi.updateStatus(id,'paid',timeline);
        })).then(()=>{ closePay(); });
      }else{
        store.orders = store.orders.map(o => (o.table===tableNumber && o.status==='delivered'
          ? {...o,status:'paid',timeline:[...(o.timeline||[]),{status:'paid',ts:now()}]}
          : o));
        closePay(); render();
      }
    }

    function persistOrdersChange(){
      if(window.firebaseApi?.ready){
        store.orders.forEach(o=>{
          window.firebaseApi.updateStatus(o.id, o.status, o.timeline||[]);
        });
      }else{
        saveLocalOnly();
      }
    }
    function serveItem(orderId, itemIndex, amount=1, silent){
      const o = store.orders.find(x=>x.id===orderId); if(!o) return;
      const it = o.items[itemIndex]; if(!it) return;
      it.served = Math.min(it.qty, (it.served||0) + Math.max(0,amount));
      const allServed = o.items.every(x => (x.served||0) >= x.qty);
      if(allServed && o.status!=='paid'){
        o.status = 'delivered';
        o.timeline = [...(o.timeline||[]), {status:'delivered', ts:now()}];
      }else if(o.status==='queued'){
        o.status = 'brewing';
      }
      persistOrdersChange();
      if(!silent) render();
    }

    // ====== RENDERERS ======
    function renderRole(){
      Object.values(els.views).forEach(v=>v.classList.add('hidden'));
      els.views[role].classList.remove('hidden');
      els.roleSelect.value = role;
    }

    function renderStaff(){
      // B√ÄN
      els.tableSelect.innerHTML =
        `<option value="TA">Mang v·ªÅ (Takeaway)</option>` +
        Array.from({length: store.tables})
          .map((_,i)=>`<option value="${i+1}">B√†n ${i+1}</option>`).join('');
      els.tableSelect.value = String(tablePicking);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${tablePicking==='TA'?'Mang v·ªÅ':('B√†n '+tablePicking)}`;

      // CATEGORY gi·ªØ l·ª±a ch·ªçn
      const prevCat = els.catFilter.value || 'All';
      const cats = ['All', ...new Set((store.menu||[]).map(m=>m.category))];
      els.catFilter.innerHTML = cats.map(c=>`<option value="${c}">${c}</option>`).join('');
      els.catFilter.value = cats.includes(prevCat) ? prevCat : 'All';

      // L·ªåC
      const kw = (els.searchInput.value||'').toLowerCase();
      const cat = els.catFilter.value || 'All';
      const list = (store.menu||[]).filter(m =>
        (cat==='All' || m.category===cat) &&
        (!kw || m.name.toLowerCase().includes(kw))
      );

      // HI·ªÇN TH·ªä MENU
      els.menuGrid.innerHTML = list.map(m=>`
        <div class="border rounded-xl p-4 hover:shadow-sm bg-white">
          <div class="flex items-start justify-between gap-3">
            <div>
              <h3 class="font-semibold text-gray-900">${m.name}</h3>
              <p class="text-xs text-gray-500">${m.category}</p>
            </div>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${money(m.price)}</span>
          </div>
          <div class="mt-3 flex items-center justify-between">
            <div class="flex items-center gap-2">
              <button data-dec="${m.id}" class="px-2 py-1 border rounded">-</button>
              <span class="w-8 text-center">${(cart[m.id]?.qty)||0}</span>
              <button data-inc="${m.id}" class="px-2 py-1 border rounded">+</button>
            </div>
            <button data-add="${m.id}" class="px-3 py-1 rounded-lg bg-black text-white text-sm">Th√™m</button>
          </div>
        </div>
      `).join('');

      // events +/-
      els.menuGrid.querySelectorAll('[data-inc]').forEach(b=>b.addEventListener('click',e=>addToCart(e.target.getAttribute('data-inc'))));
      els.menuGrid.querySelectorAll('[data-dec]').forEach(b=>b.addEventListener('click',e=>decFromCart(e.target.getAttribute('data-dec'))));
      els.menuGrid.querySelectorAll('[data-add]').forEach(b=>b.addEventListener('click',e=>{
        const id = e.target.getAttribute('data-add');
        const it = ensureCartItem(id);
        if(it.qty===0) it.qty=1;
        renderCart();
      }));

      renderCart();

      // recent
      const listRecent = store.orders.filter(o=>o.status!=='paid').sort((a,b)=>b.createdAt-a.createdAt).slice(0,8);
      els.recentOrders.innerHTML = listRecent.map(o=>`
        <div class="flex items-center justify-between border rounded-lg p-3">
          <div>
            <p class="font-medium">${o.table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+o.table}</p>
            <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p>
          </div>
          <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
        </div>`).join('');
    }

    function renderCart(){
      const ids = Object.keys(cart);
      if(ids.length===0){ els.cartList.textContent='Ch∆∞a c√≥ m√≥n.'; els.cartTotal.textContent='0‚Ç´'; return; }

      const toppingOpts = getToppings().map(t=>`<option value="${t.id}">${t.name} (+${money(t.price)})</option>`).join('');

      els.cartList.innerHTML = ids.map(id=>{
        const mi = store.menu.find(m=>m.id===id); if(!mi) return '';
        const ci = cart[id];
        const toppingsHtml = (ci.toppings||[]).map(tp=>`
          <div class="flex items-center justify-between text-xs text-gray-600">
            <span>‚Ä¢ ${tp.name} √ó ${tp.qty}</span>
            <span>${money(tp.price*tp.qty)}</span>
          </div>`).join('');

        return `
        <div class="border rounded-lg p-3 space-y-2">
          <div class="flex items-center justify-between">
            <div>
              <p class="font-medium">${mi.name}</p>
              <p class="text-xs text-gray-500">${money(mi.price)} √ó ${ci.qty}</p>
            </div>
            <div class="flex items-center gap-2">
              <button data-dec-cart="${id}" class="px-2 py-1 border rounded">-</button>
              <span class="w-6 text-center">${ci.qty}</span>
              <button data-inc-cart="${id}" class="px-2 py-1 border rounded">+</button>
            </div>
          </div>

          <div class="flex items-center gap-2">
            <input data-note="${id}" class="border rounded px-2 py-1 text-xs w-full"
                  placeholder="Ghi ch√∫ cho m√≥n n√†y..." value="${ci.note||''}" />
          </div>

          <div class="flex items-center gap-2">
            <select data-addtp="${id}" class="border rounded px-2 py-1 text-xs">
              <option value="">+ Th√™m topping</option>
              ${toppingOpts}
            </select>
            <button data-cleartp="${id}" class="text-xs border px-2 py-1 rounded">Xo√° topping</button>
          </div>

          ${toppingsHtml ? `<div class="pt-1 border-t">${toppingsHtml}</div>` : ''}
        </div>`;
      }).join('');

      // events
      els.cartList.querySelectorAll('[data-dec-cart]').forEach(b=>b.addEventListener('click',e=>decFromCart(e.target.getAttribute('data-dec-cart'))));
      els.cartList.querySelectorAll('[data-inc-cart]').forEach(b=>b.addEventListener('click',e=>addToCart(e.target.getAttribute('data-inc-cart'))));
      els.cartList.querySelectorAll('[data-note]').forEach(inp=>inp.addEventListener('input', e=>{
        const id=e.target.getAttribute('data-note'); ensureCartItem(id).note=e.target.value;
      }));
      els.cartList.querySelectorAll('[data-addtp]').forEach(sel=>sel.addEventListener('change', e=>{
        const id=e.target.getAttribute('data-addtp'); const tpId=e.target.value; if(!tpId) return;
        const tp = getToppings().find(t=>t.id===tpId); if(!tp) return;
        const ci = ensureCartItem(id);
        const ex = ci.toppings.find(x=>x.id===tpId);
        if(ex) ex.qty++; else ci.toppings.push({id:tp.id,name:tp.name,price:tp.price,qty:1});
        e.target.value=''; renderCart();
      }));
      els.cartList.querySelectorAll('[data-cleartp]').forEach(b=>b.addEventListener('click', e=>{
        const id=e.target.getAttribute('data-cleartp'); const ci=cart[id]; if(ci){ ci.toppings=[]; renderCart(); }
      }));

      // total
      const total = ids.reduce((sum,id)=>{
        const mi=store.menu.find(m=>m.id===id); const ci=cart[id];
        const core = mi ? mi.price*ci.qty : 0;
        const tops = (ci.toppings||[]).reduce((s,t)=>s+t.price*t.qty,0);
        return sum + core + tops;
      },0);
      els.cartTotal.textContent = money(total);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${tablePicking==='TA'?'Mang v·ªÅ':('B√†n '+tablePicking)}`;
    }

    function renderBarista(){
      els.tabByTable.classList.toggle('bg-black', baristaTab==='by-table');
      els.tabByTable.classList.toggle('text-white', baristaTab==='by-table');
      els.tabByItem.classList.toggle('bg-black', baristaTab==='by-item');
      els.tabByItem.classList.toggle('text-white', baristaTab==='by-item');

      const { brewing, brewingByTable } = getQueues();

      // T√≠nh th·ª© t·ª± h√†ng ƒë·ª£i (ƒë∆°n s·ªõm c√≥ s·ªë nh·ªè)
      const brewingAll = brewing.slice().sort((a,b)=> a.createdAt - b.createdAt);
      const qpos = new Map(brewingAll.map((o,i)=>[o.id, i+1])); // id -> th·ª© t·ª±

      // BY TABLE
      const entries = Array.from(brewingByTable.entries()).sort((a,b)=> a[0]-b[0]);
      els.baristaByTable.innerHTML = entries.map(([table,orders])=>`
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">${table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+table}</h3>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${orders.length} ƒë∆°n</span>
          </div>
          <div class="space-y-3">
            ${orders.map(o=>`
              <div class="border rounded-lg p-3 ${o.takeaway?'ring-2 ring-yellow-300':''}">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="w-7 h-7 rounded-full bg-black text-white text-xs grid place-items-center font-semibold">
                      ${qpos.get(o.id) || ''}
                    </span>
                    <p class="text-sm text-gray-500">
                      #${shortId(o.id)} ¬∑ ${o.__addonIndex>0?'B·ªï sung':'ƒê∆°n ƒë·∫ßu'} ¬∑ ${fmtTime(o.createdAt)}
                      ${o.takeaway? '<span class="ml-2 text-xs px-2 py-0.5 rounded-full bg-yellow-200 text-yellow-900">Mang v·ªÅ</span>':''}
                    </p>
                  </div>
                  <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${statusLabel(o.status)}</span>
                </div>
                <ul class="mt-2 text-sm space-y-1">
                  ${o.items.map((it,idx)=>`
                    <li class="flex items-center justify-between gap-2">
                      <div>
                        ${it.name} √ó ${it.qty}
                        ${it.note ? `<span class="ml-1 text-xs text-amber-700 bg-amber-100 px-1 rounded">Note: ${it.note}</span>`:''}
                        ${Array.isArray(it.toppings)&&it.toppings.length? `<span class="ml-1 text-xs text-indigo-700 bg-indigo-100 px-1 rounded">+ ${it.toppings.map(t=>`${t.name}√ó${t.qty}`).join(', ')}</span>`:''}
                      </div>
                      <div class="flex items-center gap-1">
                        <button data-serve-one="${o.id}|${idx}" class="px-2 py-0.5 text-xs border rounded">Giao 1</button>
                        <button data-serve-all="${o.id}|${idx}" class="px-2 py-0.5 text-xs border rounded">Giao h·∫øt m√≥n</button>
                        <span class="text-xs text-gray-500">ƒê√£ giao: ${it.served||0}</span>
                      </div>
                    </li>`).join('')}
                </ul>
                <div class="mt-3 flex gap-2">
                  ${o.status==='queued'  ? `<button data-start="${o.id}" class="px-3 py-1 rounded-lg bg-amber-600 text-white">B·∫Øt ƒë·∫ßu pha</button>`:''}
                  ${o.status!=='paid' ? `<button data-serve-order="${o.id}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Giao h·∫øt ƒë∆°n</button>`:''}
                </div>
              </div>
            `).join('')}
          </div>
        </div>`).join('');

      // listeners
      els.baristaByTable.querySelectorAll('[data-start]').forEach(b=>b.addEventListener('click',e=>setStatus(e.target.getAttribute('data-start'),'brewing')));
      els.baristaByTable.querySelectorAll('[data-serve-one]').forEach(b=>b.addEventListener('click', e=>{
        const [oid, idx] = e.target.getAttribute('data-serve-one').split('|'); serveItem(oid, Number(idx), 1);
      }));
      els.baristaByTable.querySelectorAll('[data-serve-all]').forEach(b=>b.addEventListener('click', e=>{
        const [oid, idx] = e.target.getAttribute('data-serve-all').split('|');
        const o = store.orders.find(x=>x.id===oid); if(!o) return;
        const it=o.items[idx]; if(!it) return;
        serveItem(oid, Number(idx), (it.qty - (it.served||0)));
      }));
      els.baristaByTable.querySelectorAll('[data-serve-order]').forEach(b=>b.addEventListener('click', e=>{
        const oid = e.target.getAttribute('data-serve-order');
        const o = store.orders.find(x=>x.id===oid); if(!o) return;
        o.items.forEach((it,idx)=> serveItem(oid, idx, (it.qty - (it.served||0)), true));
        render();
      }));

      // BY ITEM (t·ªïng h·ª£p)
      const agg = new Map();
      brewing.forEach(o=>{
        o.items.forEach(it=>{
          const cur = agg.get(it.menuItemId) || {name:it.name,totalQty:0,rows:[]};
          cur.totalQty += (it.qty - (it.served||0));
          cur.rows.push({table:o.table,id:o.id,ts:o.createdAt,qty:(it.qty - (it.served||0)),addonIndex:o.__addonIndex||0, q: (new Map(brewing.map((x,i)=>[x.id,i+1]))).get(o.id)||null});
          agg.set(it.menuItemId, cur);
        });
      });
      const rows = Array.from(agg.entries()).map(([id,v])=>({ id, ...v })).sort((a,b)=> b.totalQty - a.totalQty);

      els.baristaByItem.innerHTML = rows.map(r=>`
        <div class="border rounded-xl p-4">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold">${r.name}</h4>
            <span class="text-sm font-bold">${r.totalQty}</span>
          </div>
          <div class="mt-2 text-xs text-gray-600 space-y-1">
            ${r.rows.map(x=>`
              <div class="flex items-center gap-2">
                <span class="w-6 h-6 rounded-full bg-black text-white grid place-items-center text-[10px]">${x.q??''}</span>
                <span>${x.table==='TA'?'TA':'B√†n '+x.table} ¬∑ #${shortId(x.id)} ${x.addonIndex>0?'¬∑ B·ªï sung':''} ¬∑ ${fmtTime(x.ts)} ¬∑ √ó${x.qty}</span>
              </div>
            `).join('')}
          </div>
        </div>`).join('');

      // toggle
      els.baristaByTable.classList.toggle('hidden', baristaTab!=='by-table');
      els.baristaByItem.classList.toggle('hidden',  baristaTab!=='by-item');
    }

    function renderServer(){
      const { ready, delivered } = getQueues();
      els.readyList.innerHTML = ready.map(o=>`
        <div class="border rounded-lg p-3 flex items-center justify-between">
          <div><p class="font-medium">${o.table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+o.table}</p>
          <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p></div>
          <button data-deliver="${o.id}" class="px-3 py-1 rounded-lg bg-indigo-600 text-white">ƒê√£ giao</button>
        </div>`).join('') || '<p class="text-sm text-gray-500">Ch∆∞a c√≥ m√≥n s·∫µn s√†ng.</p>';
      els.readyList.querySelectorAll('[data-deliver]').forEach(b=>b.addEventListener('click',e=>setStatus(e.target.getAttribute('data-deliver'),'delivered')));

      els.deliveredList.innerHTML = delivered.map(o=>`
        <div class="border rounded-lg p-3 flex items-center justify-between">
          <div><p class="font-medium">${o.table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+o.table}</p>
          <p class="text-xs text-gray-500">${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}</p></div>
          <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">Ch·ªù thanh to√°n</span>
        </div>`).join('') || '<p class="text-sm text-gray-500">‚Äî</p>';
    }

    let cashierBound = false;

    function renderCashier(){
      const notPaidDelivered = store.orders.filter(o => o.status === 'delivered');
      const paid    = store.orders.filter(o => o.status === 'paid');

      // nh√≥m theo b√†n
      const map = new Map();
      notPaidDelivered.forEach(o=>{
        const list = map.get(o.table) || [];
        list.push(o);
        map.set(o.table,list);
      });
      const tables = Array.from(map.entries()).sort((a,b)=> (a[0]+'').localeCompare(b[0]+''));

      els.cashierNotPaid.innerHTML = tables.map(([table,orders])=>{
        const amount = orders.reduce((s,o)=> s+calcOrderTotal(o), 0);
        const lines = orders.map(o=>`#${shortId(o.id)} (${fmtTime(o.createdAt)}): ${o.items.map(it=>`${it.name}√ó${it.qty}`).join(', ')}`).join('<br/>');
        return `
        <div class="border rounded-lg p-3 flex items-center justify-between">
          <div>
            <p class="font-semibold">${table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+table} ¬∑ ${orders.length} ƒë∆°n</p>
            <p class="text-xs text-gray-500">${lines}</p>
          </div>
          <div class="flex items-center gap-3">
            <span class="font-bold">${money(amount)}</span>
            ${table==='TA'
              ? `<button data-pay-table="TA" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Thanh to√°n TA</button>`
              : `<button data-pay-table="${table}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Thanh to√°n b√†n</button>`}
          </div>
        </div>`;
      }).join('') || '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</p>';

      if(!cashierBound){
        els.cashierNotPaid.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-pay-table]');
          if(!btn) return;
          const table = btn.getAttribute('data-pay-table');
          if (table==='TA') {
            // pay all delivered takeaway orders
            const ids = store.orders.filter(o => o.table==='TA' && o.status==='delivered').map(o=>o.id);
            if(ids.length===0) return;
            ids.forEach(id=>setStatus(id,'paid'));
          } else if (!isNaN(Number(table))) {
            openPayTable(Number(table));
          }
        });
        cashierBound = true;
      }

      const paidCards = paid.slice().reverse().map(o=>`
        <div class="border rounded-lg p-3">
          <div class="flex items-center justify-between">
            <p class="font-semibold">${o.table==='TA'?'TA (Mang v·ªÅ)':'B√†n '+o.table}</p>
            <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">#${shortId(o.id)}</span>
          </div>
          <ul class="mt-2 text-sm list-disc list-inside">
            ${o.items.map(it=>{
              const tops=(it.toppings||[]).map(t=>`+ ${t.name}√ó${t.qty}`).join(', ');
              return `<li>${it.name} √ó ${it.qty}${tops? ' ('+tops+')':''} ‚Äî ${money(it.price*it.qty)}</li>`;
            }).join('')}
          </ul>
          <div class="pt-2 mt-2 border-t flex items-center justify-between">
            <span class="font-semibold">T·ªïng</span>
            <span class="font-bold">${money(calcOrderTotal(o))}</span>
          </div>
        </div>`).join('');
      els.cashierPaid.innerHTML = paidCards || '<p class="text-sm text-gray-500">‚Äî</p>';

      const totalToday = paid.reduce((s,o)=> s+calcOrderTotal(o), 0);
      els.cashierTotalToday.textContent = `T·ªïng: ${money(totalToday)}`;
    }

    function renderRevenueToday(){
      const paid = store.orders.filter(o=>o.status==='paid' && isToday((o.timeline||[]).find(t=>t.status==='paid')?.ts || o.createdAt));
      const tbody = document.getElementById('revTodayBody');
      if(!tbody) return;
      tbody.innerHTML = paid.map(o=>{
        const total = calcOrderTotal(o);
        const detail = o.items.map(it=>{
          const tops = (it.toppings||[]).map(t=>`+ ${t.name}√ó${t.qty}`).join(', ');
          return `${it.name}√ó${it.qty}${tops? ' ('+tops+')':''}`;
        }).join('; ');
        return `<tr class="border-t">
          <td class="py-2">${fmtTime(o.createdAt)}</td>
          <td class="py-2">${o.table==='TA'?'TA':o.table}</td>
          <td class="py-2">#${shortId(o.id)}</td>
          <td class="py-2">${detail}</td>
          <td class="py-2 text-right font-medium">${money(total)}</td>
        </tr>`;
      }).join('') || `<tr><td class="py-2 text-gray-500" colspan="5">‚Äî</td></tr>`;
    }

    function exportRevenueCSV(){
      const rows = [['Time','Table','OrderId','Detail','Total']];
      const paid = store.orders.filter(o=>o.status==='paid' && isToday((o.timeline||[]).find(t=>t.status==='paid')?.ts || o.createdAt));
      paid.forEach(o=>{
        const detail = o.items.map(it=>{
          const tops = (it.toppings||[]).map(t=>`+${t.name}x${t.qty}`).join(', ');
          return `${it.name}x${it.qty}${tops? ' ('+tops+')':''}`;
        }).join('; ');
        rows.push([ new Date(o.createdAt).toLocaleString('vi-VN'), (o.table==='TA'?'TA':o.table), '#'+shortId(o.id), detail, calcOrderTotal(o) ]);
      });
      const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `doanh_thu_${new Date().toISOString().slice(0,10)}.csv`; a.click();
      URL.revokeObjectURL(a.href);
    }

    // Toast for new orders
    function showToast(html){
      const host = document.getElementById('toastHost');
      const box = document.createElement('div');
      box.className = 'bg-black/80 text-white text-sm rounded-xl px-3 py-2 shadow';
      box.innerHTML = html + ' <button class="ml-2 text-xs opacity-70 hover:opacity-100" data-x>‚úï</button>';
      host.appendChild(box);
      const snd = document.getElementById('newOrderSound'); try{ snd.currentTime=0; snd.play().catch(()=>{});}catch{}
      const kill = ()=>{ box.remove(); };
      box.querySelector('[data-x]').addEventListener('click', kill);
      setTimeout(kill, 3000);
    }
    let knownOrderIds = new Set();
    function handleNewOrders(arr){
      const nowIds = new Set(arr.map(o=>o.id));
      arr.forEach(o=>{
        if(!knownOrderIds.has(o.id) && o.status==='queued'){
          showToast(`üßæ ƒê∆°n m·ªõi #${shortId(o.id)} ¬∑ ${o.table==='TA'?'Mang v·ªÅ':'B√†n '+o.table}`);
        }
      });
      knownOrderIds = nowIds;
    }

    function render(){
      window.store = store;
      window.render = render;
      renderRole();
      if(role==='staff') renderStaff();
      if(role==='barista') renderBarista();
      if(role==='server') renderServer();
      if(role==='cashier'){ renderCashier(); renderRevenueToday(); }
      if(role==='admin'){
        els.tablesInput.value = store.tables;
        els.menuTextarea.value = JSON.stringify(store.menu,null,2);
      }
      saveLocalOnly();
    }

    // events
    els.roleSelect.addEventListener('change', e=>setRole(e.target.value));
    els.btnResetData.addEventListener('click', resetData);
    els.tableSelect?.addEventListener('change', e=>{ tablePicking = e.target.value==='TA'?'TA':Number(e.target.value); renderCart(); });
    els.catFilter?.addEventListener('change', ()=>renderStaff());
    els.searchInput?.addEventListener('input', ()=>renderStaff());
    els.btnSubmitOrder?.addEventListener('click', submitOrder);
    els.tabByTable?.addEventListener('click', ()=>{ baristaTab='by-table'; renderBarista(); });
    els.tabByItem?.addEventListener('click', ()=>{ baristaTab='by-item'; renderBarista(); });
    [els.btnClosePay, els.btnCancelPay].forEach(b=>b?.addEventListener('click', closePay));
    document.getElementById('btnExportToday')?.addEventListener('click', exportRevenueCSV);

    // Kh·ªüi ƒë·ªông: n·∫°p CSV -> store.menu r·ªìi render
    (async()=>{
      store = loadStore();
      try{
        const csvMenu = await fetchCSVMenu();
        if(csvMenu.length) { store.menu = csvMenu; saveLocalOnly(); }
      }catch(e){ console.warn('CSV menu load failed ‚Üí d√πng local fallback', e); }
      render();
    })();
  </script>

  <!-- === FIREBASE (config + orders + presence + dashboard) === -->
  <script type="module">
    // Config c·ªßa b·∫°n
    window.FIREBASE_CONFIG = {
      apiKey: "AIzaSyC5g01aNIwU6Ysa5zsW2ahBmR_wiAHSc-0",
      authDomain: "tiem-nuoc-tui-minh.firebaseapp.com",
      databaseURL: "https://tiem-nuoc-tui-minh-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tiem-nuoc-tui-minh",
      appId: "1:599673062211:web:2ac6b038d1b17c6130a5f6"
    };

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
    import {
      getDatabase, ref, onValue, push, set, update, onDisconnect, serverTimestamp, get
    } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';

    const hasConfig = !!(window.FIREBASE_CONFIG && window.FIREBASE_CONFIG.apiKey);

    const firebaseApi = {
      app:null, db:null, auth:null, user:null,
      ordersRef:null, configRef:null, ready:false,
      lastOrdersHash:null,
      async init(){
        if(!hasConfig){ console.info('[Firebase] No config ‚Üí local only'); return; }
        try{
          this.app = initializeApp(window.FIREBASE_CONFIG);
          this.db = getDatabase(this.app);
          this.auth = getAuth(this.app);
          await signInAnonymously(this.auth);
          onAuthStateChanged(this.auth,(u)=>{ this.user=u||null; if(u) this.setPresence(u.uid); });

          this.ordersRef = ref(this.db,'orders');
          this.configRef = ref(this.db,'config');
          this.ready = true;

          // ƒë·∫£m b·∫£o c√≥ config m·∫∑c ƒë·ªãnh
          try{
            const snap = await get(this.configRef);
            if(!snap.exists()){
              await set(this.configRef, {
                tables: 20, menu: [],
                updatedAt: serverTimestamp()
              });
            }
          }catch(e){ console.warn('Ensure default config error:', e); }
        }catch(err){
          console.error('[Firebase] init error:',err);
          this.ready=false;
        }
      },
      setPresence(uid){
        try{
          const pRef = ref(this.db, `presence/${uid}`);
          onDisconnect(pRef).remove();
          set(pRef, { online: true, ts: serverTimestamp() });
          onValue(ref(this.db,'presence'), (snap)=>{
            const val = snap.val() || {};
            const online = Object.keys(val).length;
            const el = document.getElementById('kpiOnline');
            if(el) el.textContent = String(online);
          });
        }catch(e){ console.error('presence error', e); }
      },
      subscribeOrders(cb){
        if(!this.ready) return;
        onValue(this.ordersRef,(snap)=>{
          const val = snap.val() || {};
          const arr = Object.entries(val).map(([id,data])=>({id,...data}))
            .sort((a,b)=>a.createdAt-b.createdAt);
          const h = JSON.stringify(arr.map(o=>[o.id,o.status,o.timeline?.length||0,o.items?.length||0]));
          if(h!==this.lastOrdersHash){ this.lastOrdersHash=h; cb(arr); this.updateDashboard(arr); }
        });
      },
      subscribeConfig(cb){
        if(!this.ready) return;
        onValue(this.configRef,(snap)=>{
          const val = snap.val();
          if(!val) return;
          cb({ tables: val.tables, menu: val.menu || [] });
        });
      },
      updateDashboard(arr){
        const total = arr.length;
        const elOrders = document.getElementById('kpiOrders');
        if(elOrders) elOrders.textContent = String(total);

        const enc = new TextEncoder();
        let bytes = 0;
        for(const o of arr){ bytes += enc.encode(JSON.stringify(o)).length; }
        const MB = (bytes/(1024*1024)).toFixed(2);
        const pct = Math.min(100, (bytes/(1024*1024*1024))*100);
        const st = document.getElementById('kpiStorage'); const bar = document.getElementById('kpiStorageBar'); const pctEl = document.getElementById('kpiStoragePct');
        if(st) st.textContent = MB+' MB';
        if(bar) bar.style.width = pct.toFixed(1)+'%';
        if(pctEl) pctEl.textContent = pct.toFixed(1)+'%';

        const assumedReadsPerMonth = 5;
        const downGB = (bytes*assumedReadsPerMonth)/(1024*1024*1024);
        const downPct = Math.min(100, (downGB/10)*100);
        const bw = document.getElementById('kpiBandwidth'); const bwBar = document.getElementById('kpiBandwidthBar'); const bwPct = document.getElementById('kpiBandwidthPct');
        if(bw) bw.textContent = downGB.toFixed(2)+' GB';
        if(bwBar) bwBar.style.width = downPct.toFixed(1)+'%';
        if(bwPct) bwPct.textContent = downPct.toFixed(1)+'%';
      },
      async pushOrder(order){
        if(!this.ready) return false;
        try{ const r = push(this.ordersRef); await set(r,{...order,id:r.key}); return true; }
        catch(e){ console.error(e); return false; }
      },
      async updateStatus(orderId,status,timeline){
        if(!this.ready) return false;
        try{ await update(ref(this.db,`orders/${orderId}`),{status,timeline}); return true; }
        catch(e){ console.error(e); return false; }
      },
      async clearAllOrders(){
        if(!this.ready) return false;
        try{ await set(this.ordersRef,null); this.lastOrdersHash=null; return true; }
        catch(e){ console.error(e); return false; }
      },
      async updateConfig({ tables, menu }){
        if(!this.ready) return false;
        try{
          await update(this.configRef, {
            ...(typeof tables==='number' ? { tables } : {}),
            ...(Array.isArray(menu) ? { menu } : {}),
            updatedAt: serverTimestamp()
          });
          return true;
        }catch(e){ console.error('updateConfig error', e); return false; }
      }
    };

    window.firebaseApi = firebaseApi;

    (async()=>{
      await firebaseApi.init();
      if(firebaseApi.ready){
        firebaseApi.subscribeOrders((orders)=>{
          try{
            handleNewOrders(orders);
            window.store.orders = orders;
            if(typeof window.render==='function') window.render();
          }
          catch(e){ console.error(e); }
        });
        firebaseApi.subscribeConfig(({tables,menu})=>{
          try{
            if(typeof tables==='number') window.store.tables = tables;
            if(Array.isArray(menu)) window.store.menu = menu;
            if(typeof window.render==='function') window.render();
          }catch(e){ console.error(e); }
        });
      }
    })();
  </script>
</body>
</html>
