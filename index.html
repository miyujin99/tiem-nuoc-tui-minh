<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
<meta id="metaViewport" name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS + Dashboard (v2.2 ‚Äì toast-only-new-order + webaudio-beep)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-enter{opacity:0;transform:translateY(6px)}
    .modal-enter-active{opacity:1;transform:translateY(0);transition:all .15s ease}
    .toast-enter{opacity:0;transform:translateY(8px)}
    .toast-enter-active{opacity:1;transform:translateY(0);transition:all .2s ease}
    .badge{font-size:.72rem}
    .hide-scroll::-webkit-scrollbar{display:none}
	html{scroll-behavior:smooth}
    .force-desktop body { -webkit-text-size-adjust:100%; text-size-adjust:100%; }
    .force-desktop .text-xs { font-size: .8rem; }
    .force-desktop .text-sm { font-size: .95rem; }
    .force-desktop .text-base { font-size: 1.05rem; }
	.qf { transition: transform .08s ease, box-shadow .08s ease; }
	.qf:active { transform: translateY(1px); }

  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
<div class="w-full px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üßã</span>
        <div>
          <h1 class="text-lg font-bold">Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</h1>
          <p class="text-xs text-gray-500">HTML + Tailwind ¬∑ Firebase/Local ¬∑ CSV menu</p>
        </div>
      </div>
<div class="flex items-center gap-3">
  <button id="btnJumpCartHeader"
          class="hidden text-sm px-3 py-2 rounded-lg border bg-emerald-600 text-white hover:bg-emerald-700">
    üõí Xem gi·ªè <span id="cartCountHeader" class="ml-1"></span>
  </button>

  <select id="roleSelect" class="border rounded-lg px-3 py-2 text-sm">
    <option value="staff">Nh√¢n vi√™n (G·ªçi m√≥n)</option>
    <option value="barista">Qu·∫ßy pha ch·∫ø</option>
    <option value="cashier">Thu ng√¢n</option>
    <option value="admin">Qu·∫£n l√Ω</option>
  </select>

  <button id="btnResetData" class="text-sm px-3 py-2 border rounded-lg">Reset ƒë∆°n</button>
</div>

    </div>
  </header>
  

  <!-- Dev Panel -->
  <div id="devPanel" class="hidden mx-auto max-w-6xl px-4 mt-3">
    <div class="rounded-xl border bg-amber-50 text-amber-900 px-4 py-3 flex items-center justify-between">
      <div class="text-sm">
        <strong>Local Dev Mode:</strong> ƒêang ch·∫°y file tr·ª±c ti·∫øp / ch∆∞a fetch ƒë∆∞·ª£c <code>assets/menu.csv</code>.
        <span class="ml-2">Ch·ªçn CSV tr√™n m√°y ƒë·ªÉ n·∫°p menu.</span>
      </div>
      <div class="flex items-center gap-2">
        <input id="csvPicker" type="file" accept=".csv,text/csv" class="hidden" />
        <button id="btnPickCSV" class="px-3 py-1.5 rounded border bg-white text-sm">Ch·ªçn CSV</button>
        <button id="btnSeedSample" class="px-3 py-1.5 rounded border bg-white text-sm">Sinh ƒë∆°n m·∫´u</button>
        <button id="btnHideDev" class="px-3 py-1.5 rounded border bg-white text-sm">·∫®n</button>
      </div>
    </div>
  </div>

  <!-- Toast host -->
  <div id="toastHost" class="fixed left-3 top-16 space-y-2 z-50"></div>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
<!-- STAFF -->
<section id="view-staff" class="hidden">
  <div class="space-y-4 w-full max-w-none mx-auto">

    <!-- Anchor ƒë·∫ßu menu -->
    <div id="menuTop"></div>

    <!-- Ch·ªçn b√†n & Menu -->
    <section class="bg-white rounded-2xl shadow-sm border p-5">
<div class="flex items-center justify-between mb-3">
  <h2 class="text-xl font-semibold text-gray-900">Ch·ªçn b√†n & Menu</h2>
  <button id="btnJumpCart"
          class="text-xs px-3 py-1 rounded-lg border bg-emerald-50 text-emerald-700 hover:bg-emerald-100">
    üõí Xem gi·ªè <span id="cartCount" class="ml-1"></span>
  </button>
</div>


      <div class="flex items-center gap-4 mb-3">

        <select id="tableSelect" class="border rounded-lg px-3 py-2 text-sm"></select>
        <select id="catFilter" class="border rounded-lg px-3 py-2 text-sm" data-key="__all__"></select>
        <div class="relative">
          <input id="searchInput" class="border rounded-lg pl-3 pr-8 py-2 text-sm w-48" placeholder="T√¨m m√≥n..." />
          <button id="clearSearchBtn"
                  class="absolute right-1.5 top-1/2 -translate-y-1/2 text-red-400 hover:text-red-600 text-lg font-bold hidden leading-none"
                  title="X√≥a t√¨m ki·∫øm">√ó</button>
        </div>
      </div>

<div class="flex flex-wrap gap-3 md:gap-4 mb-3">
  <button class="qf border px-4 py-2.5 text-base rounded-xl font-medium shadow-sm min-w-[112px] h-11">C√† ph√™</button>
  <button class="qf border px-4 py-2.5 text-base rounded-xl font-medium shadow-sm min-w-[112px] h-11">Matcha</button>
  <button class="qf border px-4 py-2.5 text-base rounded-xl font-medium shadow-sm min-w-[112px] h-11">Tr√† s·ªØa & Tr√†</button>
  <button class="qf border px-4 py-2.5 text-base rounded-xl font-medium shadow-sm min-w-[112px] h-11">ƒê·ªì ƒÉn v·∫∑t</button>
  <button class="qf border px-4 py-2.5 text-base rounded-xl font-medium shadow-sm min-w-[112px] h-11">M√≥n m·ªõi</button>
</div>



        <!-- Menu: full width, kh√¥ng sidebar -->
  <div class="max-w-[1600px] mx-auto">
<div id="menuGrid" class="grid gap-4 [grid-template-columns:repeat(auto-fit,minmax(220px,1fr))]"></div>
  </div>
</section>


<div class="grid md:grid-cols-2 gap-4 items-start">
  <!-- Gi·ªè h√†ng (ƒë·∫∑t d∆∞·ªõi menu) -->
  <section id="cartSection" class="bg-white rounded-2xl shadow-sm border p-5">
      <div class="flex items-center justify-between mb-3">
        <h2 id="cartTitle" class="text-xl font-semibold text-gray-900">Gi·ªè h√†ng</h2>
        <!-- N√∫t nh·∫£y l√™n ƒë·∫ßu menu -->
        <button id="btnJumpTop"
                class="text-xs px-3 py-1 rounded-lg border bg-gray-50 text-gray-700">
          ‚¨ÜÔ∏è L√™n ƒë·∫ßu menu
        </button>
      </div>

      <div id="cartList" class="space-y-3 text-sm text-gray-700">Ch∆∞a c√≥ m√≥n.</div>
      <div class="pt-3 mt-2 border-t flex items-center justify-between">
        <span class="font-semibold">T·ªïng</span>
        <span id="cartTotal" class="font-bold">0‚Ç´</span>
      </div>
      <button id="btnSubmitOrder"
              class="w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-2 mt-3">
        G·ª≠i order ƒë·∫øn qu·∫ßy pha ch·∫ø
      </button>
    </section>

<!-- C√°c ƒë∆°n c·ªßa t√¥i -->
  <section id="recentSection" class="bg-white rounded-2xl shadow-sm border p-5">
    <h2 class="text-xl font-semibold text-gray-900 mb-3">C√°c ƒë∆°n c·ªßa t√¥i (ch∆∞a thanh to√°n)</h2>
    <div id="recentOrders" class="space-y-2"></div>
  </section>
</div>
</section>


    <!-- BARISTA -->
    <section id="view-barista" class="hidden space-y-4">
      <!-- H√ÄNG ƒê·ª¢I PHA CH·∫æ -->
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">H√†ng ƒë·ª£i pha ch·∫ø</h2>
          <div class="flex items-center gap-2 text-sm">
            <button id="tabByTable" class="px-3 py-1 rounded-lg border bg-black text-white">Xem theo b√†n</button>
            <button id="tabByItem" class="px-3 py-1 rounded-lg border">Xem t·ªïng m√≥n</button>
          </div>
        </div>
        <div id="baristaByTable" class="grid md:grid-cols-2 gap-4"></div>
        <div id="baristaByItem" class="grid md:grid-cols-3 gap-4 hidden"></div>
      </section>

      <!-- ƒê√É GIAO ¬∑ CH·ªú THANH TO√ÅN -->
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">ƒê√£ giao ¬∑ ch·ªù thanh to√°n</h2>
        <div id="baristaToPay" class="space-y-3"></div>
      </section>
    </section>

    <!-- CASHIER -->
    <section id="view-cashier" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ch·ªù thanh to√°n</h2>
        <div id="cashierNotPaid" class="space-y-3"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900">ƒê√£ thanh to√°n h√¥m nay</h2>
          <div class="flex items-center gap-2">
            <span id="cashierTotalToday" class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700"></span>
            <button id="dlRevenueBtn" class="text-xs px-2 py-1 rounded border">T·∫£i CSV</button>
          </div>
        </div>
        <div class="overflow-auto mt-2 hide-scroll" style="max-height:340px">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-gray-100"><tr>
              <th class="text-left p-1">Th·ªùi gian</th>
              <th class="text-left p-1">Lo·∫°i</th>
              <th class="text-left p-1">M√£ ƒë∆°n</th>
              <th class="text-right p-1">S·ªë m√≥n</th>
              <th class="text-right p-1">T·ªïng</th>
              <th class="text-left p-1">Ghi ch√∫</th>
            </tr></thead>
            <tbody id="revenueTable"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- ADMIN + DASHBOARD -->
    <section id="view-admin" class="hidden grid md:grid-cols-2 gap-6">
      <section class="bg-white rounded-2xl shadow-sm border p-5 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Dashboard (Realtime)</h2>
          <span class="text-xs text-gray-500">T·ª± c·∫≠p nh·∫≠t</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="border rounded-xl p-4"><p class="text-sm text-gray-500">T·ªïng ƒë∆°n h√¥m nay</p><p id="kpiOrders" class="text-3xl font-bold">‚Äî</p></div>
          <div class="border rounded-xl p-4"><p class="text-sm text-gray-500">Dung l∆∞·ª£ng local ∆∞·ªõc t√≠nh</p><p class="text-lg font-semibold"><span id="kpiStorage">‚Äî</span></p></div>
          <div class="border rounded-xl p-4"><p class="text-sm text-gray-500">Thi·∫øt b·ªã online</p><p id="kpiOnline" class="text-3xl font-bold">‚Äî</p></div>
          <div class="border rounded-xl p-4"><p class="text-sm text-gray-500">Ch·∫ø ƒë·ªô ƒë·ªìng b·ªô</p><p id="kpiBandwidth" class="text-lg font-semibold">Local only</p></div>
        </div>
      </section>

      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">C·∫•u h√¨nh qu√°n</h2>
        <label class="text-sm text-gray-700">S·ªë l∆∞·ª£ng b√†n</label>
        <input id="tablesInput" type="number" min="1" class="border rounded-lg px-3 py-2 w-40" />
        <div class="mt-3"><button id="btnSaveAdmin" class="px-4 py-2 rounded-lg bg-black text-white">L∆∞u</button></div>
        <p class="text-xs text-gray-500 mt-2">Menu l·∫•y t·ª´ <code>assets/menu.csv</code> ho·∫∑c CSV b·∫°n ch·ªçn khi ch·∫°y local.</p>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ghi ch√∫</h2>
        <p class="text-sm text-gray-600">‚Ä¢ D√≤ng c√≥ <strong>CategoryID=topping</strong> ho·∫∑c <strong>Category=Topping</strong> s·∫Ω th√†nh topping.<br/>‚Ä¢ ƒê∆°n = <em>delivered</em> khi m·ªçi <em>item</em> ƒë·ªÅu delivered.</p>
      </section>
    </section>
  </main>

  <!-- Pay Modal -->
  <div id="payModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-5 modal-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 id="payTitle" class="text-lg font-semibold">Thanh to√°n</h3>
        <button id="btnClosePay" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div id="payLines" class="space-y-2"></div>
      <div class="pt-2 mt-2 border-t flex items-center justify-between">
        <span class="font-semibold">T·ªïng</span>
        <span id="payTotal" class="font-bold">0‚Ç´</span>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelPay" class="px-4 py-2 rounded-lg border">ƒê√≥ng</button>
        <button id="btnConfirmPay" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </div>
  </div>

  <script>
    /* ========== Utils ========== */
    const STORAGE_KEY_CFG = 'tiemnuoctuiminh_pos_v1_html';
    const ORDERS_KEY = () => 'tnm_orders_'+new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'});
    const REVENUE_KEY = () => 'tnm_revenue_'+new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}).replaceAll('-','');
    const money = n => (n||0).toLocaleString('vi-VN')+'‚Ç´';
    const now = () => Date.now();
    const newId = p => p+'_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    const shortId = id => id ? id.slice(-6) : '';
    const fmtTime = ts => { try{ return new Date(ts).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); } catch{ return ''; } };
    const fmtISO = () => new Date().toLocaleString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}).replace('T',' ');
    const norm = (s)=> (s??'').toString().normalize('NFC').replace(/^\uFEFF/,'').trim();
    const normKey = (s)=> norm(s).toLowerCase();

    /* ========== Notifications & Sound (ONLY new-order) ========== */
    let AC=null, audioReady=false;
    function unlockAudioOnce(){
      if(audioReady) return;
      try{ AC = new (window.AudioContext||window.webkitAudioContext)(); audioReady = true; }catch{}
    }
    document.addEventListener('pointerdown', unlockAudioOnce, {once:true});
    document.addEventListener('keydown', unlockAudioOnce, {once:true});

	function ping(){
	  const audio = document.getElementById('soundBell');
	  if(!audio) return;
	  audio.currentTime = 0;
	  audio.play().catch(()=>{}); // tr√°nh l·ªói autoplay
	}


    const toastHost = document.getElementById('toastHost');
    function showToast(msg){
      const el=document.createElement('div');
      el.className='toast-enter bg-white border shadow rounded-lg px-3 py-2 text-sm max-w-xs';
      el.innerHTML=`<div class="flex items-start gap-2"><span>üîî</span><div class="flex-1">${msg}</div><button class="text-gray-400 hover:text-gray-700" onclick="this.closest('div.toast-enter').remove()">√ó</button></div>`;
      toastHost.appendChild(el); requestAnimationFrame(()=> el.classList.add('toast-enter-active'));
      setTimeout(()=> el.remove(), 3000);
    }
    function notifyNewOrder(order){
      const label = order.type==='takeaway' ? 'Mang v·ªÅ' : ('B√†n '+order.table);
      showToast(`C√≥ ƒë∆°n m·ªõi: ${label} ¬∑ ${order.items.length} m√≥n`);
      ping();
    }

    /* ========== Elements & State ========== */
    const els = {
      roleSelect: document.getElementById('roleSelect'),
      btnResetData: document.getElementById('btnResetData'),
      views: { staff:document.getElementById('view-staff'), barista:document.getElementById('view-barista'), cashier:document.getElementById('view-cashier'), admin:document.getElementById('view-admin') },
      tableSelect: document.getElementById('tableSelect'),
      catFilter: document.getElementById('catFilter'),
      searchInput: document.getElementById('searchInput'),
      menuGrid: document.getElementById('menuGrid'),
      cartTitle: document.getElementById('cartTitle'),
      cartList: document.getElementById('cartList'),
      cartTotal: document.getElementById('cartTotal'),
      btnSubmitOrder: document.getElementById('btnSubmitOrder'),
      recentOrders: document.getElementById('recentOrders'),
      tabByTable: document.getElementById('tabByTable'),
      tabByItem: document.getElementById('tabByItem'),
      baristaByTable: document.getElementById('baristaByTable'),
      baristaByItem: document.getElementById('baristaByItem'),
      cashierNotPaid: document.getElementById('cashierNotPaid'),
      cashierPaid: document.getElementById('cashierPaid'),
      cashierTotalToday: document.getElementById('cashierTotalToday'),
      tablesInput: document.getElementById('tablesInput'),
      btnSaveAdmin: document.getElementById('btnSaveAdmin'),
      revenueTable: document.getElementById('revenueTable'),
      dlRevenueBtn: document.getElementById('dlRevenueBtn'),
      payModal: document.getElementById('payModal'),
      payTitle: document.getElementById('payTitle'),
      payLines: document.getElementById('payLines'),
      payTotal: document.getElementById('payTotal'),
      btnClosePay: document.getElementById('btnClosePay'),
      btnCancelPay: document.getElementById('btnCancelPay'),
      btnConfirmPay: document.getElementById('btnConfirmPay'),
      kpiOrders: document.getElementById('kpiOrders'),
      kpiStorage: document.getElementById('kpiStorage'),
      kpiOnline: document.getElementById('kpiOnline'),
      kpiBandwidth: document.getElementById('kpiBandwidth'),
    };
	// === Quick Filter UI (orange when active)
const QF_ON  = ['bg-orange-100','text-orange-700','border-orange-300'];
const QF_OFF = ['bg-white','text-gray-700','border-gray-300'];
// K√≠ch th∆∞·ªõc/n√©t to cho quick filter
const QF_SIZE = ['px-4','py-2.5','text-base','rounded-xl','font-medium','shadow-sm','min-w-[112px]','h-11'];

function setQFState(btn, active){
  // b·ªè h·∫øt l·ªõp c≈© r·ªìi √°p k√≠ch th∆∞·ªõc + vi·ªÅn + tr·∫°ng th√°i
  btn.className = 'qf'; // gi·ªØ l·∫°i class qf ƒë·ªÉ code kh√°c v·∫´n t√¨m ƒë∆∞·ª£c
  btn.classList.add('border', ...QF_SIZE, ...(active ? QF_ON : QF_OFF));
}




// G·ªçi sau m·ªói l·∫ßn renderStaff ho·∫∑c ƒë·ªïi category ƒë·ªÉ t√¥ m√†u n√∫t ƒëang ch·ªçn
function updateQuickFiltersUI(){
  const curLabel = [...els.catFilter.options]
    .find(o => o.value === els.catFilter.value)?.textContent.trim();
  document.querySelectorAll('.qf').forEach(b=>{
    setQFState(b, b.textContent.trim() === curLabel);
  });
}
// === Dropdown & Cart color styling ===
function tintDropdowns(){
  // Category dropdown = cam nh·∫°t
  els.catFilter.classList.add('bg-orange-50','border-orange-300','text-amber-800');
  // B√†n dropdown = xanh l√°
  els.tableSelect.classList.add('bg-emerald-100','border-emerald-300','text-emerald-800','font-medium');
}

function updateCartTitle(){
  const label = els.tableSelect.value==='takeaway'
    ? 'Mang v·ªÅ'
    : `B√†n ${els.tableSelect.value}`;
  els.cartTitle.innerHTML = `Gi·ªè h√†ng ¬∑ <span class="text-emerald-700 font-semibold">${label}</span>`;
}

    const ROLES = ['staff','barista','cashier','admin'];
    let role = (sessionStorage.getItem('tn_role')||'staff');
    const qsRole = new URLSearchParams(location.search).get('role');
    const hashRole = location.hash.replace(/^#role=/,'');
    [qsRole,hashRole].some(v=>{ if(ROLES.includes(String(v))) { role=String(v); return true; } return false; });

    let cfg = loadCfg();
    let menuRows = [];     // raw from CSV
    let menuIndex = {};    // item -> {category,_key,sizes[]}
    let toppings = [];     // [{name,price}]
    let cart = [];         // order draft items
    let baristaTab = 'table';
    let viewingGroup = null;

    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('tnm_pos') : null;
    if(bc){
  bc.addEventListener('message', e=>{
    if(e?.data?.type==='orders-updated'){ refreshAll(); }
    if(e?.data?.type==='revenue-updated'){ renderCashier(); } // ƒë·ªïi t√™n h√†m ·ªü ƒë√¢y
  });
}


    function loadCfg(){ try{ const raw=JSON.parse(localStorage.getItem(STORAGE_KEY_CFG)||'{}'); return { tables: raw.tables||20, mode: raw.mode||'local' }; }catch{ return { tables:20, mode:'local' }; } }
    function saveCfg(){ localStorage.setItem(STORAGE_KEY_CFG, JSON.stringify({ tables: cfg.tables, mode: cfg.mode })); }

    /* ========== Local Dev Detection & CSV from file ========== */
    const IS_FILE = location.protocol === 'file:';
    let DEV_FORCE = false;
    function showDevPanel(show=true){ const p=document.getElementById('devPanel'); if(!p) return; p.classList.toggle('hidden', !show); }
    async function importCSVFromFile(file){ const text = await file.text(); await parseCSVTextAndCache(text); buildMenuIndex(); await refreshAll(); }
    async function parseCSVTextAndCache(raw){
      const lines = raw.split(/\r?\n/).filter(l=>norm(l).length>0);
      if(!lines.length){ menuRows=[]; localStorage.removeItem('tnm_menu_csv_cache'); return; }
      const head = lines[0];
      const DELIM = ((head.match(/;/g)||[]).length > (head.match(/,/g)||[]).length) ? ';' : ',';
      const splitCSV = (line, d)=>{ let out=[], cur='', q=false; for(const ch of line){ if(ch==='\"'){ q=!q; continue; } if(ch===d && !q){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out; };
      const headers = splitCSV(head, DELIM).map(c=>norm(c));
      const hIdx = Object.fromEntries(headers.map((h,i)=>[normKey(h), i]));
      const rows=[];
      for(let i=1;i<lines.length;i++){
        const cells = splitCSV(lines[i], DELIM);
        const catId  = norm(cells[hIdx['categoryid'] ?? -1] ?? '');
        const catLbl = norm(cells[hIdx['category']   ?? 0]  ?? '');
        const item   = norm(cells[hIdx['item']       ?? 1]  ?? '');
        const size   = norm(cells[hIdx['size']       ?? 2]  ?? '');
        const priceRaw = norm(cells[hIdx['price']    ?? 3]  ?? '');
        if(!(catLbl||catId) || !item) continue;
        const num = Number(priceRaw.replace(/[^\d.,-]/g,'').replace(/\./g,'').replace(',', '.'));
        const price = Number.isFinite(num) ? num : 0;
        const catKey = catId ? normKey(catId) : normKey(catLbl);
        rows.push({ categoryId: catId || null, category: catLbl || (catId||''), item, size, price, _key: catKey, _ck: normKey(catLbl) });
      }
      menuRows = rows;
      localStorage.setItem('tnm_menu_csv_cache', JSON.stringify({etag:Date.now(), rows}));
    }

    /* ========== DB Adapters (Local default, Firebase optional) ========== */
    const DB = window.FIREBASE_CONFIG ? FirebaseAdapter() : LocalAdapter();
    function LocalAdapter(){
      function _load(){ return JSON.parse(localStorage.getItem(ORDERS_KEY()) || '[]'); }
      function _save(arr){ localStorage.setItem(ORDERS_KEY(), JSON.stringify(arr)); bc?.postMessage({type:'orders-updated'}); }
      return {
        async list(){ return _load(); },
        async push(order){ const arr=_load(); arr.push(order); _save(arr); try{ notifyNewOrder(order); }catch{} return true; },
        async setItemStatus(orderId, itemIdx, status){
          const arr=_load(); const i=arr.findIndex(o=>o.id===orderId); if(i<0) return false;
          arr[i].items[itemIdx].itemStatus=status;
          if(arr[i].items.every(x=>x.itemStatus==='delivered')) arr[i].status='delivered';
          _save(arr); return true;
        },
        async markPaidGroup(group){ const arr=_load(); let changed=false;
          for(const o of arr){
            if(o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table))){
              o.status='paid'; changed=true; Revenue.record(o);
            }
          }
          if(changed){ _save(arr); bc?.postMessage({type:'revenue-updated'}); }
          return changed;
        },
        async resetToday(){ localStorage.removeItem(ORDERS_KEY()); bc?.postMessage({type:'orders-updated'}); }
      };
    }
    function RevenueAdapterLocal(){
      return {
        record(order){
          const key = REVENUE_KEY();
          const pack = JSON.parse(localStorage.getItem(key) || '{"entries":{},"summary":{"totalOrders":0,"totalAmount":0}}');
          const amount = order.items.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
          pack.entries[order.id] = {
            orderId: order.id,
            tableOrTakeAway: order.type==='takeaway'?'Mang v·ªÅ':`B√†n ${order.table}`,
            items: order.items.map(i=>({name:i.name,size:i.size,qty:i.qty})),
            amount, paidAt: fmtISO()
          };
          const entries = Object.values(pack.entries);
          pack.summary = { totalOrders: entries.length, totalAmount: entries.reduce((s,e)=>s+(e.amount||0),0) };
          localStorage.setItem(key, JSON.stringify(pack));
        },
        load(){ const key = REVENUE_KEY(); return JSON.parse(localStorage.getItem(key) || '{"entries":{},"summary":{"totalOrders":0,"totalAmount":0}}'); }
      };
    }
    const Revenue = RevenueAdapterLocal();

    function FirebaseAdapter(){ return {
      async list(){ return window.firebaseApi?.ready ? window.firebaseApi.listOrders() : LocalAdapter().list(); },
      async push(order){ if(window.firebaseApi?.ready) return window.firebaseApi.pushOrder(order); return LocalAdapter().push(order); },
      async setItemStatus(orderId, idx, status){ if(window.firebaseApi?.ready) return window.firebaseApi.setItemStatus(orderId, idx, status); return LocalAdapter().setItemStatus(orderId, idx, status); },
      async markPaidGroup(group){ if(window.firebaseApi?.ready) return window.firebaseApi.markPaidGroup(group); return LocalAdapter().markPaidGroup(group); },
      async resetToday(){ if(window.firebaseApi?.ready) return window.firebaseApi.resetToday(); return LocalAdapter().resetToday(); }
    } }

    /* ========== CSV Loader + Indexer ========== */
    async function loadMenuCSV(){
      const cache = JSON.parse(localStorage.getItem('tnm_menu_csv_cache')||'null');
      if(cache?.rows?.length && !(IS_FILE || DEV_FORCE)){ menuRows = cache.rows; buildMenuIndex(); return; }
      if(!IS_FILE && !DEV_FORCE){
        try{
          const res = await fetch('assets/menu.csv?ts='+Date.now());
          if(!res.ok) throw new Error(res.status);
          const raw = await res.text();
          await parseCSVTextAndCache(raw); buildMenuIndex(); return;
        }catch(e){ console.warn('Fetch CSV failed, switch to Dev Mode', e); DEV_FORCE = true; }
      }
      showDevPanel(true);
      const cached = JSON.parse(localStorage.getItem('tnm_menu_csv_cache')||'null');
      if(cached?.rows){ menuRows=cached.rows; buildMenuIndex(); }
    }
    function buildMenuIndex(){
      const idx = {}; const tops = [];
      for(const r of menuRows){
        const isTop = (r._key === 'topping' || r._ck === 'topping');
        if(isTop){ tops.push({ name:r.item, price:r.price }); continue; }
        if(!idx[r.item]) idx[r.item] = { category: r.category, _key: r._key, sizes: [] };
        idx[r.item].sizes.push({ size: r.size, price: r.price });
      }
      menuIndex = idx; toppings = tops;
    }

	    /* ========== Renderers ========== */
function renderRole(){
  Object.values(els.views).forEach(v=>v.classList.add('hidden'));
  els.views[role].classList.remove('hidden');
  els.roleSelect.value = role;

  // CH·ªà hi·ªán n√∫t üõí trong header khi role = staff
  const cartBtnHeader = document.getElementById('btnJumpCartHeader');
  if (cartBtnHeader) cartBtnHeader.classList.toggle('hidden', role !== 'staff');
}
		// Hi·ªán n√∫t üõí trong header ch·ªâ khi role = staff
const cartBtnHeader = document.getElementById('btnJumpCartHeader');
if (cartBtnHeader) {
  cartBtnHeader.classList.toggle('hidden', role !== 'staff');
}

	
	    function renderCart(){
	      const list = els.cartList;
	      if(!cart.length){ list.textContent='Ch∆∞a c√≥ m√≥n.'; els.cartTotal.textContent='0‚Ç´'; return; }
	      list.innerHTML = cart.map((it,idx)=>{
	        const tops = (it.toppings||[]).map(t=>`${t.name}(+${money(t.price)})`).join(', ');
	        const sum = (it.basePrice + (it.toppings||[]).reduce((s,x)=>s+x.price,0))*it.qty;
	        return `<div class="py-2 flex items-start gap-2 border-b last:border-0">
	          <div class="flex-1">
	            <div class="text-sm font-medium">${it.name} ‚Äî ${it.size} √ó ${it.qty}</div>
	            <div class="text-xs text-gray-500">${tops || (it.note?it.note:'')}</div>
	          </div>
	          <div class="text-right">
	            <div class="text-sm font-semibold">${money(sum)}</div>
	            <button data-rm="${idx}" class="text-xs text-red-600">X√≥a</button>
	          </div>
	        </div>`;
	      }).join('');
	      list.querySelectorAll('[data-rm]').forEach(b=> b.onclick=()=>{
	  cart.splice(Number(b.dataset.rm),1);
	  renderCart();
	  syncAllCardQty(); // c·∫≠p nh·∫≠t s·ªë tr√™n c√°c card sau khi x√≥a
	});
	
	      const total = cart.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
	      els.cartTotal.textContent = money(total);
		  updateCartTitle();
		  updateCartButtonBadge();

	    }
	
	    async function renderMyOrders(){
	      const orders = await DB.list();
	      const mine = orders.filter(o=>o.status!=='paid').slice().reverse();
	      els.recentOrders.innerHTML = mine.map(o=>{
	        const delivered = o.items.filter(i=>i.itemStatus==='delivered').length;
	        const badge = o.type==='takeaway'
	          ? `<span class="badge border bg-amber-100 text-amber-700 border-amber-300 px-2 py-0.5 rounded">Mang v·ªÅ</span>`
	          : `<span class="badge border bg-blue-100 text-blue-700 border-blue-300 px-2 py-0.5 rounded">B√†n ${o.table}</span>`;
	        return `<div class="flex items-center justify-between border rounded-lg p-3">
	          <div><p class="font-medium">#${shortId(o.id)}</p><p class="text-xs text-gray-500">${delivered}/${o.items.length} m√≥n ƒë√£ giao</p></div>
	          <div class="flex items-center gap-2">${badge}</div></div>`;
	      }).join('') || '<p class="text-sm text-gray-500">‚Äî</p>';
	    }
	
	// ƒê·∫øm t·ªïng s·ªë l∆∞·ª£ng m√≥n trong gi·ªè
function cartItemCount(){
  // t√≠nh t·ªïng qty c·ªßa t·∫•t c·∫£ item trong gi·ªè
  return cart.reduce((sum, it) => sum + (Number(it.qty) || 0), 0);
}

// C·∫≠p nh·∫≠t hi·ªÉn th·ªã con s·ªë tr√™n n√∫t üõí Xem gi·ªè
function updateCartButtonBadge(){
  const n = cartItemCount();
  const txt = n ? `(${n})` : '';

  const el1 = document.getElementById('cartCount');        // n√∫t trong "Ch·ªçn b√†n & Menu"
  if (el1) el1.textContent = txt;

  const el2 = document.getElementById('cartCountHeader');  // n√∫t ·ªü header
  if (el2) el2.textContent = txt;
}


	
			function itemSignature(name, size, topsArr, note, basePrice){
			  const tops = (topsArr||[])
			    .map(t=>`${norm(t.name).toLowerCase()}|${Number(t.price)||0}`)
			    .sort()
			    .join(';');
			  return [
			    norm(name).toLowerCase(),
			    norm(size||''),
			    tops,
			    norm((note||'').trim()),
			    Number(basePrice)||0
			  ].join('::');
			}
	
			function getCardSelection(card){
			  const name = card.querySelector('.font-semibold')?.textContent.trim() || '';
			  const [size, price] = (card.querySelector('.sizeSel')?.value || '').split('|');
			  const note = (card.querySelector('.noteTxt')?.value || '').trim();
			  const basePrice = Number(price || 0);
			  const tops = Array.from(card.querySelectorAll('.topping-cb:checked')).map(cb=>{
			    const [tn,tp] = cb.dataset.top.split('|');
			    return { name: tn, price: Number(tp || 0) };
			  });
			  return { name, size, note, basePrice, tops };
			}
			
			function syncCardQtyFromCart(card){
			  const sel = getCardSelection(card);
			  const sig = itemSignature(sel.name, sel.size, sel.tops, sel.note, sel.basePrice);
			  const it = cart.find(i => itemSignature(i.name, i.size, i.toppings, i.note, i.basePrice) === sig);
			  const qtyVal = card.querySelector('.qtyVal');
			  if (!qtyVal) return;
			  qtyVal.textContent = it ? String(it.qty) : '1';
			}
			
			function syncAllCardQty(){
			  Array.from(els.menuGrid.children).forEach(syncCardQtyFromCart);
			}
	
			
			function resetAllMenuCards(){
			  Array.from(els.menuGrid.children).forEach(card=>{
			    const qtyVal = card.querySelector('.qtyVal');
			    const noteTxt = card.querySelector('.noteTxt');
			    const sizeSel = card.querySelector('.sizeSel');
			    const tops    = card.querySelectorAll('.topping-cb');
			    if(qtyVal) qtyVal.textContent = '1';
			    if(noteTxt) noteTxt.value = '';
			    if(sizeSel) sizeSel.selectedIndex = 0;
			    tops.forEach(cb=> cb.checked = false);
				delete card.dataset.addedOnce;
			  });
			}
	

    function renderStaff(){
		// S·∫Øp x·∫øp: B√†n 1 ‚Üí N r·ªìi m·ªõi Mang v·ªÅ
		const prevSel = els.tableSelect.value; // gi·ªØ l·∫°i l·ª±a ch·ªçn tr∆∞·ªõc (n·∫øu c√≥)
		els.tableSelect.innerHTML =
		  Array.from({ length: cfg.tables }, (_, i) => `<option value="${i + 1}">B√†n ${i + 1}</option>`).join('') +
		  `<option value="takeaway">Mang v·ªÅ</option>`;
		
		// N·∫øu l·ª±a ch·ªçn tr∆∞·ªõc kh√¥ng c√≤n, m·∫∑c ƒë·ªãnh l√† B√†n 1
		if ([...els.tableSelect.options].some(o => o.value === prevSel)) {
		  els.tableSelect.value = prevSel;
		} else {
		  els.tableSelect.value = '1';
		}
		
		// C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ gi·ªè h√†ng
		updateCartTitle();


      const catMap = new Map();
      for(const r of menuRows){ if(r._key && r._key!=='topping') catMap.set(r._key, r.category); }
      const prevKey = els.catFilter.dataset.key || '__all__';
      els.catFilter.innerHTML = `<option value="__all__">T·∫•t c·∫£</option>` + Array.from(catMap.entries()).map(([k,l])=>`<option value="${k}">${l}</option>`).join('');
      els.catFilter.value = catMap.has(prevKey) ? prevKey : '__all__';
      els.catFilter.dataset.key = els.catFilter.value;

      const kw = norm(els.searchInput.value||'').toLowerCase();
      const catKey = els.catFilter.value;

      const items = Object.entries(menuIndex)
        .filter(([name,info])=> ((catKey==='__all__') || (info._key === catKey)) && (!kw || norm(name).toLowerCase().includes(kw)))
        .map(([name,info])=>({name, ...info}));

      els.menuGrid.innerHTML = items.map(it=>{
        const sizeOpts = it.sizes.map(s=>`<option value="${s.size}|${s.price}">${s.size||'M·∫∑c ƒë·ªãnh'} ‚Äî ${money(s.price)}</option>`).join('');
        const topOpts = (toppings.length
          ? toppings.map(t=>`<label class="flex items-center gap-2 text-xs"><input type="checkbox" data-top="${t.name}|${t.price}" class="topping-cb"><span>${t.name} <span class="text-gray-500">+${money(t.price)}</span></span></label>`).join('')
          : '<p class="text-xs text-gray-400">Ch∆∞a c√≥ topping</p>');
        return `
		
		<div class="border rounded-xl p-4 hover:shadow-sm flex flex-col gap-2 h-full">
  <div class="flex items-start justify-between gap-3"><div><h3 class="font-semibold text-gray-900">${it.name}</h3></div></div>
  <select class="sizeSel w-full border rounded px-2 py-1">${sizeOpts}</select>
  <textarea class="noteTxt w-full border rounded px-2 py-1 text-sm" rows="1" placeholder="Ghi ch√∫ (tu·ª≥ ch·ªçn)"></textarea>
  <details class="rounded border p-2"><summary class="text-xs cursor-pointer">Th√™m topping</summary><div class="mt-2 grid grid-cols-1 gap-1 max-h-28 overflow-auto">${topOpts}</div></details>
  <div class="mt-auto pt-2 flex items-center justify-between">
    <div class="flex items-center gap-2"><button class="qtyDec px-2 py-1 border rounded">-</button><span class="qtyVal w-6 text-center">1</span><button class="qtyInc px-2 py-1 border rounded">+</button></div>
    <button class="addBtn px-3 py-1 rounded-lg bg-black text-white text-sm">Th√™m</button>
  </div>
</div>

        </div>`;
      }).join('');

      Array.from(els.menuGrid.children).forEach(card=>{
        const qtyVal = card.querySelector('.qtyVal');
        card.querySelector('.qtyDec').onclick = ()=>{ const n=Math.max(1,(+qtyVal.textContent||1)-1); qtyVal.textContent=n; };
        card.querySelector('.qtyInc').onclick = ()=>{ const n=(+qtyVal.textContent||1)+1; qtyVal.textContent=n; };
		// ƒê·ªìng b·ªô s·ªë ·ªü card khi ƒë·ªïi c·∫•u h√¨nh (size / note / topping)
		const sizeSel = card.querySelector('.sizeSel');
		const noteTxt = card.querySelector('.noteTxt');
		
		sizeSel?.addEventListener('change', ()=> syncCardQtyFromCart(card));
		noteTxt?.addEventListener('input',  ()=> syncCardQtyFromCart(card));
		
		card.querySelectorAll('.topping-cb').forEach(cb=>{
		  cb.addEventListener('change', ()=> syncCardQtyFromCart(card));
		});

card.querySelector('.addBtn').onclick = ()=>{
  // L·∫•y c·∫•u h√¨nh hi·ªán t·∫°i c·ªßa card
  const name    = card.querySelector('.font-semibold').textContent.trim();
  const [size, price] = (card.querySelector('.sizeSel').value||'').split('|');
  const basePrice = Number(price||0);

  const qtyEl   = card.querySelector('.qtyVal');
  const noteEl  = card.querySelector('.noteTxt');
  const qty     = Math.max(1, Number(qtyEl.textContent)||1); // n·∫øu ch∆∞a b·∫•m +/- th√¨ = 1
  const note    = (noteEl.value||'').trim();

  const topCbs  = card.querySelectorAll('.topping-cb:checked');
  const tops = Array.from(topCbs).map(cb=>{
    const [tn,tp] = cb.dataset.top.split('|');
    return { id:newId('tp'), name:tn, price:Number(tp||0) };
  });

  // G·ªôp theo ch·ªØ k√Ω
  const sig = itemSignature(name, size, tops, note, basePrice);
  const found = cart.find(it => itemSignature(it.name, it.size, it.toppings, it.note, it.basePrice) === sig);
  if(found){ found.qty += qty; }
  else { 
    cart.push({ 
      menuItemId:newId('mi'), 
      name, size, basePrice, qty, toppings:tops, note, itemStatus:'queued' 
    }); 
  }

  // C·∫≠p nh·∫≠t gi·ªè
  renderCart();

  // ==== Y√äU C·∫¶U M·ªöI ====
  // 1Ô∏è‚É£ Reset s·ªë v·ªÅ 1 ƒë·ªÉ l·∫ßn sau ch·ªâ c·ªông +1 (tr·ª´ khi b·∫°n t·ª± tƒÉng gi·∫£m tr∆∞·ªõc)
  qtyEl.textContent = '1';
  // 2Ô∏è‚É£ X√≥a ghi ch√∫
  noteEl.value = '';
  // 3Ô∏è‚É£ B·ªè ch·ªçn to√†n b·ªô topping
  card.querySelectorAll('.topping-cb').forEach(cb => cb.checked = false);
  // 4Ô∏è‚É£ ƒê√≥ng ph·∫ßn "Th√™m topping"
  const detailsEl = card.querySelector('details');
  if (detailsEl && detailsEl.open) detailsEl.open = false;
  // (Kh√¥ng reset size)
};


		});

      renderCart(); renderMyOrders();
    }

    async function loadOrders(){ return await DB.list(); }

    // ===== Barista (v2.2) =====
    async function renderBarista(){
      els.tabByTable.classList.toggle('bg-black', baristaTab==='table');
      els.tabByTable.classList.toggle('text-white', baristaTab==='table');
      els.tabByItem.classList.toggle('bg-black', baristaTab==='item');
      els.tabByItem.classList.toggle('text-white', baristaTab==='item');

      const ordersAll = await loadOrders();
      const active = ordersAll.filter(o => o.status !== 'paid');

      const queueOrders = active.filter(o => o.items.some(it => it.itemStatus !== 'delivered'));
      const deliveredOrders = active.filter(o => o.items.every(it => it.itemStatus === 'delivered'));

      const queueSorted = queueOrders.slice().sort((a,b)=> a.createdAt - b.createdAt);
      const qpos = new Map(queueSorted.map((o,i)=> [o.id, i+1]));

      // BY TABLE (queue)
      const baristaWrap = els.baristaByTable;
      baristaWrap.innerHTML = '';
      if(!queueOrders.length){
        baristaWrap.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n ch·ªù pha ch·∫ø.</p>';
      }else{
        const grouped = new Map();
        queueOrders.forEach(o=>{ const k = o.type==='takeaway' ? 'takeaway' : `table-${o.table}`; const arr = grouped.get(k)||[]; arr.push(o); grouped.set(k,arr); });
        for(const [,arr] of grouped){ arr.sort((a,b)=> a.createdAt-b.createdAt); arr.forEach((o,i)=> o.__supp = i>0); }

        const entries = Array.from(grouped.entries()).sort((a,b)=>{
          if(a[0]==='takeaway') return -1; if(b[0]==='takeaway') return 1;
          return Number(a[0].split('-')[1]) - Number(b[0].split('-')[1]);
        });

        entries.forEach(([key, orders])=>{
          const title = key==='takeaway' ? 'Mang v·ªÅ' : `B√†n ${key.split('-')[1]}`;
          const priBadge = key==='takeaway' ? `<span class="badge border bg-amber-100 text-amber-700 border-amber-300 px-2 py-0.5 rounded">∆Øu ti√™n</span>` : '';
          const col = document.createElement('div');
          col.className='border rounded-xl p-4';
          col.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <h3 class="font-semibold">${title}</h3>
              <div class="flex items-center gap-2">
                ${priBadge}
                <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${orders.length} ƒë∆°n</span>
              </div>
            </div>
            <div class="space-y-3"></div>`;
          const list = col.querySelector('.space-y-3');

          orders.forEach(o=>{
            const itemsHtml = o.items.map((it,idx)=>{
              const tops = (it.toppings||[]);
              const topsLine = tops.length
                ? `<div class="text-xs text-gray-500 ml-5">${tops.map(t=>t.name).join(', ')}${it.note ? ' ¬∑ '+it.note : ''}</div>`
                : (it.note ? `<div class="text-xs text-gray-500 ml-5">${it.note}</div>` : '');
              const delivered = it.itemStatus==='delivered';
              return `<li class="list-disc list-inside">
                  ${it.name} √ó ${it.qty}
                  ${topsLine}
                  ${delivered ? `<div class="mt-1 ml-5 text-xs text-emerald-700">ƒê√£ giao</div>` : ``}
                  <div class="mt-1 ml-5 flex items-center justify-end">
                    <button data-deliver="${o.id}|${idx}" class="text-xs px-3 py-1 rounded ${delivered?'bg-emerald-200 text-emerald-800 pointer-events-none':'bg-emerald-600 text-white'}">
                      ƒê√£ giao
                    </button>
                  </div>
                </li>`;
            }).join('');

            list.innerHTML += `
              <div class="rounded-lg border p-3">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <span class="w-7 h-7 rounded-full bg-black text-white text-xs grid place-items-center font-semibold">${qpos.get(o.id)||''}</span>
                    <p class="text-sm text-gray-700">#${shortId(o.id)} ¬∑ ${o.__supp ? 'B·ªï sung' : 'ƒê∆°n ƒë·∫ßu'} ¬∑ ${fmtTime(o.createdAt)}</p>
                  </div>
                </div>
                <ul class="mt-2 text-sm">${itemsHtml}</ul>
                <div class="mt-3"><button data-deliver-all="${o.id}" class="px-3 py-1 rounded-lg border">Giao h·∫øt</button></div>
              </div>`;
          });

          baristaWrap.appendChild(col);
        });

        baristaWrap.querySelectorAll('[data-deliver]').forEach(btn=> btn.onclick = async ()=>{
          const [oid, idx] = btn.dataset.deliver.split('|');
          await DB.setItemStatus(oid, Number(idx), 'delivered');
          refreshAll();
        });
        baristaWrap.querySelectorAll('[data-deliver-all]').forEach(btn=> btn.onclick = async ()=>{
          const oid = btn.dataset.deliverAll;
          const orders = await loadOrders(); const o = orders.find(x=>x.id===oid); if(!o) return;
          for(let i=0;i<o.items.length;i++){ if(o.items[i].itemStatus!=='delivered') await DB.setItemStatus(oid,i,'delivered'); }
          refreshAll();
        });
      }

      // BY ITEM (queue)
      const byItemHost = els.baristaByItem;
      const occurrences = [];
      queueOrders.forEach(o=> o.items.forEach((it,idx)=> occurrences.push({order:o, idx, name:it.name, qty:it.qty})));
      occurrences.sort((a,b)=> a.order.createdAt - b.order.createdAt);
      const groups = new Map();
      occurrences.forEach(r=>{ const g = groups.get(r.name) || { total:0, rows:[] }; g.total += r.qty; g.rows.push(r); groups.set(r.name, g); });
      byItemHost.innerHTML = Array.from(groups.entries()).map(([name,g])=>{
        const rows = g.rows.map(r=>`
            <div class="flex items-center justify-between text-sm">
              <div class="flex items-center gap-2">
                <span class="w-6 h-6 rounded-full bg-black text-white grid place-items-center text-[10px]">${qpos.get(r.order.id)||''}</span>
                <span>${r.order.type==='takeaway' ? 'Mang v·ªÅ' : `B√†n ${r.order.table}`} ¬∑ #${shortId(r.order.id)} ${r.order.__supp?'¬∑ B·ªï sung':''} ¬∑ ${fmtTime(r.order.createdAt)} ¬∑ √ó${r.qty}</span>
              </div>
            </div>`).join('');
        return `<div class="border rounded-xl p-4"><div class="flex items-center justify-between mb-2"><h4 class="font-semibold">${name}</h4><span class="text-sm font-bold">${g.total}</span></div><div class="space-y-1">${rows}</div></div>`;
      }).join('') || '<p class="text-sm text-gray-500">Kh√¥ng c√≥ m√≥n.</p>';

      // DELIVERED ¬∑ CH·ªú THANH TO√ÅN
      const toPayHost = document.getElementById('baristaToPay');
      if (toPayHost) {
        const mapPay = new Map();
        deliveredOrders.forEach(o => {
          const k = o.type === 'takeaway' ? 'takeaway' : `table-${o.table}`;
          const arr = mapPay.get(k) || [];
          arr.push(o); mapPay.set(k, arr);
        });

        toPayHost.innerHTML = '';
        if (!mapPay.size) {
          toPayHost.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n ch·ªù thanh to√°n.</p>';
        } else {
          for (const [key, arr] of mapPay) {
            const type = key === 'takeaway' ? 'takeaway' : 'table';
            const title = key === 'takeaway' ? 'Mang v·ªÅ' : `B√†n ${key.split('-')[1]}`;
            const amount = arr.reduce((s, o) =>
              s + o.items.reduce((s2, it) =>
                s2 + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0)) * it.qty, 0), 0);

            const wrap = document.createElement('div');
            wrap.className = 'border rounded-lg p-3 flex items-center justify-between';
            wrap.innerHTML = `
              <div>
                <p class="font-semibold">${title} ¬∑ ${arr.length} ƒë∆°n</p>
                <p class="text-xs text-gray-500">
                  ${arr.map(o => `#${shortId(o.id)} (${fmtTime(o.createdAt)})`).join(' ¬∑ ')}
                </p>
              </div>
              <div class="flex items-center gap-3">
                <span class="font-bold">${money(amount)}</span>
                <button data-b-pay="${type}|${title.includes('B√†n')?Number(title.replace('B√†n ','')):''}"
                        class="px-3 py-1 rounded-lg bg-emerald-600 text-white">
                  Thanh to√°n ${title}
                </button>
              </div>`;
            toPayHost.appendChild(wrap);
          }
        }

        toPayHost.onclick = (e) => {
          const btn = e.target.closest('[data-b-pay]');
          if (!btn) return;
          const [type, tableStr] = btn.dataset.bPay.split('|');
          openPayGroup({ type, table: tableStr ? Number(tableStr) : null });
        };
      }

      els.baristaByTable.classList.toggle('hidden', baristaTab!=='table');
      els.baristaByItem.classList.toggle('hidden',  baristaTab!=='item');
    }

    let cashierBound=false;
    async function renderCashier(){
      const orders = await loadOrders();
      const delivered = orders.filter(o=>o.status==='delivered');
      const paid = orders.filter(o=>o.status==='paid');

      const map = new Map();
      delivered.forEach(o=>{ const k=o.type==='takeaway'?'takeaway':`table-${o.table}`; const arr=map.get(k)||[]; arr.push(o); map.set(k,arr); });
      els.cashierNotPaid.innerHTML = '';
      for(const [key, arr] of map){
        const type = key==='takeaway'?'takeaway':'table';
        const title = key==='takeaway'?'Mang v·ªÅ':`B√†n ${key.split('-')[1]}`;
        const amount = arr.reduce((s,o)=> s+o.items.reduce((s2,it)=> s2+(it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty,0), 0);
        const wrap = document.createElement('div');
        wrap.className='border rounded-lg p-3 flex items-center justify-between';
        wrap.innerHTML = `<div><p class="font-semibold">${title} ¬∑ ${arr.length} ƒë∆°n</p><p class="text-xs text-gray-500">${arr.map(o=>`#${shortId(o.id)} (${fmtTime(o.createdAt)})`).join(' ¬∑ ')}</p></div><div class="flex items-center gap-3"><span class="font-bold">${money(amount)}</span><button data-pay="${type}|${title.includes('B√†n')?Number(title.replace('B√†n ','')):''}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Thanh to√°n ${title}</button></div>`;
        els.cashierNotPaid.appendChild(wrap);
      }
      if(!map.size) els.cashierNotPaid.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</p>';

      if(!cashierBound){
        els.cashierNotPaid.addEventListener('click',(e)=>{ const btn=e.target.closest('[data-pay]'); if(!btn) return; const [type,tableStr]=btn.dataset.pay.split('|'); openPayGroup({type, table: tableStr?Number(tableStr):null}); });
        cashierBound=true;
      }

      const pack = Revenue.load();
      const entries = Object.values(pack.entries||{}).sort((a,b)=> a.paidAt.localeCompare(b.paidAt));
      els.revenueTable.innerHTML = entries.map(e=>{
        const itemCount = e.items.reduce((s,x)=>s+(x.qty||1),0);
        return `<tr><td class="p-1">${e.paidAt}</td><td class="p-1">${e.tableOrTakeAway}</td><td class="p-1">#${shortId(e.orderId)}</td><td class="p-1 text-right">${itemCount}</td><td class="p-1 text-right">${money(e.amount)}</td><td class="p-1"></td></tr>`;
      }).join('');
      els.cashierTotalToday.textContent = `T·ªïng: ${money(pack.summary?.totalAmount||0)}`;

      const bytes = new Blob([JSON.stringify(localStorage)]).size;
      els.kpiStorage.textContent = (bytes/1024).toFixed(1)+' KB';
      els.kpiOnline.textContent = window.FIREBASE_CONFIG ? '‚âà realtime' : '‚Äî';
      els.kpiBandwidth.textContent = window.FIREBASE_CONFIG ? 'Cloud sync' : 'Local only';

      els.kpiOrders.textContent = String(orders.length);
    }

    function openPayGroup(group){
      viewingGroup = group;
      DB.list().then(orders=>{
        const list = orders.filter(o=> o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table))).sort((a,b)=>a.createdAt-b.createdAt);
        if(!list.length){ alert('Kh√¥ng c√≥ ƒë∆°n ƒë·ªÉ thanh to√°n.'); return; }
        els.payTitle.textContent = `Thanh to√°n ¬∑ ${group.type==='takeaway'?'Mang v·ªÅ':'B√†n '+group.table} (${list.length} ƒë∆°n)`;
        els.payLines.innerHTML = list.map(o=>`<div class="border rounded-lg p-2"><div class="flex items-center justify-between"><span class="text-sm text-gray-600">#${shortId(o.id)} ¬∑ ${fmtTime(o.createdAt)}</span></div><div class="mt-1 space-y-1 text-sm">${o.items.map(it=>{const sub=(it.basePrice+(it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty; return `<div class="flex items-center justify-between"><span>${it.name} ‚Äî ${it.size} √ó ${it.qty}</span><span class="font-medium">${money(sub)}</span></div>`}).join('')}</div></div>`).join('');
        const total = list.reduce((s,o)=> s + o.items.reduce((s2,it)=> s2+(it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty,0), 0);
        els.payTotal.textContent = money(total);
        els.payModal.classList.remove('hidden'); els.payModal.classList.add('flex');
        requestAnimationFrame(()=> els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'));
      });
    }
    function closePay(){ viewingGroup=null; els.payModal.classList.add('hidden'); els.payModal.classList.remove('flex'); els.payModal.querySelector('.modal-enter')?.classList.remove('modal-enter-active'); }
    async function confirmPay(){ if(!viewingGroup) return; await DB.markPaidGroup(viewingGroup); closePay(); refreshAll(); }

    function downloadRevenueCSV(){
      const pack = Revenue.load();
      const rows = [['paidAt','type','tableOrTakeAway','orderId','itemCount','amount']];
      for(const e of Object.values(pack.entries||{})){
        const type = e.tableOrTakeAway==='Mang v·ªÅ' ? 'takeaway' : 'table';
        const table = e.tableOrTakeAway==='Mang v·ªÅ' ? '' : e.tableOrTakeAway.replace('B√†n ','');
        const itemCount = (e.items||[]).reduce((s,x)=>s+(x.qty||1),0);
        rows.push([e.paidAt, type, table||'Mang v·ªÅ', e.orderId, itemCount, e.amount]);
      }
      const csv = rows.map(r=> r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`revenue_${new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}).replaceAll('-','')}.csv`; a.click();
    }
function scrollToCart(){
  document.getElementById('cartSection')?.scrollIntoView({behavior:'smooth', block:'start'});
}
function scrollToMenuTop(){
  document.getElementById('menuTop')?.scrollIntoView({behavior:'smooth', block:'start'});
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('btnJumpCart')?.addEventListener('click', scrollToCart);
  document.getElementById('btnJumpTop')?.addEventListener('click', scrollToMenuTop);
});
document.getElementById('btnJumpCartHeader')?.addEventListener('click', scrollToCart);


    /* ========== Events + Boot ========== */
    function setRole(r){ role=r; sessionStorage.setItem('tn_role', r); refreshAll(); }
    els.roleSelect.addEventListener('change', e=>setRole(e.target.value));
    els.btnResetData.addEventListener('click', async ()=>{ if(confirm('Xo√° to√†n b·ªô ƒë∆°n h√¥m nay?')){ await DB.resetToday(); bc?.postMessage({type:'revenue-updated'}); refreshAll(); }});
    // ========== Clear Search Button ==========
const clearBtn = document.getElementById('clearSearchBtn');
els.searchInput.addEventListener('input', ()=>{
  // Hi·ªán n√∫t ‚ùå khi c√≥ text
  clearBtn.classList.toggle('hidden', !els.searchInput.value.trim());
  renderStaff();
});

clearBtn.addEventListener('click', ()=>{
  els.searchInput.value = '';
  clearBtn.classList.add('hidden');
  renderStaff();
});

// Khi b·∫•m ƒë·ªïi ph√¢n lo·∫°i ho·∫∑c quick filter th√¨ xo√° t√¨m ki·∫øm
els.catFilter.addEventListener('change', ()=>{
  els.catFilter.dataset.key = els.catFilter.value || '__all__';

  // clear t√¨m ki·∫øm khi ƒë·ªïi category
  els.searchInput.value = '';
  document.getElementById('clearSearchBtn')?.classList.add('hidden');

  // style cam cho category
  const on = ['border-orange-400','text-orange-700','bg-orange-50','focus:ring-2','focus:ring-orange-300'];
  const off= ['border-gray-300','text-gray-700','bg-white','focus:ring-0'];
  els.catFilter.classList.remove(...on,...off);
  els.catFilter.classList.add(...on);

  renderStaff();
  updateQuickFiltersUI();
  tintDropdowns();
});


document.querySelectorAll('.qf').forEach(b=>{
  b.addEventListener('click', ()=>{
    // reset t√¨m ki·∫øm tr∆∞·ªõc
    els.searchInput.value = '';
    document.getElementById('clearSearchBtn')?.classList.add('hidden');

    const label = norm(b.textContent);
    const labelKey = normKey(label);

    // === QUICK FILTER: M√≥n m·ªõi ===
    // ∆Øu ti√™n map v√†o Category n·∫øu c√≥ option t√™n "M√≥n m·ªõi".
    // N·∫øu CSV kh√¥ng c√≥ category n√†y, fallback: l·ªçc theo t·ª´ kh√≥a "m·ªõi" ho·∫∑c "new".
    if (labelKey.includes('m·ªõi') || labelKey.includes('mon moi') || labelKey.includes('new')) {
      const optNew = Array.from(els.catFilter.options)
        .find(o => normKey(o.textContent).includes('m·ªõi') || normKey(o.textContent).includes('new'));
      if (optNew) {
        els.catFilter.value = optNew.value;
        els.catFilter.dataset.key = els.catFilter.value;
      } else {
        // fallback: ƒë·ªÉ category = t·∫•t c·∫£ v√† t√¨m theo t·ª´ kh√≥a
        els.catFilter.value = '__all__';
        els.catFilter.dataset.key = '__all__';
        els.searchInput.value = 'm·ªõi';
      }
    } else {
      // c√°c quick filter th∆∞·ªùng: map v√†o category theo label
      const opt = Array.from(els.catFilter.options).find(o=>norm(o.textContent)===label);
      els.catFilter.value = opt ? opt.value : '__all__';
      els.catFilter.dataset.key = els.catFilter.value;
    }

    renderStaff();
    updateQuickFiltersUI();
    tintDropdowns();
  });
});


    els.tableSelect.addEventListener('change', ()=>{ updateCartTitle(); tintDropdowns();updateCartButtonBadge();  });
	els.btnSubmitOrder.addEventListener('click', async ()=>{
	  if(!cart.length) return alert('Gi·ªè h√†ng tr·ªëng');
	  const sel = els.tableSelect.value;
	  const order = {
	    id:newId('ord'),
	    type: sel==='takeaway'?'takeaway':'table',
	    table: sel==='takeaway'?null:Number(sel),
	    items: JSON.parse(JSON.stringify(cart)),
	    status:'queued',
	    createdAt: now(),
	    timeline:[{t:'queued', at: now()}]
	  };
	  await DB.push(order);
	  cart = [];
	  renderCart();
	  renderMyOrders();
	
	  // Reset to√†n b·ªô card menu v·ªÅ m·∫∑c ƒë·ªãnh
	  resetAllMenuCards();
	
	});

    els.tabByTable.addEventListener('click', ()=>{ baristaTab='table'; renderBarista(); });
    els.tabByItem.addEventListener('click', ()=>{ baristaTab='item'; renderBarista(); });
    [els.btnClosePay, els.btnCancelPay].forEach(b=>b.addEventListener('click', closePay));
    els.btnConfirmPay.addEventListener('click', confirmPay);
    els.btnSaveAdmin.addEventListener('click', ()=>{ const newTables = Math.max(1, Number(els.tablesInput.value)||cfg.tables); cfg.tables = newTables; saveCfg(); refreshAll(); });
    els.dlRevenueBtn.addEventListener('click', downloadRevenueCSV);

    // Dev Panel events
    (()=>{
      const pickBtn = document.getElementById('btnPickCSV');
      const picker  = document.getElementById('csvPicker');
      const seedBtn = document.getElementById('btnSeedSample');
      const hideBtn = document.getElementById('btnHideDev');
      if(pickBtn && picker){ pickBtn.addEventListener('click', ()=> picker.click()); picker.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; await importCSVFromFile(f); showDevPanel(false); }); }
      if(seedBtn){ seedBtn.addEventListener('click', async ()=>{ await seedSampleOrders(); refreshAll(); }); }
      if(hideBtn){ hideBtn.addEventListener('click', ()=> showDevPanel(false)); }
    })();

    async function seedSampleOrders(){
      const items = Object.keys(menuIndex);
      if(items.length===0){ alert('Ch∆∞a c√≥ menu ƒë·ªÉ seed. H√£y n·∫°p CSV tr∆∞·ªõc.'); return; }
      const pick = (n)=>{ const a=[...items]; a.sort(()=>Math.random()-0.5); return a.slice(0,n).map(name=>{ const info=menuIndex[name]; const s=info.sizes[0]||{size:'M',price:0}; return { name, size:s.size||'M', basePrice:s.price||0, qty:1, toppings:[], note:'', itemStatus:'queued', menuItemId:newId('mi') }; }); };
      const o1 = { id:newId('ord'), type:'table', table:1, items: pick(3), status:'queued', createdAt: now()-600000, timeline:[{t:'queued',at:now()-600000}] };
      const o2 = { id:newId('ord'), type:'table', table:2, items: pick(3), status:'queued', createdAt: now()-540000, timeline:[{t:'queued',at:now()-540000}] };
      const o3 = { id:newId('ord'), type:'table', table:1, items: pick(1), status:'queued', createdAt: now()-480000, timeline:[{t:'queued',at:now()-480000}] };
      const o4 = { id:newId('ord'), type:'takeaway', table:null, items: pick(2), status:'queued', createdAt: now()-420000, timeline:[{t:'queued',at:now()-420000}] };
      await DB.push(o1); await DB.push(o2); await DB.push(o3); await DB.push(o4);
    }

    async function refreshAll(){
      renderRole();
      if(role==='staff'){ renderStaff(); }
      if(role==='barista'){ await renderBarista(); }
      if(role==='cashier'){ await renderCashier(); }
      if(role==='admin'){ els.tablesInput.value = cfg.tables; renderCashier(); }
    }

    (async function init(){
      els.tablesInput.value = cfg.tables;
      await loadMenuCSV();
      await refreshAll();
	  tintDropdowns();
	  updateCartTitle();

    })();
  </script>

  <!-- === FIREBASE (optional) === -->
  <script type="module">
    // Mu·ªën d√πng cloud realtime th√¨ set c·∫•u h√¨nh t·∫°i ƒë√¢y:
    // window.FIREBASE_CONFIG = { ... };

    if(window.FIREBASE_CONFIG){
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
      import { getDatabase, ref, onValue, push, set, update, get } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js';
      import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';

      const firebaseApi = {
        app:null, db:null, auth:null, user:null, ready:false,
        async init(){
          this.app = initializeApp(window.FIREBASE_CONFIG);
          this.db = getDatabase(this.app);
          this.auth = getAuth(this.app);
          await signInAnonymously(this.auth);
          this.ready = true;
        },
        ordersPath(){ const d=new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}); return `orders/${d}`; },
        async listOrders(){ const snap = await get(ref(this.db, this.ordersPath())); const val=snap.val()||{}; return Object.values(val).sort((a,b)=>a.createdAt-b.createdAt); },
        async pushOrder(order){
          if(!this.ready) return false;
          const r = push(ref(this.db, this.ordersPath()));
          await set(r, { ...order, id: r.key });
          try{ window.notifyNewOrder?.(order); }catch{}
          return true;
        },
        async setItemStatus(orderId, idx, status){
          if(!this.ready) return false;
          const orderRef = ref(this.db, this.ordersPath()+`/${orderId}`);
          const snap = await get(orderRef);
          if(!snap.exists()) return false;
          const o = snap.val();
          o.items[idx].itemStatus = status;
          if(o.items.every(x=>x.itemStatus==='delivered')) o.status='delivered';
          await set(orderRef, o);
          return true;
        },
        async markPaidGroup(group){
          if(!this.ready) return false;
          const snap = await get(ref(this.db, this.ordersPath()));
          const val = snap.val()||{};
          for(const [id,o] of Object.entries(val)){
            if(o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table))){
              o.status='paid';
              await set(ref(this.db, this.ordersPath()+`/${id}`), o);
            }
          }
          return true;
        },
        async resetToday(){ if(!this.ready) return false; await set(ref(this.db, this.ordersPath()), null); return true; }
      };

      await firebaseApi.init();
      window.firebaseApi = firebaseApi;
    }
  </script>
  <audio id="soundBell" src="assets/sound/bell.mp3" preload="auto"></audio>
<script>
(function forceDesktopLikeView(){
  const meta = document.querySelector('#metaViewport');
  function apply() {
    const w = Math.min(window.innerWidth || screen.width, screen.width || window.innerWidth);
    if (w < 1200) {
      // √âp layout theo desktop (gi·ªëng "Trang cho m√°y t√≠nh")
      meta.setAttribute('content', 'width=1280');
      document.documentElement.classList.add('force-desktop');
    } else {
      // Tr·∫£ v·ªÅ ch·∫ø ƒë·ªô b√¨nh th∆∞·ªùng
      meta.setAttribute('content', 'width=device-width, initial-scale=1.0');
      document.documentElement.classList.remove('force-desktop');
    }
  }
  window.addEventListener('resize', apply, {passive:true});
  window.addEventListener('orientationchange', apply);
  apply();
})();
</script>

</body>
</html>
