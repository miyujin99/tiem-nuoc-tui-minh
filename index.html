<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS + Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .modal-enter{opacity:0;transform:translateY(6px)}
    .modal-enter-active{opacity:1;transform:translateY(0);transition:all .15s ease}
    .toast-enter{opacity:0;transform:translateY(8px)}
    .toast-enter-active{opacity:1;transform:translateY(0);transition:all .2s ease}
    .badge{font-size:.72rem}
    .hide-scroll::-webkit-scrollbar{display:none}
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üßã</span>
        <div>
          <h1 class="text-lg font-bold">Ti·ªám N∆∞·ªõc T·ª•i M√¨nh ¬∑ POS</h1>
          <p class="text-xs text-gray-500">HTML + Tailwind ¬∑ Firebase/Local ¬∑ CSV menu</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <select id="roleSelect" class="border rounded-lg px-3 py-2 text-sm">
          <option value="staff">Nh√¢n vi√™n (G·ªçi m√≥n)</option>
          <option value="barista">Qu·∫ßy pha ch·∫ø</option>
          <option value="cashier">Thu ng√¢n</option>
          <option value="admin">Qu·∫£n l√Ω</option>
        </select>
        <button id="btnResetData" class="text-sm px-3 py-2 border rounded-lg">Reset ƒë∆°n</button>
      </div>
    </div>
  </header>

  <!-- Toasts + sound -->
  <div id="toastHost" class="fixed left-3 top-16 space-y-2 z-50"></div>
  <audio id="ping" preload="auto" class="hidden">
    <source src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQA‚Ä¶AAA" type="audio/mp3">
  </audio>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- STAFF -->
    <section id="view-staff" class="hidden">
      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2 space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-gray-900">Ch·ªçn b√†n & Menu</h2>
              <div class="flex items-center gap-3">
                <select id="tableSelect" class="border rounded-lg px-3 py-2 text-sm"></select>
                <select id="catFilter" class="border rounded-lg px-3 py-2 text-sm"></select>
                <input id="searchInput" class="border rounded-lg px-3 py-2 text-sm w-48" placeholder="T√¨m m√≥n..." />
              </div>
            </div>
            <div class="flex gap-2 mb-3">
              <button class="qf px-3 py-1 text-xs border rounded">C√† ph√™</button>
              <button class="qf px-3 py-1 text-xs border rounded">Matcha</button>
              <button class="qf px-3 py-1 text-xs border rounded">Tr√† s·ªØa & Tr√†</button>
              <button class="qf px-3 py-1 text-xs border rounded">ƒê·ªì ƒÉn v·∫∑t</button>
            </div>
            <div id="menuGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
          </section>
        </div>
        <div class="space-y-4">
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 id="cartTitle" class="text-xl font-semibold text-gray-900 mb-3">Gi·ªè h√†ng</h2>
            <div id="cartList" class="space-y-3 text-sm text-gray-700">Ch∆∞a c√≥ m√≥n.</div>
            <div class="pt-3 mt-2 border-t flex items-center justify-between">
              <span class="font-semibold">T·ªïng</span>
              <span id="cartTotal" class="font-bold">0‚Ç´</span>
            </div>
            <button id="btnSubmitOrder" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white rounded-xl py-2 mt-3">G·ª≠i order ƒë·∫øn qu·∫ßy pha ch·∫ø</button>
          </section>
          <section class="bg-white rounded-2xl shadow-sm border p-5">
            <h2 class="text-xl font-semibold text-gray-900 mb-3">C√°c ƒë∆°n c·ªßa t√¥i (ch∆∞a thanh to√°n)</h2>
            <div id="recentOrders" class="space-y-2 max-h-80 overflow-auto pr-1"></div>
          </section>
        </div>
      </div>
    </section>

    <!-- BARISTA -->
    <section id="view-barista" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">H√†ng ƒë·ª£i pha ch·∫ø</h2>
          <div class="flex items-center gap-2 text-sm">
            <button id="tabByTable" class="px-3 py-1 rounded-lg border bg-black text-white">Xem theo b√†n</button>
            <button id="tabByItem" class="px-3 py-1 rounded-lg border">Xem theo m√≥n</button>
          </div>
        </div>
        <div id="baristaByTable" class="grid md:grid-cols-2 gap-4"></div>
        <div id="baristaByItem" class="grid md:grid-cols-3 gap-4 hidden"></div>
      </section>
    </section>

    <!-- CASHIER -->
    <section id="view-cashier" class="hidden space-y-4">
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ch·ªù thanh to√°n</h2>
        <div id="cashierNotPaid" class="space-y-3"></div>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <div class="flex items-center justify-between mb-2">
          <h2 class="text-xl font-semibold text-gray-900">ƒê√£ thanh to√°n h√¥m nay</h2>
          <div class="flex items-center gap-2">
            <span id="cashierTotalToday" class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700"></span>
            <button id="dlRevenueBtn" class="text-xs px-2 py-1 rounded border">T·∫£i CSV</button>
          </div>
        </div>
        <div class="overflow-auto mt-2 hide-scroll" style="max-height:340px">
          <table class="w-full text-xs">
            <thead class="sticky top-0 bg-gray-100"><tr>
              <th class="text-left p-1">Th·ªùi gian</th>
              <th class="text-left p-1">Lo·∫°i</th>
              <th class="text-left p-1">M√£ ƒë∆°n</th>
              <th class="text-right p-1">S·ªë m√≥n</th>
              <th class="text-right p-1">T·ªïng</th>
              <th class="text-left p-1">Ghi ch√∫</th>
            </tr></thead>
            <tbody id="revenueTable"></tbody>
          </table>
        </div>
      </section>
    </section>

    <!-- ADMIN + DASHBOARD -->
    <section id="view-admin" class="hidden grid md:grid-cols-2 gap-6">
      <!-- Dashboard -->
      <section class="bg-white rounded-2xl shadow-sm border p-5 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-semibold text-gray-900">Dashboard (Realtime)</h2>
          <span class="text-xs text-gray-500">T·ª± c·∫≠p nh·∫≠t</span>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">T·ªïng ƒë∆°n h√¥m nay</p>
            <p id="kpiOrders" class="text-3xl font-bold">‚Äî</p>
          </div>
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">Dung l∆∞·ª£ng local ∆∞·ªõc t√≠nh</p>
            <p class="text-lg font-semibold"><span id="kpiStorage">‚Äî</span></p>
          </div>
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">Thi·∫øt b·ªã online</p>
            <p id="kpiOnline" class="text-3xl font-bold">‚Äî</p>
          </div>
          <div class="border rounded-xl p-4">
            <p class="text-sm text-gray-500">Ch·∫ø ƒë·ªô ƒë·ªìng b·ªô</p>
            <p id="kpiBandwidth" class="text-lg font-semibold">Local only</p>
          </div>
        </div>
      </section>

      <!-- Config -->
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">C·∫•u h√¨nh qu√°n</h2>
        <label class="text-sm text-gray-700">S·ªë l∆∞·ª£ng b√†n</label>
        <input id="tablesInput" type="number" min="1" class="border rounded-lg px-3 py-2 w-40" />
        <div class="mt-3">
          <button id="btnSaveAdmin" class="px-4 py-2 rounded-lg bg-black text-white">L∆∞u</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Menu l·∫•y t·ª´ <code>assets/menu.csv</code>. Kh√¥ng d√πng JSON.</p>
      </section>
      <section class="bg-white rounded-2xl shadow-sm border p-5">
        <h2 class="text-xl font-semibold text-gray-900 mb-3">Ghi ch√∫</h2>
        <p class="text-sm text-gray-600">‚Ä¢ Topping l·∫•y t·ª´ d√≤ng CSV c√≥ <strong>Category = Topping</strong>.<br/>‚Ä¢ ƒê∆°n = <em>delivered</em> khi m·ªçi <em>item</em> ƒë·ªÅu delivered.</p>
      </section>
    </section>
  </main>

  <!-- Pay Modal -->
  <div id="payModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 p-4">
    <div class="bg-white rounded-2xl w-full max-w-lg p-5 modal-enter">
      <div class="flex items-center justify-between mb-2">
        <h3 id="payTitle" class="text-lg font-semibold">Thanh to√°n</h3>
        <button id="btnClosePay" class="text-gray-500 hover:text-gray-700">‚úï</button>
      </div>
      <div id="payLines" class="space-y-2"></div>
      <div class="pt-2 mt-2 border-t flex items-center justify-between">
        <span class="font-semibold">T·ªïng</span>
        <span id="payTotal" class="font-bold">0‚Ç´</span>
      </div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="btnCancelPay" class="px-4 py-2 rounded-lg border">ƒê√≥ng</button>
        <button id="btnConfirmPay" class="px-4 py-2 rounded-lg bg-emerald-600 text-white">X√°c nh·∫≠n thanh to√°n</button>
      </div>
    </div>
  </div>

  <script>
    /********* Utils *********/
    const STORAGE_KEY_CFG = 'tiemnuoctuiminh_pos_v1_html';
    const ORDERS_KEY = () => 'tnm_orders_'+new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'});
    const REVENUE_KEY = () => 'tnm_revenue_'+new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}).replaceAll('-','');

    const money = n => (n||0).toLocaleString('vi-VN')+'‚Ç´';
    const now = () => Date.now();
    const newId = p => p+'_'+Math.random().toString(36).slice(2)+Date.now().toString(36);
    const shortId = id => id ? id.slice(-6) : '';
    const fmtTime = ts => { try{ return new Date(ts).toLocaleTimeString('vi-VN',{hour:'2-digit',minute:'2-digit'}); } catch{ return ''; } };
    const fmtISO = () => new Date().toLocaleString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}).replace('T',' ');

    // toast + beep
    const toastHost = document.getElementById('toastHost');
    let toastQ=[], toastRun=false;
    const ping = ()=>{ try{ const a=document.getElementById('ping'); a.currentTime=0; a.play(); }catch{} };
    function toast(msg){ toastQ.push(msg); if(!toastRun) nextToast(); }
    function nextToast(){
      if(!toastQ.length){ toastRun=false; return; }
      toastRun=true;
      const msg = toastQ.shift();
      const el = document.createElement('div');
      el.className='toast-enter bg-white border shadow rounded-lg px-3 py-2 text-sm max-w-xs';
      el.innerHTML = `<div class="flex items-start gap-2"><span>üîî</span><div class="flex-1">${msg}</div><button class="text-gray-400 hover:text-gray-700" onclick="this.parentElement.parentElement.remove()">√ó</button></div>`;
      toastHost.appendChild(el);
      requestAnimationFrame(()=>el.classList.add('toast-enter-active'));
      setTimeout(()=>{ el.remove(); nextToast(); }, 3000);
    }

    /********* State *********/
    const els = {
      roleSelect: document.getElementById('roleSelect'),
      btnResetData: document.getElementById('btnResetData'),
      views: {
        staff: document.getElementById('view-staff'),
        barista: document.getElementById('view-barista'),
        cashier: document.getElementById('view-cashier'),
        admin: document.getElementById('view-admin'),
      },
      tableSelect: document.getElementById('tableSelect'),
      catFilter: document.getElementById('catFilter'),
      searchInput: document.getElementById('searchInput'),
      menuGrid: document.getElementById('menuGrid'),
      cartTitle: document.getElementById('cartTitle'),
      cartList: document.getElementById('cartList'),
      cartTotal: document.getElementById('cartTotal'),
      btnSubmitOrder: document.getElementById('btnSubmitOrder'),
      recentOrders: document.getElementById('recentOrders'),
      tabByTable: document.getElementById('tabByTable'),
      tabByItem: document.getElementById('tabByItem'),
      baristaByTable: document.getElementById('baristaByTable'),
      baristaByItem: document.getElementById('baristaByItem'),
      cashierNotPaid: document.getElementById('cashierNotPaid'),
      cashierPaid: document.getElementById('cashierPaid'),
      cashierTotalToday: document.getElementById('cashierTotalToday'),
      tablesInput: document.getElementById('tablesInput'),
      btnSaveAdmin: document.getElementById('btnSaveAdmin'),
      revenueTable: document.getElementById('revenueTable'),
      dlRevenueBtn: document.getElementById('dlRevenueBtn'),
      // modal
      payModal: document.getElementById('payModal'),
      payTitle: document.getElementById('payTitle'),
      payLines: document.getElementById('payLines'),
      payTotal: document.getElementById('payTotal'),
      btnClosePay: document.getElementById('btnClosePay'),
      btnCancelPay: document.getElementById('btnCancelPay'),
      btnConfirmPay: document.getElementById('btnConfirmPay'),
      // KPI
      kpiOrders: document.getElementById('kpiOrders'),
      kpiStorage: document.getElementById('kpiStorage'),
      kpiOnline: document.getElementById('kpiOnline'),
      kpiBandwidth: document.getElementById('kpiBandwidth'),
    };

    // session role
    const ROLES = ['staff','barista','cashier','admin'];
    let role = (sessionStorage.getItem('tn_role')||'staff');
    const qsRole = new URLSearchParams(location.search).get('role');
    const hashRole = location.hash.replace(/^#role=/,'');
    [qsRole,hashRole].some(v=>{ if(ROLES.includes(String(v))) { role=String(v); return true; } return false; });

    let cfg = loadCfg();
    let menuRows = [];           // [{category,item,size,price}]
    let menuIndex = {};          // name -> {category, sizes:[{size, price}]}
    let toppings = [];           // [{name, price}]
    let cart = [];               // [{menuItemId,name,size,basePrice,qty,toppings[],note,itemStatus}]
    let baristaTab = 'table';
    let viewingGroup = null;     // {type, table}
    let viewingOrderId = null;

    const bc = ('BroadcastChannel' in window) ? new BroadcastChannel('tnm_pos') : null;
    if(bc){ bc.addEventListener('message', e=>{ if(e?.data?.type==='orders-updated'){ refreshAll(); } if(e?.data?.type==='revenue-updated'){ loadRevenueUI(); } }); }

    function loadCfg(){
      try{
        const raw = JSON.parse(localStorage.getItem(STORAGE_KEY_CFG) || '{}');
        return { tables: raw.tables || 20, mode: raw.mode || 'local' };
      }catch{ return { tables:20, mode:'local' }; }
    }
    function saveCfg(){
      localStorage.setItem(STORAGE_KEY_CFG, JSON.stringify({ tables: cfg.tables, mode: cfg.mode }));
    }

    /********* DB Adapters *********/
    const DB = window.FIREBASE_CONFIG ? FirebaseAdapter() : LocalAdapter();

    function LocalAdapter(){
      function _load(){ return JSON.parse(localStorage.getItem(ORDERS_KEY()) || '[]'); }
      function _save(arr){ localStorage.setItem(ORDERS_KEY(), JSON.stringify(arr)); bc?.postMessage({type:'orders-updated'}); }
      return {
        async list(){ return _load(); },
        async push(order){ const arr=_load(); arr.push(order); _save(arr); toast(`C√≥ ƒë∆°n m·ªõi: ${order.type==='takeaway'?'Mang v·ªÅ':'B√†n '+order.table} ¬∑ ${order.items.length} m√≥n`); ping(); return true; },
        async setItemStatus(orderId, itemIdx, status){
          const arr=_load(); const i=arr.findIndex(o=>o.id===orderId); if(i<0) return false;
          arr[i].items[itemIdx].itemStatus=status;
          if(arr[i].items.every(x=>x.itemStatus==='delivered')) arr[i].status='delivered';
          _save(arr); return true;
        },
        async markPaidGroup(group){ const arr=_load(); let changed=false;
          for(const o of arr){
            if(o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table))){
              o.status='paid'; changed=true; Revenue.record(o);
            }
          }
          if(changed){ _save(arr); bc?.postMessage({type:'revenue-updated'}); }
          return changed;
        },
        async resetToday(){ localStorage.removeItem(ORDERS_KEY()); bc?.postMessage({type:'orders-updated'}); }
      };
    }

    function RevenueAdapterLocal(){
      return {
        record(order){
          const key = REVENUE_KEY();
          const pack = JSON.parse(localStorage.getItem(key) || '{"entries":{},"summary":{"totalOrders":0,"totalAmount":0}}');
          const amount = order.items.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
          pack.entries[order.id] = {
            orderId: order.id,
            tableOrTakeAway: order.type==='takeaway'?'Mang v·ªÅ':`B√†n ${order.table}`,
            items: order.items.map(i=>({name:i.name,size:i.size,qty:i.qty})),
            amount,
            paidAt: fmtISO()
          };
          const entries = Object.values(pack.entries);
          pack.summary = { totalOrders: entries.length, totalAmount: entries.reduce((s,e)=>s+(e.amount||0),0) };
          localStorage.setItem(key, JSON.stringify(pack));
        },
        load(){
          const key = REVENUE_KEY();
          return JSON.parse(localStorage.getItem(key) || '{"entries":{},"summary":{"totalOrders":0,"totalAmount":0}}');
        }
      };
    }
    const Revenue = RevenueAdapterLocal();

    function FirebaseAdapter(){
      // delegating to firebaseApi defined below (module script). Fallback to local until ready
      return {
        async list(){ return window.firebaseApi?.ready ? window.firebaseApi.listOrders() : LocalAdapter().list(); },
        async push(order){ if(window.firebaseApi?.ready) return window.firebaseApi.pushOrder(order); return LocalAdapter().push(order); },
        async setItemStatus(orderId, idx, status){ if(window.firebaseApi?.ready) return window.firebaseApi.setItemStatus(orderId, idx, status); return LocalAdapter().setItemStatus(orderId, idx, status); },
        async markPaidGroup(group){ if(window.firebaseApi?.ready) return window.firebaseApi.markPaidGroup(group); return LocalAdapter().markPaidGroup(group); },
        async resetToday(){ if(window.firebaseApi?.ready) return window.firebaseApi.resetToday(); return LocalAdapter().resetToday(); }
      }
    }

    /********* CSV Menu *********/
		async function loadMenuCSV(){
		  const cache = JSON.parse(localStorage.getItem('tnm_menu_csv_cache')||'null');
		  if(cache?.etag){ menuRows = cache.rows; buildMenuIndex(); return; }
		
		  const res = await fetch('assets/menu.csv?ts='+Date.now());
		  const raw = await res.text();
		  const lines = raw.split(/\r?\n/).filter(l=>norm(l).length>0);
		  if(!lines.length){ menuRows=[]; buildMenuIndex(); return; }
		
		  const head = lines[0];
		  const DELIM = ((head.match(/;/g)||[]).length > (head.match(/,/g)||[]).length) ? ';' : ',';
		  const splitCSV = (line, d)=>{
		    let out=[], cur='', q=false;
		    for(const ch of line){ if(ch==='\"'){ q=!q; continue; } if(ch===d && !q){ out.push(cur); cur=''; } else cur+=ch; }
		    out.push(cur); return out;
		  };
		
		  const headers = splitCSV(head, DELIM).map(c=>norm(c));
		  const hIdx = Object.fromEntries(headers.map((h,i)=>[normKey(h), i]));
		
		  const rows=[];
		  for(let i=1;i<lines.length;i++){
		    const cells = splitCSV(lines[i], DELIM);
		    const catId  = norm(cells[hIdx['categoryid'] ?? -1] ?? '');
		    const catLbl = norm(cells[hIdx['category']   ?? 0]  ?? '');
		    const item   = norm(cells[hIdx['item']       ?? 1]  ?? '');
		    const size   = norm(cells[hIdx['size']       ?? 2]  ?? '');
		    const priceRaw = norm(cells[hIdx['price']    ?? 3]  ?? '');
		    if(!(catLbl||catId) || !item) continue;
		
		    const num = Number(priceRaw.replace(/[^\d.,-]/g,'').replace(/\./g,'').replace(',', '.'));
		    const price = Number.isFinite(num) ? num : 0;
		
		    // catKey ∆∞u ti√™n CategoryID; kh√¥ng c√≥ th√¨ fallback v·ªÅ t√™n chu·∫©n h√≥a
		    const catKey = catId ? normKey(catId) : normKey(catLbl);
		
		    rows.push({
		      categoryId: catId || null,
		      category: catLbl || (catId||''),
		      item, size, price,
		      _key: catKey,        // kh√≥a l·ªçc ch√≠nh
		      _ck: normKey(catLbl) // kh√≥a t·ª´ nh√£n (ƒë·ªÉ t∆∞∆°ng th√≠ch)
		    });
		  }
		
		  menuRows = rows;
		  localStorage.setItem('tnm_menu_csv_cache', JSON.stringify({etag:Date.now(), rows}));
		  buildMenuIndex();
		}

		function buildMenuIndex(){
		  const idx = {};
		  const tops = [];
		  for(const r of menuRows){
		    const isTop = (r._key === 'topping' || r._ck === 'topping'); // ∆∞u ti√™n CategoryID
		    if(isTop){ tops.push({ name:r.item, price:r.price }); continue; }
		
		    if(!idx[r.item]) idx[r.item] = { category: r.category, _key: r._key, sizes: [] };
		    idx[r.item].sizes.push({ size: r.size, price: r.price });
		  }
		  menuIndex = idx;
		  toppings = tops;
		}


    /********* Renderers *********/
    function renderRole(){
      Object.values(els.views).forEach(v=>v.classList.add('hidden'));
      els.views[role].classList.remove('hidden');
      els.roleSelect.value = role;
    }

		function renderStaff(){
		  // B√†n/Mang v·ªÅ
		  els.tableSelect.innerHTML = `<option value="takeaway">Mang v·ªÅ</option>` +
		    Array.from({length: cfg.tables},(_,i)=>`<option value="${i+1}">B√†n ${i+1}</option>`).join('');
		  els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${els.tableSelect.value==='takeaway'?'Mang v·ªÅ':'B√†n '+els.tableSelect.value}`;
		
		  // Category map: key -> label (b·ªè 'topping')
		  const catMap = new Map();
		  for(const r of menuRows){
		    if(r._key && r._key!=='topping') catMap.set(r._key, r.category);
		  }
		
		  const prevKey = els.catFilter.dataset.key || '__all__';
		  els.catFilter.innerHTML = `<option value="__all__">T·∫•t c·∫£</option>` +
		    Array.from(catMap.entries()).map(([key,label])=>`<option value="${key}">${label}</option>`).join('');
		  els.catFilter.value = catMap.has(prevKey) ? prevKey : '__all__';
		  els.catFilter.dataset.key = els.catFilter.value;
		
		  const kw = norm(els.searchInput.value||'').toLowerCase();
		  const catKey = els.catFilter.value;
		
		  const items = Object.entries(menuIndex)
		    .filter(([name,info])=>{
		      const byCat = (catKey==='__all__') || (info._key === catKey);
		      const byKw  = !kw || norm(name).toLowerCase().includes(kw);
		      return byCat && byKw;
		    })
		    .map(([name,info])=>({name, ...info}));
		
		  els.menuGrid.innerHTML = items.map(it=>{
		    const sizeOpts = it.sizes.map(s=>`<option value="${s.size}|${s.price}">${s.size||'M·∫∑c ƒë·ªãnh'} ‚Äî ${money(s.price)}</option>`).join('');
		    const topOpts = toppings.length
		      ? toppings.map(t=>`<label class="flex items-center gap-2 text-xs">
		          <input type="checkbox" data-top="${t.name}|${t.price}" class="topping-cb">
		          <span>${t.name} <span class="text-gray-500">+${money(t.price)}</span></span>
		        </label>`).join('')
		      : '<p class="text-xs text-gray-400">Ch∆∞a c√≥ topping</p>';
		
		    return `<div class="border rounded-xl p-4 hover:shadow-sm flex flex-col gap-2">
		      <div class="flex items-start justify-between gap-3">
		        <div>
		          <h3 class="font-semibold text-gray-900">${it.name}</h3>
		          <p class="text-sm text-gray-500">${it.category}</p>
		        </div>
		      </div>
		      <select class="sizeSel w-full border rounded px-2 py-1">${sizeOpts}</select>
		      <textarea class="noteTxt w-full border rounded px-2 py-1 text-sm" rows="1" placeholder="Ghi ch√∫ (tu·ª≥ ch·ªçn)"></textarea>
		      <details class="rounded border p-2">
		        <summary class="text-xs cursor-pointer">Th√™m topping</summary>
		        <div class="mt-2 grid grid-cols-1 gap-1 max-h-28 overflow-auto">${topOpts}</div>
		      </details>
		      <div class="mt-2 flex items-center justify-between">
		        <div class="flex items-center gap-2">
		          <button class="qtyDec px-2 py-1 border rounded">-</button>
		          <span class="qtyVal w-6 text-center">1</span>
		          <button class="qtyInc px-2 py-1 border rounded">+</button>
		        </div>
		        <button class="addBtn px-3 py-1 rounded-lg bg-black text-white text-sm">Th√™m</button>
		      </div>
		    </div>`;
		  }).join('');
		
		  // bind th·∫ª m√≥n
		  Array.from(els.menuGrid.children).forEach(card=>{
		    const qtyVal = card.querySelector('.qtyVal');
		    card.querySelector('.qtyDec').onclick = ()=>{ const n=Math.max(1,(+qtyVal.textContent||1)-1); qtyVal.textContent=n; };
		    card.querySelector('.qtyInc').onclick = ()=>{ const n=(+qtyVal.textContent||1)+1; qtyVal.textContent=n; };
		    card.querySelector('.addBtn').onclick = ()=>{
		      const name = card.querySelector('.font-semibold').textContent.trim();
		      const [size, price] = (card.querySelector('.sizeSel').value||'').split('|');
		      const basePrice = Number(price||0);
		      const qty = Number(qtyVal.textContent)||1;
		      const note = card.querySelector('.noteTxt').value.trim();
		      const tops = Array.from(card.querySelectorAll('.topping-cb:checked')).map(cb=>{
		        const [tn,tp] = cb.dataset.top.split('|'); return { id:newId('tp'), name:tn, price:Number(tp||0) };
		      });
		      cart.push({ menuItemId:newId('mi'), name, size, basePrice, qty, toppings:tops, note, itemStatus:'queued' });
		      renderCart();
		    };
		  });
		
		  renderCart();
		  renderMyOrders();
		}

    function renderCart(){
      const list = els.cartList;
      if(!cart.length){ list.textContent='Ch∆∞a c√≥ m√≥n.'; els.cartTotal.textContent='0‚Ç´'; return; }
      list.innerHTML = cart.map((it,idx)=>{
        const tops = (it.toppings||[]).map(t=>`${t.name}(+${money(t.price)})`).join(', ');
        const sum = (it.basePrice + (it.toppings||[]).reduce((s,x)=>s+x.price,0))*it.qty;
        return `<div class="py-2 flex items-start gap-2 border-b last:border-0">
          <div class="flex-1">
            <div class="text-sm font-medium">${it.name} ‚Äî ${it.size} √ó ${it.qty}</div>
            <div class="text-xs text-gray-500">${tops || 'Kh√¥ng topping'}${it.note ? ' ¬∑ '+it.note : ''}</div>
          </div>
          <div class="text-right">
            <div class="text-sm font-semibold">${money(sum)}</div>
            <button data-rm="${idx}" class="text-xs text-red-600">X√≥a</button>
          </div>
        </div>`;
      }).join('');
      list.querySelectorAll('[data-rm]').forEach(b=> b.onclick=()=>{ cart.splice(Number(b.dataset.rm),1); renderCart(); });
      const total = cart.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
      els.cartTotal.textContent = money(total);
      els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${els.tableSelect.value==='takeaway'?'Mang v·ªÅ':'B√†n '+els.tableSelect.value}`;
    }

    async function submitOrder(){
      if(!cart.length) return alert('Gi·ªè h√†ng tr·ªëng');
      const sel = els.tableSelect.value;
      const order = {
        id: newId('ord'),
        type: sel==='takeaway' ? 'takeaway' : 'table',
        table: sel==='takeaway' ? null : Number(sel),
        items: JSON.parse(JSON.stringify(cart)),
        status: 'queued',
        createdAt: now(),
        timeline: [{t:'queued', at: now()}]
      };
      await DB.push(order);
      cart = [];
      renderCart();
      renderMyOrders();
      toast('ƒê√£ g·ª≠i order, chuy·ªÉn sang ‚ÄúC√°c ƒë∆°n c·ªßa t√¥i‚Äù.');
      document.getElementById('recentOrders').scrollIntoView({behavior:'smooth',block:'start'});
    }

    async function loadOrders(){ return await DB.list(); }

    async function renderMyOrders(){
      const orders = await loadOrders();
      const mine = orders.filter(o=>o.status!=='paid').slice().reverse();
      els.recentOrders.innerHTML = mine.map(o=>{
        const delivered = o.items.filter(i=>i.itemStatus==='delivered').length;
        const badge = o.type==='takeaway'
          ? `<span class="badge border bg-amber-100 text-amber-700 border-amber-300 px-2 py-0.5 rounded">Mang v·ªÅ</span>`
          : `<span class="badge border bg-blue-100 text-blue-700 border-blue-300 px-2 py-0.5 rounded">B√†n ${o.table}</span>`;
        return `<div class="flex items-center justify-between border rounded-lg p-3">
          <div>
            <p class="font-medium">#${shortId(o.id)}</p>
            <p class="text-xs text-gray-500">${delivered}/${o.items.length} m√≥n ƒë√£ giao</p>
          </div>
          <div class="flex items-center gap-2">${badge}</div>
        </div>`;
      }).join('') || '<p class="text-sm text-gray-500">‚Äî</p>';
    }

    function groupByKey(orders){
      const m=new Map();
      orders.forEach(o=>{
        const k = o.type==='takeaway' ? 'takeaway' : `table-${o.table}`;
        const arr = m.get(k)||[]; arr.push(o); m.set(k, arr);
      });
      for(const v of m.values()){ v.sort((a,b)=>a.createdAt-b.createdAt); v.forEach((o,i)=>o.__supp=i>0); }
      return m;
    }

// ===== Barista UI: gi·ªëng ·∫£nh demo, c√≥ s·ªë th·ª© t·ª± + nh√£n B·ªï sung =====
async function renderBarista(){
  // toggle tab style
  els.tabByTable.classList.toggle('bg-black', baristaTab==='table');
  els.tabByTable.classList.toggle('text-white', baristaTab==='table');
  els.tabByItem.classList.toggle('bg-black', baristaTab==='item');
  els.tabByItem.classList.toggle('text-white', baristaTab==='item');

  const ordersAll = await loadOrders();
  const active = ordersAll.filter(o => o.status !== 'paid');

  // T√≠nh th·ª© t·ª± h√†ng ƒë·ª£i theo th·ªùi gian t·∫°o (tƒÉng d·∫ßn)
  const queueSorted = active.slice().sort((a,b)=> a.createdAt - b.createdAt);
  const qpos = new Map(queueSorted.map((o,i)=> [o.id, i+1])); // id -> s·ªë th·ª© t·ª±

  // Nh√≥m theo b√†n / mang v·ªÅ + g·∫Øn "B·ªï sung"
  const grouped = new Map();
  active.forEach(o=>{
    const k = o.type==='takeaway' ? 'takeaway' : `table-${o.table}`;
    const arr = grouped.get(k) || [];
    arr.push(o); grouped.set(k, arr);
  });
  for(const [,arr] of grouped){
    arr.sort((a,b)=> a.createdAt - b.createdAt);
    arr.forEach((o,i)=> o.__supp = i>0); // true n·∫øu l√† ƒë∆°n b·ªï sung
  }

  // ===== BY TABLE =====
  const host = els.baristaByTable;
  host.innerHTML = '';
  if(grouped.size===0){
    host.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</p>';
  } else {
    // s·∫Øp x·∫øp theo s·ªë b√†n tƒÉng d·∫ßn, Mang v·ªÅ ƒë·ª©ng tr∆∞·ªõc
    const entries = Array.from(grouped.entries()).sort((a,b)=>{
      if(a[0]==='takeaway') return -1;
      if(b[0]==='takeaway') return 1;
      return Number(a[0].split('-')[1]) - Number(b[0].split('-')[1]);
    });

    entries.forEach(([key, orders])=>{
      const title = key==='takeaway' ? 'Mang v·ªÅ' : `B√†n ${key.split('-')[1]}`;
      const badgeRight = `<span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">${orders.length} ƒë∆°n</span>`;
      const priBadge = key==='takeaway'
        ? `<span class="badge border bg-amber-100 text-amber-700 border-amber-300 px-2 py-0.5 rounded">∆Øu ti√™n</span>`
        : '';

      const col = document.createElement('div');
      col.className = 'border rounded-xl p-4';
      col.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">${title}</h3>
          <div class="flex items-center gap-2">${priBadge}${badgeRight}</div>
        </div>
        <div class="space-y-3"></div>
      `;

      const list = col.querySelector('.space-y-3');
      orders.forEach(o=>{
        // danh s√°ch m√≥n (theo item-level)
        const itemsHtml = o.items.map((it,idx)=>{
          const tops = (it.toppings||[]).map(t=>t.name).join(', ');
          const statusTxt = it.itemStatus==='delivered' ? 'ƒê√£ giao' : 'Ch·ªù pha';
          const statusCls = it.itemStatus==='delivered' ? 'text-emerald-700' : 'text-gray-500';
          return `
            <li class="list-disc list-inside">
              ${it.name} √ó ${it.qty}
              <div class="text-xs text-gray-500 ml-5">${tops||'Kh√¥ng topping'}${it.note ? ' ¬∑ '+it.note : ''}</div>
              <div class="mt-1 ml-5 flex items-center justify-between">
                <span class="text-xs ${statusCls}">${statusTxt}</span>
                <button data-deliver="${o.id}|${idx}" class="text-xs px-3 py-1 rounded bg-emerald-600 text-white ${it.itemStatus==='delivered'?'opacity-40 pointer-events-none':''}">
                  ƒê√£ giao
                </button>
              </div>
            </li>`;
        }).join('');

        list.innerHTML += `
          <div class="rounded-lg border p-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="w-7 h-7 rounded-full bg-black text-white text-xs grid place-items-center font-semibold">
                  ${qpos.get(o.id) || ''}
                </span>
                <p class="text-sm text-gray-700">
                  #${o.id ? o.id.slice(-4) : ''} ¬∑ ${o.__supp ? 'B·ªï sung' : 'ƒê∆°n ƒë·∫ßu'} ¬∑ ${fmtTime(o.createdAt)}
                </p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full border bg-gray-50 text-gray-700">Ch·ªù pha</span>
            </div>
            <ul class="mt-2 text-sm">
              ${itemsHtml}
            </ul>
            <div class="mt-3">
              <button data-deliver-all="${o.id}" class="px-3 py-1 rounded-lg border">Giao h·∫øt</button>
            </div>
          </div>`;
      });

      host.appendChild(col);
    });
  }

  // g·∫Øn s·ª± ki·ªán one-click cho t·ª´ng m√≥n / giao h·∫øt
  host.querySelectorAll('[data-deliver]').forEach(btn=>{
    btn.onclick = async ()=>{
      const [oid, idx] = btn.dataset.deliver.split('|');
      await DB.setItemStatus(oid, Number(idx), 'delivered');
      refreshAll();
    };
  });
  host.querySelectorAll('[data-deliver-all]').forEach(btn=>{
    btn.onclick = async ()=>{
      const oid = btn.dataset.deliverAll;
      const orders = await loadOrders();
      const o = orders.find(x=>x.id===oid); if(!o) return;
      for(let i=0;i<o.items.length;i++){
        if(o.items[i].itemStatus !== 'delivered'){
          await DB.setItemStatus(oid, i, 'delivered');
        }
      }
      refreshAll();
    };
  });

  // ===== BY ITEM (t·ªïng m√≥n) =====
  const byItemHost = els.baristaByItem;
  const occurrences = [];
  active.forEach(o=>{
    o.items.forEach((it,idx)=>{
      occurrences.push({
        order:o, idx,
        name:it.name, qty:it.qty,
        status: it.itemStatus,
      });
    });
  });
  // theo th·ªùi gian + gom nh√≥m hi·ªÉn th·ªã nh∆∞ ·∫£nh
  occurrences.sort((a,b)=> a.order.createdAt - b.order.createdAt);

  // g·ªôp theo t√™n m√≥n ƒë·ªÉ v·∫Ω box
  const groups = new Map();
  occurrences.forEach(r=>{
    const g = groups.get(r.name) || { total:0, rows:[] };
    g.total += r.qty;
    g.rows.push(r);
    groups.set(r.name, g);
  });

  byItemHost.innerHTML = Array.from(groups.entries()).map(([name,g])=>{
    const rows = g.rows.map(r=>{
      const badge = r.order.type==='takeaway'
        ? `<span class="badge border bg-amber-100 text-amber-700 border-amber-300 px-2 py-0.5 rounded">Mang v·ªÅ</span>`
        : `<span class="badge border bg-blue-100 text-blue-700 border-blue-300 px-2 py-0.5 rounded">B√†n ${r.order.table}</span>`;
      return `
        <div class="flex items-center justify-between text-sm">
          <div class="flex items-center gap-2">
            <span class="w-6 h-6 rounded-full bg-black text-white grid place-items-center text-[10px]">
              ${qpos.get(r.order.id) || ''}
            </span>
            <span>
              ${r.order.type==='takeaway' ? 'Mang v·ªÅ' : `B√†n ${r.order.table}`} ¬∑ #${r.order.id.slice(-4)} ${r.order.__supp?'¬∑ B·ªï sung':''} ¬∑ ${fmtTime(r.order.createdAt)} ¬∑ √ó${r.qty}
            </span>
          </div>
          ${badge}
        </div>`;
    }).join('');

    return `
      <div class="border rounded-xl p-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="font-semibold">${name}</h4>
          <span class="text-sm font-bold">${g.total}</span>
        </div>
        <div class="space-y-1">${rows}</div>
      </div>`;
  }).join('') || '<p class="text-sm text-gray-500">Kh√¥ng c√≥ m√≥n.</p>';

  // toggle 2 tab
  els.baristaByTable.classList.toggle('hidden', baristaTab!=='table');
  els.baristaByItem.classList.toggle('hidden',  baristaTab!=='item');
}


    let cashierBound=false;
    async function renderCashier(){
      const orders = await loadOrders();
      const queuedOrPart = orders.filter(o=>o.status==='queued');
      const delivered = orders.filter(o=>o.status==='delivered');
      const paid = orders.filter(o=>o.status==='paid');

      // ch·ªù thanh to√°n: nh√≥m theo b√†n/takeaway
      const map = groupByKey(delivered);
      els.cashierNotPaid.innerHTML = '';
      for(const [key, arr] of map){
        const type = key==='takeaway'?'takeaway':'table';
        const title = key==='takeaway'?'Mang v·ªÅ':`B√†n ${key.split('-')[1]}`;
        const amount = arr.reduce((s,o)=> s + o.items.reduce((s2,it)=> s2+(it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty,0), 0);
        const wrap = document.createElement('div');
        wrap.className='border rounded-lg p-3 flex items-center justify-between';
        wrap.innerHTML = `<div>
          <p class="font-semibold">${title} ¬∑ ${arr.length} ƒë∆°n</p>
          <p class="text-xs text-gray-500">${arr.map(o=>`#${shortId(o.id)} (${fmtTime(o.createdAt)})`).join(' ¬∑ ')}</p>
        </div>
        <div class="flex items-center gap-3">
          <span class="font-bold">${money(amount)}</span>
          <button data-pay="${type}|${title.includes('B√†n')?Number(title.replace('B√†n ','')):''}" class="px-3 py-1 rounded-lg bg-emerald-600 text-white">Thanh to√°n ${title}</button>
        </div>`;
        els.cashierNotPaid.appendChild(wrap);
      }
      if(!map.size) els.cashierNotPaid.innerHTML = '<p class="text-sm text-gray-500">Kh√¥ng c√≥ ƒë∆°n.</p>';

      if(!cashierBound){
        els.cashierNotPaid.addEventListener('click',(e)=>{
          const btn=e.target.closest('[data-pay]'); if(!btn) return;
          const [type,tableStr]=btn.dataset.pay.split('|');
          openPayGroup({type, table: tableStr?Number(tableStr):null});
        });
        cashierBound=true;
      }

      // b·∫£ng doanh thu + KPI
      loadRevenueUI();

      // √¥ ‚Äúƒëang pha ch·∫ø‚Äù ch·ªâ ƒë·ªÉ tham chi·∫øu KPI t·ªïng ƒë∆°n
      els.kpiOrders.textContent = String(orders.length);
    }

    function loadRevenueUI(){
      const pack = Revenue.load();
      const entries = Object.values(pack.entries||{}).sort((a,b)=> a.paidAt.localeCompare(b.paidAt));
      els.revenueTable.innerHTML = entries.map(e=>{
        const itemCount = e.items.reduce((s,x)=>s+(x.qty||1),0);
        return `<tr>
          <td class="p-1">${e.paidAt}</td>
          <td class="p-1">${e.tableOrTakeAway}</td>
          <td class="p-1">#${shortId(e.orderId)}</td>
          <td class="p-1 text-right">${itemCount}</td>
          <td class="p-1 text-right">${money(e.amount)}</td>
          <td class="p-1"></td>
        </tr>`;
      }).join('');
      els.cashierTotalToday.textContent = `T·ªïng: ${money(pack.summary?.totalAmount||0)}`;

      // admin KPIs
      const bytes = new Blob([JSON.stringify(localStorage)]).size;
      els.kpiStorage.textContent = (bytes/1024).toFixed(1)+' KB';
      els.kpiOnline.textContent = '‚Äî'; // s·∫Ω c·∫≠p nh·∫≠t t·ª´ Firebase presence n·∫øu c√≥
      els.kpiBandwidth.textContent = window.FIREBASE_CONFIG ? 'Cloud sync' : 'Local only';
    }

    function openPayGroup(group){
      viewingGroup = group;
      DB.list().then(orders=>{
        const list = orders.filter(o=> o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table)))
                        .sort((a,b)=>a.createdAt-b.createdAt);
        if(!list.length){ alert('Kh√¥ng c√≥ ƒë∆°n ƒë·ªÉ thanh to√°n.'); return; }
        els.payTitle.textContent = `Thanh to√°n ¬∑ ${group.type==='takeaway'?'Mang v·ªÅ':'B√†n '+group.table} (${list.length} ƒë∆°n)`;
        els.payLines.innerHTML = list.map(o=>`
          <div class="border rounded-lg p-2">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">#${shortId(o.id)} ¬∑ ${fmtTime(o.createdAt)}</span>
            </div>
            <div class="mt-1 space-y-1 text-sm">
              ${o.items.map(it=>{
                const sub = (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty;
                return `<div class="flex items-center justify-between"><span>${it.name} ‚Äî ${it.size} √ó ${it.qty}</span><span class="font-medium">${money(sub)}</span></div>`;
              }).join('')}
            </div>
          </div>`).join('');
        const total = list.reduce((s,o)=> s + o.items.reduce((s2,it)=> s2+(it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty,0), 0);
        els.payTotal.textContent = money(total);
        els.payModal.classList.remove('hidden'); els.payModal.classList.add('flex');
        requestAnimationFrame(()=> els.payModal.querySelector('.modal-enter')?.classList.add('modal-enter-active'));
      });
    }
    function closePay(){ viewingGroup=null; els.payModal.classList.add('hidden'); els.payModal.classList.remove('flex'); els.payModal.querySelector('.modal-enter')?.classList.remove('modal-enter-active'); }

    async function confirmPay(){
      if(!viewingGroup) return;
      await DB.markPaidGroup(viewingGroup);
      closePay(); refreshAll(); toast('ƒê√£ ghi nh·∫≠n thanh to√°n.');
    }

    function downloadRevenueCSV(){
      const pack = Revenue.load();
      const rows = [['paidAt','type','tableOrTakeAway','orderId','itemCount','amount']];
      for(const e of Object.values(pack.entries||{})){
        const type = e.tableOrTakeAway==='Mang v·ªÅ' ? 'takeaway' : 'table';
        const table = e.tableOrTakeAway==='Mang v·ªÅ' ? '' : e.tableOrTakeAway.replace('B√†n ','');
        const itemCount = (e.items||[]).reduce((s,x)=>s+(x.qty||1),0);
        rows.push([e.paidAt, type, table||'Mang v·ªÅ', e.orderId, itemCount, e.amount]);
      }
      const csv = rows.map(r=> r.map(x=>String(x).replace(/"/g,'""')).map(x=>`"${x}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`revenue_${new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}).replaceAll('-','')}.csv`; a.click();
    }

    /********* Events + Boot *********/
    function setRole(r){ role=r; sessionStorage.setItem('tn_role', r); refreshAll(); }
    els.roleSelect.addEventListener('change', e=>setRole(e.target.value));
    els.btnResetData.addEventListener('click', async ()=>{
      if(confirm('Xo√° to√†n b·ªô ƒë∆°n h√¥m nay?')){ await DB.resetToday(); bc?.postMessage({type:'revenue-updated'}); refreshAll(); }
    });
    els.catFilter.addEventListener('change', renderStaff);
    els.searchInput.addEventListener('input', renderStaff);
    document.querySelectorAll('.qf').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const label = norm(btn.textContent);
    const opt = Array.from(els.catFilter.options).find(o=>norm(o.textContent)===label);
    els.catFilter.value = opt ? opt.value : '__all__';   // value = CategoryID
    els.catFilter.dataset.key = els.catFilter.value;
    renderStaff();
  });
});

    els.tableSelect.addEventListener('change', ()=>{ els.cartTitle.textContent = `Gi·ªè h√†ng ¬∑ ${els.tableSelect.value==='takeaway'?'Mang v·ªÅ':'B√†n '+els.tableSelect.value}`; });
    els.btnSubmitOrder.addEventListener('click', submitOrder);
    els.tabByTable.addEventListener('click', ()=>{ baristaTab='table'; renderBarista(); });
    els.tabByItem.addEventListener('click', ()=>{ baristaTab='item'; renderBarista(); });
    [els.btnClosePay, els.btnCancelPay].forEach(b=>b.addEventListener('click', closePay));
    els.btnConfirmPay.addEventListener('click', confirmPay);
    els.btnSaveAdmin.addEventListener('click', ()=>{
      const newTables = Math.max(1, Number(els.tablesInput.value)||cfg.tables);
      cfg.tables = newTables; saveCfg(); refreshAll(); toast('ƒê√£ l∆∞u c·∫•u h√¨nh.');
    });
    els.dlRevenueBtn.addEventListener('click', downloadRevenueCSV);

    async function refreshAll(){
      renderRole();
      if(role==='staff'){ renderStaff(); }
      if(role==='barista'){ await renderBarista(); }
      if(role==='cashier'){ await renderCashier(); }
      if(role==='admin'){ els.tablesInput.value = cfg.tables; loadRevenueUI(); }
    }

    (async function init(){
      // config
      els.tablesInput.value = cfg.tables;
      // menu
      await loadMenuCSV();
      // start
      await refreshAll();
      toast('S·∫µn s√†ng nh·∫≠n order.');
    })();
  </script>

  <!-- === FIREBASE (optional) === -->
  <script type="module">
    // N·∫øu mu·ªën cloud realtime: ƒëi·ªÅn c·∫•u h√¨nh t·∫°i ƒë√¢y, ho·∫∑c xo√° block n√†y ƒë·ªÉ ch·∫°y local ho√†n to√†n.
    // window.FIREBASE_CONFIG = { ... };

    if(window.FIREBASE_CONFIG){
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js';
      import { getDatabase, ref, onValue, push, set, update, get } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-database.js';
      import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js';

      const firebaseApi = {
        ready:false, app:null, db:null, auth:null,
        async init(){
          try{
            this.app = initializeApp(window.FIREBASE_CONFIG);
            this.db = getDatabase(this.app);
            this.auth = getAuth(this.app);
            await signInAnonymously(this.auth);
            this.ready = true;
          }catch(e){ console.error('Firebase init error', e); this.ready=false; }
        },
        ordersPath(){ const d=new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}); return `orders/${d}`; },
        revenuePath(){ const d=new Date().toLocaleDateString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'}); return `revenue/${d}`; },

        async listOrders(){
          if(!this.ready) return [];
          const snap = await get(ref(this.db,this.ordersPath()));
          const val = snap.val()||{};
          return Object.values(val).sort((a,b)=>a.createdAt-b.createdAt);
        },
        subscribeOrders(cb){
          if(!this.ready) return;
          onValue(ref(this.db,this.ordersPath()), (snap)=>{
            const val=snap.val()||{}; const arr=Object.values(val).sort((a,b)=>a.createdAt-b.createdAt);
            cb(arr);
          });
        },
        async pushOrder(order){
          if(!this.ready) return false;
          const r = push(ref(this.db,this.ordersPath()));
          await set(r,{...order,id:r.key});
          // toast + beep
          window.toast?.(`C√≥ ƒë∆°n m·ªõi: ${order.type==='takeaway'?'Mang v·ªÅ':'B√†n '+order.table} ¬∑ ${order.items.length} m√≥n`); try{ const a=document.getElementById('ping'); a.currentTime=0; a.play(); }catch{}
          return true;
        },
        async setItemStatus(orderId, idx, status){
          if(!this.ready) return false;
          // fetch current
          const snap = await get(ref(this.db,`${this.ordersPath()}/${orderId}`));
          if(!snap.exists()) return false;
          const o = snap.val();
          o.items[idx].itemStatus = status;
          if(o.items.every(it=>it.itemStatus==='delivered')) o.status='delivered';
          await set(ref(this.db,`${this.ordersPath()}/${orderId}`), o);
          return true;
        },
        async markPaidGroup(group){
          if(!this.ready) return false;
          const snap = await get(ref(this.db,this.ordersPath()));
          const val = snap.val()||{};
          let changed=false;
          for(const [id,o] of Object.entries(val)){
            if(o.status==='delivered' && ((group.type==='takeaway' && o.type==='takeaway') || (group.type==='table' && o.type==='table' && o.table===group.table))){
              o.status='paid'; changed=true;
              await set(ref(this.db,`${this.ordersPath()}/${id}`), o);
              // record revenue
              const amount = o.items.reduce((s,it)=> s + (it.basePrice + (it.toppings||[]).reduce((t,x)=>t+x.price,0))*it.qty, 0);
              await set(ref(this.db,`${this.revenuePath()}/entries/${id}`), {
                orderId: id,
                tableOrTakeAway: o.type==='takeaway'?'Mang v·ªÅ':`B√†n ${o.table}`,
                items: o.items.map(i=>({name:i.name,size:i.size,qty:i.qty})),
                amount,
                paidAt: new Date().toLocaleString('sv-SE',{timeZone:'Asia/Ho_Chi_Minh'})
              });
              // summary (simple accumulate)
              const sumSnap = await get(ref(this.db,`${this.revenuePath()}/summary`));
              const old = sumSnap.val()||{totalOrders:0,totalAmount:0};
              await update(ref(this.db,`${this.revenuePath()}/summary`), {
                totalOrders: (old.totalOrders||0)+1,
                totalAmount: (old.totalAmount||0)+amount
              });
            }
          }
          return changed;
        },
        async resetToday(){
          if(!this.ready) return false;
          await set(ref(this.db,this.ordersPath()), null);
          await set(ref(this.db,this.revenuePath()), null);
          return true;
        }
      };

      await firebaseApi.init();
      window.firebaseApi = firebaseApi;

      if(firebaseApi.ready){
        firebaseApi.subscribeOrders(orders=>{
          // keep local shadow for UI
          // (UI always calls DB.list for fresh data)
          document.getElementById('kpiOrders').textContent = String(orders.length);
        });
      }
    } else {
      // no Firebase config ‚Üí local only
    }
  </script>
</body>
</html>
